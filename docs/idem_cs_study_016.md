# ç¬¬16ç« ï¼šçµæœã®å†åˆ©ç”¨â‘¡ï¼ˆå‡¦ç†ä¸­ãƒ»å¤±æ•—ãƒ»ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®è¨­è¨ˆï¼‰ğŸŒ€âš ï¸
![ç¬¬16ç« ï¼šå‡¦ç†ä¸­/å¤±æ•—](./picture/idem_cs_study_016_inprogress_failed_states.png)


## 16.0 ã“ã®ç« ã®ã‚´ãƒ¼ãƒ«ğŸ¯

ã“ã®ç« ã§ã¯ã€**åŒã˜å†ªç­‰ã‚­ãƒ¼ï¼ˆIdempotency-Keyï¼‰** ãŒå†é€ã•ã‚ŒãŸã¨ãã«ã€

* âœ… ã¾ã å‡¦ç†ä¸­ãªã‚‰ã©ã†è¿”ã™ï¼Ÿ
* âŒ å¤±æ•—ã—ãŸçµæœã¯ã€ŒåŒã˜å¤±æ•—ã€ã‚’è¿”ã™ï¼Ÿãã‚Œã¨ã‚‚ã€Œã‚„ã‚Šç›´ã—ã€ã•ã›ã‚‹ï¼Ÿ
* â³ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã§çµæœãŒåˆ†ã‹ã‚‰ãªã„ã¨ãã€ã©ã†å®‰å…¨ã«ã™ã‚‹ï¼Ÿ

â€¦ã“ã®â€œå®Ÿå‹™ã§æ‰ã‚ãŒã¡ãª3ç‚¹ã‚»ãƒƒãƒˆâ€ã‚’ã€è¿·ã‚ãšè¨­è¨ˆã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ğŸ˜Šâœ¨

---

## 16.1 ã¾ãšå¤§å‰æï¼šå†ªç­‰ã‚­ãƒ¼ã¯ã€ŒåŒã˜è©¦è¡Œã®ãƒã‚±ãƒƒãƒˆã€ğŸ«ğŸ”‘

å†ªç­‰ã‚­ãƒ¼ï¼ˆ`Idempotency-Key`ï¼‰ã¯ã€HTTP ã®éå†ªç­‰ã«ãªã‚ŠãŒã¡ãªæ“ä½œï¼ˆPOST/PATCHãªã©ï¼‰ã‚’â€œãƒªãƒˆãƒ©ã‚¤å®‰å…¨â€ã«ã™ã‚‹ãŸã‚ã®ä»•çµ„ã¿ã¨ã—ã¦åºƒãä½¿ã‚ã‚Œã¾ã™ã€‚ ([IETF Datatracker][1])

ã“ã“ã§å¤§äº‹ãªè€ƒãˆæ–¹ã¯ã“ã‚ŒğŸ‘‡

* **åŒã˜ã‚­ãƒ¼ = åŒã˜è©¦è¡Œï¼ˆåŒã˜æ³¨æ–‡ä½œæˆã®â€œ1å›åˆ†â€ï¼‰**
* **ã‚„ã‚Šç›´ã—ãŸã„ãªã‚‰ã€æ–°ã—ã„ã‚­ãƒ¼ = æ–°ã—ã„è©¦è¡Œ**

ã¤ã¾ã‚Šã€**åŒã˜ã‚­ãƒ¼ã§çµæœãŒå¤‰ã‚ã‚‹ã®ã¯åŸºæœ¬NG**ã§ã™ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒæ··ä¹±ã™ã‚‹ã—ã€äºŒé‡å®Ÿè¡Œã®æ¸©åºŠğŸ˜µâ€ğŸ’«ï¼‰ã€‚

---

## 16.2 çŠ¶æ…‹ã‚’3ã¤ã«åˆ†ã‘ã‚‹ã¨ä¸€æ°—ã«åˆ†ã‹ã‚Šã‚„ã™ã„ğŸ§ âœ¨

![idem cs study 016 traffic light states](./picture/idem_cs_study_016_traffic_light_states.png)


å†ªç­‰ã‚­ãƒ¼ã®ä¿å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆç¬¬12ç« ï¼‰ã«ã€æœ€ä½ã§ã‚‚ã“ã®çŠ¶æ…‹ã‚’æŒãŸã›ã¾ã™ğŸ‘‡

1. **InProgressï¼ˆå‡¦ç†ä¸­ï¼‰** ğŸŒ€
2. **Succeededï¼ˆæˆåŠŸï¼‰** âœ…
3. **Failedï¼ˆå¤±æ•—ï¼‰** âŒ

ãã—ã¦ã€åŒã˜ã‚­ãƒ¼ãŒæ¥ãŸã¨ãã®è¿”ã—æ–¹ã¯ã“ã†æ•´ç†ã§ãã¾ã™ğŸ‘‡

* âœ… æˆåŠŸ â†’ **å‰å›ã®æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãã®ã¾ã¾è¿”ã™**ï¼ˆç¬¬15ç« ã®ç¶šãï¼‰
* ğŸŒ€ å‡¦ç†ä¸­ â†’ **â€œå‡¦ç†ä¸­â€ã‚’è¿”ã™ï¼ˆor å¾…ã¤ï¼‰**
* âŒ å¤±æ•— â†’ **â€œå¤±æ•—ã‚‚å†åˆ©ç”¨ã™ã‚‹ã‹ï¼Ÿâ€ã‚’æ–¹é‡ã§æ±ºã‚ã‚‹**

```mermaid
stateDiagram-v2
    [*] --> InProgress: ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡
    InProgress --> Succeeded: å‡¦ç†æˆåŠŸ
    InProgress --> Failed: å‡¦ç†å¤±æ•—
    
    Succeeded --> Succeeded: åŒã˜ã‚­ãƒ¼ã§å†é€ (çµæœå†åˆ©ç”¨)
    Failed --> Failed: åŒã˜ã‚­ãƒ¼ã§å†é€ (æ–¹é‡ã«ã‚ˆã‚Šçµæœå†åˆ©ç”¨ or ...)
    InProgress --> InProgress: åŒã˜ã‚­ãƒ¼ã§å†é€ (202 Accepted or å¾…æ©Ÿ)
```

---

## 16.3 ã€Œå‡¦ç†ä¸­ï¼ˆInProgressï¼‰ã€ã‚’ã©ã†è¿”ã™ï¼Ÿ3ã¤ã®å®šç•ªãƒ‘ã‚¿ãƒ¼ãƒ³ğŸŒ€ğŸ“®

### ãƒ‘ã‚¿ãƒ¼ãƒ³Aï¼š2å›ç›®ä»¥é™ã¯â€œå¾…ã£ã¦â€åŒã˜æˆåŠŸã‚’è¿”ã™ï¼ˆåŒæœŸã§å¸åï¼‰â³

![idem cs study 016 blocking wait](./picture/idem_cs_study_016_blocking_wait.png)


**è€ƒãˆæ–¹**ï¼š
åŒã˜ã‚­ãƒ¼ã®2å›ç›®ãŒæ¥ãŸã‚‰ã€1å›ç›®ã®å‡¦ç†ãŒçµ‚ã‚ã‚‹ã¾ã§å¾…ã£ã¦ã€çµ‚ã‚ã£ãŸã‚‰åŒã˜ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ã€‚

**ãƒ¡ãƒªãƒƒãƒˆ**âœ…

* ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯æ¥½ï¼ˆæœ€çµ‚çµæœãŒè¿”ã£ã¦ãã‚‹ï¼‰
* 202ãªã©ã®â€œå‡¦ç†ä¸­ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¨­è¨ˆâ€ãŒä¸è¦

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**âš ï¸

* å¾…ã¡ãŒé•·ã„ã¨ã€ã‚µãƒ¼ãƒãƒ¼ã®åŒæ™‚å‡¦ç†æ ï¼ˆã‚¹ãƒ¬ãƒƒãƒ‰/æ¥ç¶šï¼‰ãŒè©°ã¾ã‚Šã‚„ã™ã„
* ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®è¨­å®šæ¬¡ç¬¬ã§æ³¥æ²¼ï¼ˆå¾…ã£ã¦ãŸã®ã«çµå±€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆğŸ˜‡ï¼‰

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³Bï¼š**202 Accepted + Retry-After** ã§ã€Œå‡¦ç†ä¸­ã€ã‚’è¿”ã™ï¼ˆãŠã™ã™ã‚ï¼‰ğŸŒ¸

![å‡¦ç†ä¸­ã®è¿”ã—æ–¹](./picture/idem_cs_study_016_accepted_retry_after.png)

HTTPã® `202 Accepted` ã¯ã€Œå—ã‘å–ã£ãŸã‘ã©ã€ã¾ã å®Œäº†ã—ã¦ãªã„ã‚ˆã€ã‚’è¡¨ã›ã¾ã™ã€‚ ([MDNã‚¦ã‚§ãƒ–ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][2])
ã•ã‚‰ã« `Retry-After` ãƒ˜ãƒƒãƒ€ãƒ¼ã§ã€Œæ¬¡ã¯ä½•ç§’å¾Œã«æ¥ã¦ã­ã€ã‚’ä¼ãˆã‚‰ã‚Œã¾ã™ã€‚ ([MDNã‚¦ã‚§ãƒ–ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][3])

**è¿”ã—æ–¹ï¼ˆä¾‹ï¼‰**ğŸ‘‡

* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼š`202 Accepted`
* ãƒ˜ãƒƒãƒ€ãƒ¼ï¼š`Retry-After: 2`
* ãƒœãƒ‡ã‚£ï¼šå‡¦ç†ä¸­ + ãƒãƒ¼ãƒªãƒ³ã‚°å…ˆURL

```json
{
  "status": "processing",
  "message": "ãŸã ã„ã¾å‡¦ç†ä¸­ã ã‚ˆğŸŒ€ å°‘ã—å¾…ã£ã¦åŒã˜ã‚­ãƒ¼ã§å†é€ã—ã¦ã­ğŸ™",
  "pollUrl": "/api/idempotency/9f0c8d7d-...."
}
```

```mermaid
sequenceDiagram
    participant C as ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    participant S as ã‚µãƒ¼ãƒãƒ¼
    
    C->>S: 1. POST /orders (Key=K1)
    S->>S: å‡¦ç†é–‹å§‹ (InProgress)
    S-->>C: 2. 202 Accepted (Retry-After: 2)
    
    Note over C: 2ç§’å¾…æ©Ÿ...
    
    C->>S: 3. POST /orders (Key=K1) â€»å†é€
    alt ã¾ã å‡¦ç†ä¸­ã®å ´åˆ
        S-->>C: 4a. 202 Accepted
    else å®Œäº†ã—ã¦ã„ã‚‹å ´åˆ
        S-->>C: 4b. 201 Created (å‰å›ã¨åŒã˜æˆåŠŸçµæœ)
    end
```

**ãƒ¡ãƒªãƒƒãƒˆ**âœ…

* ã‚µãƒ¼ãƒãƒ¼ãŒè©°ã¾ã‚Šã«ãã„ï¼ˆå¾…ãŸã›ãªã„ï¼‰
* â€œé•·ã„å‡¦ç†â€ã‚„â€œå¤–éƒ¨APIå¾…ã¡â€ã¨ç›¸æ€§â—
* ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­è¨ˆãŒç¶ºéº—ã«ãªã‚‹âœ¨

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**âš ï¸

* ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒâ€œå†å•ã„åˆã‚ã›ï¼ˆãƒãƒ¼ãƒªãƒ³ã‚°ï¼‰â€ã‚’å®Ÿè£…ã™ã‚‹å¿…è¦ã‚ã‚Š

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³Cï¼š409 Conflict ã§ã€Œä»Šãã‚Œå‡¦ç†ä¸­ï¼ã€ã‚’è¿”ã™ğŸ˜¤

`409 Conflict` ã¯ã€Œä»Šã®çŠ¶æ…‹ã¨è¡çªã—ã¦å‡¦ç†ã§ããªã„ã€ã‚’è¡¨ã—ã¾ã™ã€‚ ([MDNã‚¦ã‚§ãƒ–ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][4])
ãŸã ã€**â€œå‡¦ç†ä¸­â€ã¯è¡çªã¨ã„ã†ã‚ˆã‚ŠçŠ¶æ…‹é€šçŸ¥**ãªã®ã§ã€APIã®é›°å›²æ°—ã¨ã—ã¦ã¯ãƒ‘ã‚¿ãƒ¼ãƒ³Bã®æ–¹ãŒé¦´æŸ“ã¿ã‚„ã™ã„ã“ã¨ãŒå¤šã„ã§ã™ğŸŒ¸

ã¡ãªã¿ã«å®Ÿåœ¨ã‚µãƒ¼ãƒ“ã‚¹ã§ã‚‚ã€Œå‡¦ç†æ¸ˆã¿ or å‡¦ç†ä¸­ã€ã‚’ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã§è¿”ã™ä¾‹ãŒã‚ã‚Šã¾ã™ï¼ˆä¾‹ï¼šAdyenã®ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ 704ï¼‰ã€‚ ([docs.adyen.com][5])

---

## 16.4 ã€Œå¤±æ•—çµæœã€ã‚’å†åˆ©ç”¨ã™ã‚‹ï¼Ÿæ–¹é‡ã¯2æŠï¼‹ä¸­é–“æ¡ˆâŒğŸ”

### æ–¹é‡â‘ ï¼šå¤±æ•—ã‚‚å«ã‚ã¦â€œæœ€åˆã®çµæœã‚’ä¸¸ã”ã¨ä¿å­˜ã—ã¦å†ç”Ÿâ€ğŸ¥ï¼ˆå¼·ã„ï¼‰

ä¾‹ã¨ã—ã¦ Stripe ã¯ã€**æœ€åˆã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã¨ãƒœãƒ‡ã‚£ã‚’ã€æˆåŠŸ/å¤±æ•—ã«é–¢ä¿‚ãªãä¿å­˜ã—ã¦å†é€æ™‚ã«åŒã˜çµæœã‚’è¿”ã™**æ–¹é‡ã‚’æ˜è¨˜ã—ã¦ã„ã¾ã™ï¼ˆ`500` ã‚‚å«ã‚€ï¼‰ã€‚ ([Stripe ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][6])

**ãƒ¡ãƒªãƒƒãƒˆ**âœ…

* ã€ŒåŒã˜ã‚­ãƒ¼ = åŒã˜çµæœã€ãŒå¾¹åº•ã•ã‚Œã¦è¶…åˆ†ã‹ã‚Šã‚„ã™ã„
* ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚„é€šä¿¡åˆ‡ã‚Œã§ã‚‚äºŒé‡å®Ÿè¡Œã‚’èµ·ã“ã—ã«ãã„ï¼ˆå®‰å…¨å¯„ã‚Šï¼‰

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**âš ï¸

* ä¸€æ™‚çš„ãªéšœå®³ã§ `500` ã‚’è¸ã‚€ã¨ã€ãã®ã‚­ãƒ¼ã¯ãšã£ã¨ `500`ï¼ˆã‚­ãƒ¼ã‚’å¤‰ãˆãªã„é™ã‚Šï¼‰
* â€œåŒã˜æ³¨æ–‡ã‚’ã‚‚ã†ä¸€åº¦ã‚„ã‚ŠãŸã„â€å ´åˆã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒæ–°ã‚­ãƒ¼ã‚’å‡ºã™å¿…è¦ã‚ã‚Š

---

### æ–¹é‡â‘¡ï¼šæˆåŠŸã ã‘å†åˆ©ç”¨ã€‚å¤±æ•—ã¯â€œçŠ¶æ³ã«ã‚ˆã‚Šã‚„ã‚Šç›´ã—OKâ€ğŸ”

![idem cs study 016 failed policy](./picture/idem_cs_study_016_failed_policy.png)


**ã‚ˆãã‚ã‚‹ä¸­é–“ãƒ«ãƒ¼ãƒ«**ã¯ã“ã‚ŒğŸ‘‡

* **4xxï¼ˆå…¥åŠ›ãƒŸã‚¹/ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰**ï¼šå¤±æ•—ã‚’ä¿å­˜ã—ã¦å†åˆ©ç”¨ï¼ˆåŒã˜ãƒŸã‚¹ã‚’ç¹°ã‚Šè¿”ã—ã¦ã‚‚åŒã˜ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ï¼‰ğŸ“
* **5xxï¼ˆã‚µãƒ¼ãƒãƒ¼éšœå®³ï¼‰/ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**ï¼š

  * â€œå‡¦ç†ãŒæœ¬å½“ã«å¤±æ•—ã—ãŸâ€ã¨æ–­è¨€ã§ããªã„ãªã‚‰ã€**InProgressæ‰±ã„ã«ã—ã¦ 202**ï¼ˆâ†’ å¾Œã§ç¢ºå®šã•ã›ã‚‹ï¼‰ğŸŒ€
  * æ–­è¨€ã§ãã‚‹ãªã‚‰ Failed ã‚’ä¿å­˜ã—ã¦å†åˆ©ç”¨ï¼ˆãŸã ã—é‹ç”¨ã¯è¦æ³¨æ„ï¼‰âš ï¸

**ãƒã‚¤ãƒ³ãƒˆ**ğŸ’¡
5xxã‚„ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¯ã€**å®Ÿéš›ã«ã¯æˆåŠŸã—ã¦ã‚‹ã®ã«å¤±æ•—ã«è¦‹ãˆã‚‹**ã“ã¨ãŒã‚ã‚‹ã®ãŒæ€–ã„ã¨ã“ã‚ã§ã™ï¼ˆï¼äºŒé‡å®Ÿè¡Œã®åœ°é›·ï¼‰ğŸ’£

---

## 16.5 ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®â€œ3ç¨®é¡â€ã‚’åˆ‡ã‚Šåˆ†ã‘ã‚ˆã†â³ğŸ§ 

![idem cs study 016 timeout trio](./picture/idem_cs_study_016_timeout_trio.png)


### (1) ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒå…ˆã«å¾…ã¦ãªããªã£ãŸï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰ğŸ“±âŒ›

* ã‚µãƒ¼ãƒãƒ¼ã¯å‡¦ç†ã‚’ç¶šã‘ã¦ã„ã¦ã€**å®Ÿã¯æˆåŠŸã—ã¦ã‚‹**ã‹ã‚‚ã—ã‚Œãªã„
* ã ã‹ã‚‰ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ **åŒã˜ã‚­ãƒ¼ã§å†é€** ãŒæ­£è§£ğŸ”âœ…

### (2) é€”ä¸­ã§é€šä¿¡ãŒåˆ‡ã‚ŒãŸï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ–­ï¼‰ğŸ“¶ğŸ’¥

* ã“ã‚Œã‚‚çµæœãŒåˆ†ã‹ã‚‰ãªã„ä»£è¡¨
* åŒã˜ã‚­ãƒ¼ã§å†é€ã—ã¦ã€ã‚µãƒ¼ãƒãƒ¼å´ã§çµæœã‚’å†åˆ©ç”¨ã§ãã‚‹ã®ãŒç†æƒ³âœ¨

### (3) ã‚µãƒ¼ãƒãƒ¼å´ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ / ãƒªã‚½ãƒ¼ã‚¹ä¸è¶³ï¼ˆ503ãªã©ï¼‰ğŸ–¥ï¸ğŸ’¦

* `503 Service Unavailable` ã¯ã€Œä»Šå‡¦ç†ã§ããªã„ã€ç³»ã®ä»£è¡¨ã§ã™ ([MDNã‚¦ã‚§ãƒ–ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][7])
* ã“ã®å ´åˆã‚‚ `Retry-After` ãŒã‚»ãƒƒãƒˆã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ ([MDNã‚¦ã‚§ãƒ–ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][3])

---

## 16.6 å®Ÿè£…è¨­è¨ˆï¼šIdempotencyãƒ†ãƒ¼ãƒ–ãƒ«ã«â€œçŠ¶æ…‹ï¼‹ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¿å­˜â€ã‚’æŒãŸã›ã‚‹ğŸ—ƒï¸ğŸ›¡ï¸

### 16.6.1 è¿½åŠ ã™ã‚‹ã‚«ãƒ©ãƒ ï¼ˆæœ€å°æ§‹æˆï¼‰ğŸ§¾âœ¨

* `Key`ï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼‰
* `RequestHash`ï¼ˆåŒã˜ã‚­ãƒ¼ã§åˆ¥ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é˜²ãï¼‰
* `State`ï¼ˆInProgress / Succeeded / Failedï¼‰
* `ResponseStatusCode`
* `ResponseBody`
* `ResponseContentType`
* `CreatedAt`, `CompletedAt`

> âœ… **åŒã˜ã‚­ãƒ¼ + é•ã†ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**ã¯å±é™ºãªã®ã§ã€`RequestHash` ã§å¿…ãšå¼¾ãã¾ã™ï¼ˆä¸æ­£åˆ©ç”¨ã«ã‚‚å¼·ããªã‚‹ã‚ˆğŸ”’ï¼‰

---

### 16.6.2 ã€ŒåŒã˜ã‚­ãƒ¼ãªã®ã«å†…å®¹ãŒé•ã†ã€ã‚’ 409 ã§æ­¢ã‚ã‚‹ğŸš«

![idem cs study 016 conflict puzzle](./picture/idem_cs_study_016_conflict_puzzle.png)


`409 Conflict` ã¯â€œçŠ¶æ…‹ã®è¡çªâ€ã®è¡¨ç¾ã¨ã—ã¦ä½¿ã„ã‚„ã™ã„ã§ã™ã€‚ ([MDNã‚¦ã‚§ãƒ–ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][4])

```json
{
  "title": "Idempotency conflict",
  "status": 409,
  "detail": "åŒã˜Idempotency-KeyãŒã€åˆ¥ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã§ä½¿ã‚ã‚Œã¾ã—ãŸğŸ˜µâ€ğŸ’«"
}
```

---

## 16.7 ãƒãƒ³ã‚ºã‚ªãƒ³ï¼šå‡¦ç†ä¸­(202) â†’ å®Œäº†å¾Œã«åŒã˜çµæœã‚’è¿”ã™ğŸ§ªğŸ”

### ã‚¹ãƒ†ãƒƒãƒ—1ï¼šã‚ã–ã¨å‡¦ç†ã‚’é…ãã™ã‚‹ğŸ¢

ä¾‹ï¼šæ³¨æ–‡ç¢ºå®šã§ `Task.Delay(5000)` ã‚’å…¥ã‚Œã‚‹ï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰

### ã‚¹ãƒ†ãƒƒãƒ—2ï¼šåŒã˜ã‚­ãƒ¼ã§2å›å©ãğŸ”

Windowsã® `curl` ä¾‹ï¼ˆæ”¹è¡Œç¶™ç¶šã¯ `^` ï¼‰ğŸ‘‡

```bash
curl -i -X POST "http://localhost:5000/api/orders/confirm" ^
  -H "Content-Type: application/json" ^
  -H "Idempotency-Key: 9f0c8d7d-1111-2222-3333-444444444444" ^
  -d "{\"orderId\":123,\"amount\":5000}"
```

ã™ãåŒã˜ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚‚ã†ä¸€å›å®Ÿè¡ŒğŸ‘‰
ã™ã‚‹ã¨2å›ç›®ã¯ `202 Accepted` ãŒè¿”ã£ã¦ãã‚‹æƒ³å®šï¼ˆå‡¦ç†ä¸­ï¼‰ğŸŒ€

### ã‚¹ãƒ†ãƒƒãƒ—3ï¼šå°‘ã—å¾…ã£ã¦ã€åŒã˜ã‚­ãƒ¼ã§å†é€ğŸ”

* ã¾ã å‡¦ç†ä¸­ãªã‚‰ã¾ãŸ `202`
* çµ‚ã‚ã£ã¦ã„ã‚Œã° `200/201`ï¼ˆæˆåŠŸï¼‰ï¼‹**å‰å›ã¨åŒã˜ãƒœãƒ‡ã‚£**âœ…

---

## 16.8 ãƒŸãƒ‹æ¼”ç¿’ğŸ“âœ¨

### æ¼”ç¿’1ï¼šã‚ãªãŸã®APIã®ã€Œå‡¦ç†ä¸­ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã€ã‚’è¨­è¨ˆã—ã‚ˆã†ğŸŒ€

æ¬¡ã‚’æ±ºã‚ã¦ã­ğŸ‘‡

* å‡¦ç†ä¸­ã¯ `202`ï¼Ÿ `409`ï¼Ÿ ã©ã£ã¡ï¼Ÿ
* `Retry-After` ã¯ä½•ç§’ã«ã™ã‚‹ï¼Ÿ
* ãƒœãƒ‡ã‚£ã«ä½•ã‚’å…¥ã‚Œã‚‹ï¼Ÿï¼ˆstatus / pollUrl / message ãªã©ï¼‰

### æ¼”ç¿’2ï¼šå¤±æ•—çµæœã®å†åˆ©ç”¨ãƒãƒªã‚·ãƒ¼ã‚’1æšã«ã¾ã¨ã‚ã‚ˆã†âŒ

ãŠã™ã™ã‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆğŸ‘‡

* 4xxï¼šå†åˆ©ç”¨ã™ã‚‹ï¼Ÿï¼ˆã™ã‚‹/ã—ãªã„ï¼‰
* 5xxï¼šå†åˆ©ç”¨ã™ã‚‹ï¼Ÿï¼ˆã™ã‚‹/ã—ãªã„/å ´åˆã«ã‚ˆã‚‹ï¼‰
* ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼šInProgressã«å¯„ã›ã‚‹ï¼Ÿ Failedã«ã™ã‚‹ï¼Ÿï¼ˆç†ç”±ã‚‚ï¼ï¼‰

---

## 16.9 å°ãƒ†ã‚¹ãƒˆï¼ˆã‚µã‚¯ãƒƒã¨ï¼‰âœ…ğŸ’¡

1. åŒã˜å†ªç­‰ã‚­ãƒ¼ã§ã€**åˆ¥ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹**ãŒæ¥ãŸã€‚è¿”ã™ãªã‚‰ã©ã‚ŒãŒè‡ªç„¶ï¼Ÿ
   A. 200 OK / B. 202 Accepted / C. 409 Conflict / D. 500 Internal Server Error

2. `202 Accepted` ãŒè¡¨ã™æ„å‘³ã¨ã—ã¦æ­£ã—ã„ã®ã¯ï¼Ÿ ([MDNã‚¦ã‚§ãƒ–ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][2])
   A. å®Œäº†ã—ãŸ / B. å—ç†ã—ãŸãŒå®Œäº†ã—ã¦ã„ãªã„ / C. ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆ / D. ãƒªã‚½ãƒ¼ã‚¹ãŒä½œæˆã•ã‚ŒãŸ

3. `Retry-After` ã¯ä½•ã‚’ä¼ãˆã‚‹ãƒ˜ãƒƒãƒ€ãƒ¼ï¼Ÿ ([MDNã‚¦ã‚§ãƒ–ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][3])
   A. ä½•ç§’å¾Œã«ãƒªãƒˆãƒ©ã‚¤ã—ã¦ã­ / B. ã©ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ / C. æš—å·åŒ–æ–¹å¼ / D. ç½²åæƒ…å ±

---

## 16.10 AIæ´»ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé›†ğŸ¤–âœ¨ï¼ˆã‚³ãƒ”ãƒšOKï¼‰

* ã€Œå†ªç­‰ã‚­ãƒ¼æ–¹å¼ã§ã€å‡¦ç†ä¸­(InProgress)ã‚’è¿”ã™APIãƒ¬ã‚¹ãƒãƒ³ã‚¹æ¡ˆã‚’3ã¤ã€‚HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€Retry-Afterã€ãƒœãƒ‡ã‚£ä¾‹ã¤ãã§ã€
* ã€Œå¤±æ•—çµæœã‚’å†åˆ©ç”¨ã™ã‚‹/ã—ãªã„ã®åˆ¤æ–­åŸºæº–ã‚’ã€4xx/5xx/ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã§è¡¨ã«ã—ã¦ã€
* ã€Œâ€œã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ãŸã‘ã©ã‚µãƒ¼ãƒãƒ¼ã¯æˆåŠŸã—ã¦ãŸâ€ã‚’ã€å›³è§£ã£ã½ã„æ–‡ç« ã§èª¬æ˜ã—ã¦ã€
* ã€Œã“ã®APIã®çŠ¶æ…‹é·ç§»ï¼ˆNotFoundâ†’InProgressâ†’Succeeded/Failedï¼‰ã‚’ã€åˆå¿ƒè€…å‘ã‘ã«1æšã®èª¬æ˜ã«ã—ã¦ã€

[1]: https://datatracker.ietf.org/doc/html/draft-ietf-httpapi-idempotency-key-header-07?utm_source=chatgpt.com "draft-ietf-httpapi-idempotency-key-header-07"
[2]: https://developer.mozilla.org/ja/docs/Web/HTTP/Reference/Status/202?utm_source=chatgpt.com "202 Accepted - HTTP - MDN Web Docs"
[3]: https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/Retry-After?utm_source=chatgpt.com "Retry-After header - HTTP - MDN Web Docs"
[4]: https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Status/409?utm_source=chatgpt.com "409 Conflict - HTTP - MDN Web Docs - Mozilla"
[5]: https://docs.adyen.com/development-resources/error-codes?utm_source=chatgpt.com "Error codes and messages"
[6]: https://docs.stripe.com/api/idempotent_requests?utm_source=chatgpt.com "Idempotent requests | Stripe API Reference"
[7]: https://developer.mozilla.org/ja/docs/Web/HTTP/Reference/Status/503?utm_source=chatgpt.com "503 Service Unavailable - HTTP - MDN Web Docs"
