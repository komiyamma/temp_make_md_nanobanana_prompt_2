# ç¬¬19ç« ï¼šå¤±æ•—çµæœã‚‚ä¿å­˜ã™ã‚‹ï¼Ÿï¼ˆå†ªç­‰ Ã— ã‚¨ãƒ©ãƒ¼ä¿å­˜æˆ¦ç•¥ï¼‰ğŸ§ ğŸ“¦

## ğŸ¯ã“ã®ç« ã®ã‚´ãƒ¼ãƒ«

* ã€Œå¤±æ•—ï¼ˆã‚¨ãƒ©ãƒ¼ï¼‰ã‚‚ä¿å­˜ã™ã‚‹/ã—ãªã„ã€ã‚’ **ã‚±ãƒ¼ã‚¹åˆ¥ã«åˆ¤æ–­**ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹âœ¨
* åŒã˜ `Idempotency-Key` ã§æ¥ãŸã¨ãã«ã€**ã©ã‚“ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ã®ãŒå®‰å…¨ã‹**èª¬æ˜ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ğŸ”
* ãƒŸãƒ‹æ³¨æ–‡APIã§ã€Œã‚¨ãƒ©ãƒ¼ä¿å­˜ã€ã‚’ **TypeScriptã§å®Ÿè£…**ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ğŸ§‘â€ğŸ’»ğŸ’•

![Concept](./picture/idem_ts_study_019_error_save.png)

---

## 1) ã¾ãšçµè«–ï¼šã‚¨ãƒ©ãƒ¼ä¿å­˜ã€ã™ã‚‹ã®ï¼Ÿã—ãªã„ã®ï¼ŸğŸ¤”

çµè«–ã¯ **ã€Œå¤±æ•—ã®ç¨®é¡ã«ã‚ˆã‚‹ã€** ã ã‚ˆã€œï¼ğŸŒ¸

* âœ… **ä¿å­˜ã—ãŸã„å¤±æ•—**ï¼šå…¥åŠ›ãƒŸã‚¹ãƒ»åœ¨åº«ä¸è¶³ãƒ»æ®‹é«˜ä¸è¶³ãªã©ã€**åŒã˜å…¥åŠ›ãªã‚‰çµæœãŒå¤‰ã‚ã‚‰ãªã„ç³»**
* âš ï¸ **æ…é‡ãªå¤±æ•—**ï¼šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒ»503ãƒ»ä¸€æ™‚çš„ãªå¤–éƒ¨APIéšœå®³ãªã©ã€**æ™‚é–“ãŒçµŒã¤ã¨æˆåŠŸã—ã†ã‚‹ç³»**

ã§ã‚‚ã­ã€å®Ÿå‹™ã§ã¯ã€Œã¨ã«ã‹ãåŒã˜ã‚­ãƒ¼ãªã‚‰åŒã˜çµæœã‚’è¿”ã™ã€è¨­è¨ˆã‚‚ã‚ˆãã‚ã‚‹ã‚ˆã€‚Stripeã¯ **æœ€åˆã®çµæœï¼ˆæˆåŠŸ/å¤±æ•—/500å«ã‚€ï¼‰ã‚’ä¿å­˜ã—ã¦ã€åŒã˜ã‚­ãƒ¼ãªã‚‰åŒã˜ãƒ¬ã‚¹ãƒãƒ³ã‚¹**ã‚’è¿”ã™æ–¹å¼ã‚’èª¬æ˜ã—ã¦ã‚‹ã‚ˆã€‚ ([Stripeãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][1])

---

## 2) å¤±æ•—çµæœã‚’ä¿å­˜ã™ã‚‹ãƒ¡ãƒªãƒƒãƒˆğŸ‘âœ¨

### âœ…ãƒ¡ãƒªãƒƒãƒˆAï¼šäºŒé‡å®Ÿè¡Œã‚’æ­¢ã‚ã‚‰ã‚Œã‚‹ï¼ˆå‰¯ä½œç”¨ãŒæ€–ã„ç³»ã«å¼·ã„ï¼‰ğŸ’³ğŸ§¨

æ±ºæ¸ˆãƒ»æ³¨æ–‡ç¢ºå®šãƒ»ãƒã‚¤ãƒ³ãƒˆä»˜ä¸â€¦ã¿ãŸã„ãªã€Œ1å›ã§ã‚‚å‰¯ä½œç”¨ãŒå‡ºãŸã‚‰æ€–ã„ã€æ“ä½œã¯ã€
**â€œå¤±æ•—ã£ã½ãè¦‹ãˆã¦ã‚‚ã€å®Ÿã¯è£ã§æˆåŠŸã—ã¦ãŸâ€** ãŒèµ·ããŒã¡ğŸ˜‡ğŸŒ§ï¸
ã ã‹ã‚‰ **åŒã˜ã‚­ãƒ¼ã§å†å®Ÿè¡Œã•ã›ãªã„**ã®ãŒå®‰å…¨ã«ãªã‚Šã‚„ã™ã„ï¼

### âœ…ãƒ¡ãƒªãƒƒãƒˆBï¼šã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒè¿·ã‚ãªã„ï¼ˆåŒã˜ã‚­ãƒ¼ï¼åŒã˜çµæœï¼‰ğŸ§­

ã€Œã•ã£ãã¯400ã ã£ãŸã®ã«ã€åŒã˜ã‚­ãƒ¼ã§é€ã£ãŸã‚‰201ã«ãªã£ãŸã€ã¿ãŸã„ãªã®ã¯æ··ä¹±ã®ã‚‚ã¨ğŸ˜µâ€ğŸ’«
**åŒã˜ã‚­ãƒ¼ãªã‚‰åŒã˜çµæœ**ã¯ã€APIã¨ã—ã¦ã™ã”ãäºˆæ¸¬ã—ã‚„ã™ã„ğŸ“œâœ¨

### âœ…ãƒ¡ãƒªãƒƒãƒˆCï¼šãƒ ãƒ€ãªè² è·ãŒæ¸›ã‚‹ï¼ˆãƒªãƒˆãƒ©ã‚¤åµã‚’æŠ‘ãˆã‚‹ï¼‰ğŸŒªï¸â¡ï¸ğŸƒ

åŒã˜å‡¦ç†ã‚’ä½•å›ã‚‚èµ°ã‚‰ã›ãªã„ã‹ã‚‰ã€ã‚µãƒ¼ãƒãƒ¼ã«ã‚‚å¤–éƒ¨APIã«ã‚‚å„ªã—ã„ğŸ¥¹ğŸ’•

---

## 3) å¤±æ•—çµæœã‚’ã€Œä¿å­˜ã—ãªã„ã€ãƒ¡ãƒªãƒƒãƒˆâš¡

### âœ…ãƒ¡ãƒªãƒƒãƒˆAï¼šä¸€æ™‚çš„ãªå¤±æ•—ã‹ã‚‰è‡ªç„¶å›å¾©ã§ãã‚‹ğŸŒˆ

ãŸã¨ãˆã°ä¸€æ™‚çš„ãªå¤–éƒ¨éšœå®³ã§503ã ã£ãŸã®ã«ã€
åŒã˜ã‚­ãƒ¼ã§æ¥ãŸã‚‰ **ãšã£ã¨503å›ºå®š**ã«ãªã£ã¡ã‚ƒã†ã¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ãŒå¾®å¦™â€¦ğŸ¥²

### âœ…ãƒ¡ãƒªãƒƒãƒˆBï¼šã€Œæ™‚é–“ãŒçµŒã¦ã°æˆåŠŸã€ç³»ã«å¼·ã„ğŸ•’

429ï¼ˆãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼‰ã‚„ä¸€æ™‚çš„ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¯ã€
â€œå°‘ã—å¾…ã£ã¦å†è©¦è¡Œâ€ ãŒæ­£è§£ã®ã“ã¨ãŒå¤šã„ã‚ˆã­ğŸ”
AWSã‚‚ã€Œä¸€æ™‚çš„å¤±æ•—ã¯ãƒªãƒˆãƒ©ã‚¤ã€æ’ä¹…çš„å¤±æ•—ã¯ãƒªãƒˆãƒ©ã‚¤ã—ãªã„ã€æ–¹å‘ã®è€ƒãˆæ–¹ã‚’æ•´ç†ã—ã¦ã‚‹ã‚ˆã€‚ ([AWS ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][2])

---

## 4) åˆ¤æ–­ã®è»¸ï¼ˆã“ã‚Œã ã‘è¦šãˆã‚Œã°å¼·ã„ï¼‰ğŸ§ ğŸª„

ã‚¨ãƒ©ãƒ¼ãŒæ¥ãŸã¨ãã€æ¬¡ã®5ã¤ã§è€ƒãˆã‚‹ã¨è¿·ã„ã«ãã„ã‚ˆâœ¨

1. **åŒã˜å…¥åŠ›ãªã‚‰çµæœã¯æœ¬å½“ã«å¤‰ã‚ã‚‰ãªã„ï¼Ÿ**ï¼ˆå…¥åŠ›ä¸æ­£ãƒ»æ®‹é«˜ä¸è¶³ã¯å¤‰ã‚ã‚‰ãªã„ã“ã¨ãŒå¤šã„ï¼‰ğŸ§¾
2. **å‰¯ä½œç”¨ãŒâ€œèµ·ããŸå¯èƒ½æ€§â€ãŒã‚ã‚‹ï¼Ÿ**ï¼ˆæ±ºæ¸ˆãƒ»æ³¨æ–‡ç¢ºå®šã¯æ€–ã„ï¼‰ğŸ’¥
3. **ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒç›´ã™ã¹ãï¼Ÿå¾…ã¤ã¹ãï¼Ÿ**ï¼ˆ400ã¯ç›´ã™ã€503ã¯å¾…ã¤ï¼‰ğŸ§‘â€ğŸ”§ğŸ•’
4. **åŒã˜ã‚­ãƒ¼ã§â€œå†å®Ÿè¡Œâ€ã•ã›ãŸã„ï¼Ÿãã‚Œã¨ã‚‚â€œçµæœç…§ä¼šâ€ã«ã—ãŸã„ï¼Ÿ**ğŸ”
5. **ã‚¨ãƒ©ãƒ¼å†…å®¹ã«å€‹äººæƒ…å ±ã‚„å†…éƒ¨æƒ…å ±ãŒæ··ã–ã‚‰ãªã„ï¼Ÿ**ï¼ˆä¿å­˜ã™ã‚‹ãªã‚‰è¦æ³¨æ„ï¼‰ğŸ”’

![Decision Flow: To Save or Not to Save Error](./picture/idem_ts_study_019_decision_tree.png)

---

## 5) ã–ã£ãã‚Šæ—©è¦‹è¡¨ï¼ˆãƒŸãƒ‹æ³¨æ–‡APIæƒ³å®šï¼‰ğŸ“‹âœ¨

| ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡    | ä¾‹            |     ä¿å­˜ãŠã™ã™ã‚ï¼Ÿ | ç†ç”±                        | ã‚ˆãã‚ã‚‹æŒ™å‹•                                      |
| --------- | ------------ | ----------: | ------------------------- | ------------------------------------------- |
| å…¥åŠ›ä¸æ­£      | 400 / 422    |         âœ…ä¿å­˜ | åŒã˜å…¥åŠ›ãªã‚‰ãšã£ã¨NGã€‚å†å®Ÿè¡Œã•ã‚Œã¦ã‚‚å›°ã‚‹     | åŒã˜ã‚­ãƒ¼â†’åŒã˜ã‚¨ãƒ©ãƒ¼å›ºå®š                                |
| åœ¨åº«ä¸è¶³/æ®‹é«˜ä¸è¶³ | 409 / 402 ãªã© | âœ…ä¿å­˜ï¼ˆçŸ­ã€œä¸­TTLï¼‰ | â€œåŒã˜æ³¨æ–‡å†…å®¹ã®åŒã˜è©¦è¡Œâ€ã¨ã—ã¦å›ºå®šã—ãŸã„     | æ–°ã—ã„è©¦è¡Œã¯æ–°ã‚­ãƒ¼ã§                                  |
| èªè¨¼/æ¨©é™     | 401 / 403    |   âœ…ä¿å­˜ï¼ˆçŸ­TTLï¼‰ | åŒã˜æ¡ä»¶ãªã‚‰åŒã˜çµæœ                | ãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°ã¯åˆ¥ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/åˆ¥ã‚­ãƒ¼                           |
| ãƒ¬ãƒ¼ãƒˆåˆ¶é™     | 429          |        âš ï¸æ…é‡ | æ™‚é–“ã§å›å¾©ã™ã‚‹                   | ä¿å­˜ã™ã‚‹ãªã‚‰çŸ­TTLã‚„å†è©¦è¡Œè¨­è¨ˆ                            |
| ä¸€æ™‚çš„éšœå®³     | 503 / ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ |        âš ï¸æ…é‡ | å›å¾©ã—ãŸã‚‰æˆåŠŸã—ã†ã‚‹                | ã€Œå‡¦ç†ä¸­ã€æ‰±ã„ or å†è©¦è¡ŒOKè¨­è¨ˆ                          |
| ã‚µãƒ¼ãƒãƒ¼å†…éƒ¨ã‚¨ãƒ©ãƒ¼ | 500          |        æ–¹é‡æ¬¡ç¬¬ | â€œæœ€åˆã®çµæœå›ºå®šâ€ã«å¯„ã›ã‚‹ã‹ã€â€œå†å®Ÿè¡Œâ€ã«å¯„ã›ã‚‹ã‹ | Stripeã¯åŒã˜ã‚­ãƒ¼â†’åŒã˜çµæœï¼ˆ500å«ã‚€ï¼‰ ([Stripeãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][1]) |

---

## 6) å®Ÿè£…æ–¹é‡ã¯2æŠï¼ˆã©ã£ã¡ã‚‚ã‚¢ãƒªï¼‰ğŸ”ğŸ§©

### æ–¹é‡Aï¼š**æœ€åˆã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ä¿å­˜ã—ã¦å›ºå®š**ï¼ˆã‚·ãƒ³ãƒ—ãƒ«âœ¨ï¼‰

* âœ…å®Ÿè£…ãŒç°¡å˜
* âœ…ã€ŒåŒã˜ã‚­ãƒ¼ï¼åŒã˜çµæœã€ã§è¿·ã„ã«ãã„
* âš ï¸ä¸€æ™‚çš„éšœå®³ã§ã‚‚å›ºå®šã•ã‚Œã‚‹ï¼ˆæˆåŠŸã•ã›ãŸã„ãªã‚‰æ–°ã—ã„ã‚­ãƒ¼ãŒå¿…è¦ã«ãªã‚ŠãŒã¡ï¼‰

ã“ã®è€ƒãˆæ–¹ã¯Stripeã®èª¬æ˜ã¨è¿‘ã„ã‚ˆï¼ˆæˆåŠŸ/å¤±æ•—/500å«ã‚ã¦ã€åŒã˜ã‚­ãƒ¼ãªã‚‰åŒã˜çµæœã‚’è¿”ã™ï¼‰ã€‚ ([Stripeãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][1])

### æ–¹é‡Bï¼š**ä¸€æ™‚çš„å¤±æ•—ã¯å›ºå®šã—ãªã„ï¼ˆå†å®Ÿè¡Œã§ãã‚‹ä½™åœ°ã‚’æ®‹ã™ï¼‰**ï¼ˆå®Ÿå‹™å¯„ã‚Šâš™ï¸ï¼‰

* âœ…å›å¾©å¾Œã«åŒã˜ã‚­ãƒ¼ã§æˆåŠŸã§ãã‚‹å¯èƒ½æ€§
* âš ï¸è¨­è¨ˆãŒå°‘ã—é›£ã—ã„ï¼ˆçŠ¶æ…‹ç®¡ç†ãŒè¦ã‚‹ï¼‰

```mermaid
flowchart TD
    Error[ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ] --> Nature{ã‚¨ãƒ©ãƒ¼ã®æ€§è³ªã¯?}
    Nature -- å†å®Ÿè¡Œã—ã¦ã‚‚ç„¡é§„<br/>(400, 422, æ®‹é«˜ä¸è¶³) --> Save[çµæœã‚’ä¿å­˜ ğŸ“¦]
    Nature -- å›å¾©ã®å¯èƒ½æ€§ã‚ã‚Š<br/>(503, 429, ä¸€æ™‚DBéšœå®³) --> NoSave[ä¿å­˜ã—ãªã„ or çŸ­TTL â³]
    Nature -- çµæœä¸æ˜<br/>(Timeout) --> SaveFixed[å‰¯ä½œç”¨é˜²æ­¢ã®ãŸã‚ä¿å­˜ ğŸ›¡ï¸]
    Save --> End[åŒã˜ã‚­ãƒ¼ã«ã¯åŒã˜ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™]
    NoSave --> Retry[å†é€æ™‚ã«â€œåˆã‚ã‹ã‚‰â€ã‚„ã‚Šç›´ã—]
```

---

## 7) ãƒŸãƒ‹æ³¨æ–‡APIï¼šã‚¨ãƒ©ãƒ¼ä¿å­˜ã¤ã â€œå†ªç­‰ã‚¹ãƒˆã‚¢â€ å®Ÿè£…ï¼ˆæ–¹é‡Aï¼‰ğŸ§‘â€ğŸ’»ğŸ“¦

### âœ…ãƒ‡ãƒ¼ã‚¿æ§‹é€ ï¼ˆæˆåŠŸ/å¤±æ•—ã©ã£ã¡ã‚‚ä¿å­˜ï¼‰

```ts
type StoredResponse = {
  statusCode: number;
  body: unknown; // å®Ÿå‹™ã§ã¯ JSON ã ã‘ã«çµã‚‹ã¨æ¥½
  headers?: Record<string, string>;
};

type IdempotencyRecord =
  | {
      status: "processing";
      requestHash: string;
      createdAt: number;
      expiresAt: number;
    }
  | {
      status: "completed";
      requestHash: string;
      createdAt: number;
      expiresAt: number;
      response: StoredResponse; // æˆåŠŸã§ã‚‚å¤±æ•—ã§ã‚‚ã“ã“ã«ä¿å­˜
    };
```

### âœ…è¶…ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ¡ãƒ¢ãƒªã‚¹ãƒˆã‚¢ï¼ˆTTLã¤ãï¼‰

```ts
import crypto from "node:crypto";

export class InMemoryIdempotencyStore {
  private map = new Map<string, IdempotencyRecord>();

  constructor(private readonly ttlMs: number) {}

  get(key: string): IdempotencyRecord | undefined {
    const rec = this.map.get(key);
    if (!rec) return;
    if (Date.now() > rec.expiresAt) {
      this.map.delete(key);
      return;
    }
    return rec;
  }

  // å…ˆã« processing ã‚’ç½®ã‘ãŸäººãŒå‹ã¡ï¼ˆåŒæ™‚å®Ÿè¡Œå¯¾ç­–ã®è¶…å…¥é–€ç‰ˆï¼‰
  tryBegin(key: string, requestHash: string): { ok: true } | { ok: false; existing: IdempotencyRecord } {
    const existing = this.get(key);
    if (existing) return { ok: false, existing };

    const now = Date.now();
    this.map.set(key, {
      status: "processing",
      requestHash,
      createdAt: now,
      expiresAt: now + this.ttlMs,
    });
    return { ok: true };
  }

  complete(key: string, requestHash: string, response: StoredResponse): void {
    const now = Date.now();
    this.map.set(key, {
      status: "completed",
      requestHash,
      createdAt: now,
      expiresAt: now + this.ttlMs,
      response,
    });
  }
}

export function sha256Json(value: unknown): string {
  const json = JSON.stringify(value); // å®Ÿå‹™ã¯ã€Œé †åºå›ºå®šã€ã—ãŸã„ã‘ã©ä»Šå›ã¯å…¥é–€ã§OK
  return crypto.createHash("sha256").update(json).digest("hex");
}
```

### âœ…ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ä¾‹ï¼ˆExpressæƒ³å®šã®é›°å›²æ°—ï¼‰

ãƒã‚¤ãƒ³ãƒˆã¯ã“ã‚ŒğŸ‘‡

* 1å›ç›®ï¼š`processing` ã‚’ç½®ã„ã¦å‡¦ç†â†’çµæœï¼ˆæˆåŠŸ/å¤±æ•—ï¼‰ã‚’ `completed` ã§ä¿å­˜
* 2å›ç›®ä»¥é™ï¼šä¿å­˜æ¸ˆã¿ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãã®ã¾ã¾è¿”ã™ğŸ”

```ts
import type { Request, Response } from "express";
import { InMemoryIdempotencyStore, sha256Json } from "./idempotency-store.js";

const store = new InMemoryIdempotencyStore(24 * 60 * 60 * 1000); // 24h ä¾‹
// Stripeã¯ã€Œã‚­ãƒ¼ã¯24æ™‚é–“ã§æœŸé™åˆ‡ã‚Œã€ã¨èª¬æ˜ã—ã¦ã„ã‚‹ã‚ˆ :contentReference[oaicite:4]{index=4}

function getUserId(req: Request): string {
  // ä»Šå›ã¯ä¾‹ã€‚èªè¨¼æ¸ˆã¿ã§ userId ãŒå–ã‚Œã‚‹å‰æã®é›°å›²æ°—
  return String(req.header("X-User-Id") ?? "anonymous");
}

export async function createOrder(req: Request, res: Response) {
  const idemKey = req.header("Idempotency-Key");
  if (!idemKey) {
    return res.status(400).json({ message: "Idempotency-Key is required" });
  }

  const userId = getUserId(req);
  const storeKey = `${userId}:${idemKey}`;

  const requestHash = sha256Json({
    path: req.path,
    method: req.method,
    body: req.body,
  });

  const started = store.tryBegin(storeKey, requestHash);

  // ã™ã§ã«åŒã˜ã‚­ãƒ¼ãŒã‚ã‚‹
  if (!started.ok) {
    const existing = started.existing;

    // ã‚­ãƒ¼ã®ä½¿ã„å›ã—ï¼ˆåˆ¥å†…å®¹ï¼‰ã‚’æ¤œçŸ¥ã—ãŸã„ãªã‚‰ã“ã“ã§å¼¾ã
    if (existing.requestHash !== requestHash) {
      return res.status(409).json({
        message: "Idempotency-Key was already used with a different request body",
      });
    }

    if (existing.status === "processing") {
      // ã€Œã¾ã å‡¦ç†ä¸­ã€ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼š202ã§å¾…ã£ã¦ã‚‚ã‚‰ã†ã®ãŒåˆ†ã‹ã‚Šã‚„ã™ã„
      return res.status(202).json({ message: "Processing. Please retry later." });
    }

    // completedï¼šæˆåŠŸã§ã‚‚å¤±æ•—ã§ã‚‚ä¿å­˜æ¸ˆã¿ã‚’è¿”ã™
    const { statusCode, body, headers } = existing.response;
    if (headers) {
      for (const [k, v] of Object.entries(headers)) res.setHeader(k, v);
    }
    return res.status(statusCode).json(body);
  }

  // ã“ã“ã‹ã‚‰ãŒã€Œ1å›ç›®ã®æœ¬å‡¦ç†ã€
  try {
    // --- ä¾‹ï¼šæ³¨æ–‡ä½œæˆã£ã½ã„å‡¦ç†ï¼ˆæœ¬ç‰©ã¯DBã‚„æ±ºæ¸ˆAPIï¼‰ ---
    // å…¥é–€ãªã®ã§ã€ŒãŸã¾ãŸã¾å¤±æ•—ã™ã‚‹ã€ã‚‚ä½œã‚Œã‚‹ã‚ˆ
    const amount = Number(req.body?.amount ?? 0);
    if (!Number.isFinite(amount) || amount <= 0) {
      const errorBody = { message: "amount must be a positive number" };
      store.complete(storeKey, requestHash, { statusCode: 422, body: errorBody });
      return res.status(422).json(errorBody);
    }

    // æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹
    const okBody = { orderId: crypto.randomUUID(), status: "created", amount };
    store.complete(storeKey, requestHash, { statusCode: 201, body: okBody });
    return res.status(201).json(okBody);
  } catch (e) {
    // 500ã§ã‚‚ã€Œæœ€åˆã®çµæœã€ã‚’ä¿å­˜ã—ã¦å›ºå®šã™ã‚‹ï¼ˆæ–¹é‡Aï¼‰
    const errorBody = { message: "internal error" };
    store.complete(storeKey, requestHash, { statusCode: 500, body: errorBody });
    return res.status(500).json(errorBody);
  }
}
```

---

## 8) æ–¹é‡Aã®æ³¨æ„ç‚¹ï¼ˆã“ã“ã ã‘ã¯æŠ¼ã•ãˆã¦ã­ï¼‰âš ï¸ğŸ§·

### âœ…ã€Œå›å¾©ã—ãŸã‚‰æˆåŠŸã§ãã‚‹ã€ã‚¨ãƒ©ãƒ¼ã§ã‚‚å›ºå®šã•ã‚Œã‚‹å¯èƒ½æ€§

ä¾‹ãˆã°å¤–éƒ¨APIãŒä¸€æ™‚éšœå®³ã§500ã«ãªã£ãŸã‚‰ã€åŒã˜ã‚­ãƒ¼ã¯ãšã£ã¨500å›ºå®šã«ãªã‚ŠãŒã¡ğŸ¥²
ãã®ä»£ã‚ã‚Š **äºŒé‡å®Ÿè¡Œã®å±é™ºã¯æ¸›ã‚‹**ã€‚

### âœ…TTLã¯ã€Œæœ€å¤§ãƒªãƒˆãƒ©ã‚¤æœŸé–“ã€ã‚’è¦‹ã¦æ±ºã‚ã‚‹ğŸ•’

* Stripeã®ä¾‹ã§ã¯ **24æ™‚é–“**ã®æœŸé™ãŒç¤ºã•ã‚Œã¦ã‚‹ã‚ˆ ([Stripeãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][3])
* ãŸã¨ãˆã°OpenAIã®Webhookã¯ã€å¤±æ•—æ™‚ã« **æœ€å¤§72æ™‚é–“ãƒªãƒˆãƒ©ã‚¤**ã™ã‚‹èª¬æ˜ãŒã‚ã‚‹ã‚ˆï¼ˆæŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼‰ ([OpenAI Platform][4])
  â†’ ã‚‚ã—Webhookå—ä¿¡ã®å†ªç­‰ã‚’ã‚„ã‚‹ãªã‚‰ã€TTLã¯72hä»¥ä¸ŠãŒå®‰å¿ƒãªã“ã¨ã‚‚ã‚ã‚‹ğŸ“®âœ¨

---

## 9) ğŸ“ãƒŸãƒ‹æ¼”ç¿’ï¼šä¿å­˜ã™ã‚‹ï¼Ÿã—ãªã„ï¼Ÿã‚¸ãƒ£ãƒƒã‚¸ç·´ç¿’ğŸ¯

æ¬¡ã®ã‚±ãƒ¼ã‚¹ã§ã€Œä¿å­˜ã™ã‚‹/ã—ãªã„/çŸ­TTLã§ä¿å­˜ã€ã©ã‚Œã«ã™ã‚‹ã‹æ±ºã‚ã¦ã¿ã¦ã­âœï¸ğŸ’•ï¼ˆç†ç”±ã‚‚1è¡Œã§ï¼ï¼‰

1. 422ï¼ˆå…¥åŠ›ãƒŸã‚¹ï¼‰ğŸ“›
2. 409ï¼ˆåœ¨åº«ä¸è¶³ï¼‰ğŸ“¦
3. 429ï¼ˆãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼‰ğŸš¦
4. 503ï¼ˆå¤–éƒ¨æ±ºæ¸ˆãŒä¸€æ™‚åœæ­¢ï¼‰ğŸ’³
5. 500ï¼ˆå†…éƒ¨ã‚¨ãƒ©ãƒ¼ã€ã§ã‚‚â€œæ±ºæ¸ˆãŒå®Ÿã¯æˆåŠŸã—ã¦ãŸã‹ã‚‚â€ãŒæ€–ã„ï¼‰ğŸ˜±

---

## 10) ğŸ¤–AIæ´»ç”¨ï¼šåˆ¤æ–­åŠ›ã‚’çˆ†ä¸Šã’ã™ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé›†âœ¨

### ã‚±ãƒ¼ã‚¹åˆ¤å®šï¼ˆãŠã™ã™ã‚ï¼‰

* ã€Œæ¬¡ã®ã‚¨ãƒ©ãƒ¼ã¯ **æ’ä¹…çš„/ä¸€æ™‚çš„/çµæœä¸æ˜** ã®ã©ã‚Œï¼Ÿç†ç”±ã‚‚æ·»ãˆã¦ï¼šâ€¦ã€ğŸ§ 
* ã€Œå†ªç­‰ã‚­ãƒ¼æ–¹å¼ã§ã€**å¤±æ•—ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ä¿å­˜ã™ã‚‹ã¹ãã‚±ãƒ¼ã‚¹**ã‚’å…·ä½“ä¾‹ã¤ãã§10å€‹å‡ºã—ã¦ã€ğŸ”

### ãƒ†ã‚¹ãƒˆç”Ÿæˆï¼ˆã‚ã¡ã‚ƒä¾¿åˆ©ï¼‰

* ã€Œã“ã®APIã®å†ªç­‰æ€§ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ã€**åŒä¸€ã‚­ãƒ¼2å›/10å›/åŒæ™‚å®Ÿè¡Œ/åˆ¥ãƒœãƒ‡ã‚£åŒä¸€ã‚­ãƒ¼**ã§åˆ—æŒ™ã—ã¦ã€ğŸ§ª
* ã€Œâ€œå‡¦ç†ä¸­(202)â€ã®ã¨ãã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ã©ã†æŒ¯ã‚‹èˆã†ã¹ãï¼Ÿç–‘ä¼¼ã‚³ãƒ¼ãƒ‰ã§ã€â³

---

## âœ…ã¾ã¨ã‚ï¼ˆã“ã®ç« ã®è¦šãˆã©ã“ã‚ï¼‰ğŸŒ¸

* ã‚¨ãƒ©ãƒ¼ä¿å­˜ã¯ **ã€ŒåŒã˜ã‚­ãƒ¼ï¼åŒã˜çµæœã€** ã‚’ä½œã‚Œã¦å¼·ã„ğŸ”âœ¨
* ãŸã ã— **ä¸€æ™‚çš„ã‚¨ãƒ©ãƒ¼ï¼ˆ429/503/ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰** ã¯å›ºå®šã™ã‚‹ã¨è¾›ã„ã“ã¨ã‚‚ã‚ã‚‹âš ï¸
* è¿·ã£ãŸã‚‰ã€ã¾ãšã¯ **æ–¹é‡Aï¼ˆæœ€åˆã®çµæœã‚’ä¿å­˜ã—ã¦å›ºå®šï¼‰** ã§å®‰å…¨å´ã«å€’ã™ã®ãŒå…¥é–€ã¨ã—ã¦ã¯ãŠã™ã™ã‚ï¼ˆStripeã‚‚ã“ã®æ€æƒ³ã‚’èª¬æ˜ï¼‰ ([Stripeãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][1])
* TTLã¯ **ã‚·ã‚¹ãƒ†ãƒ ã®æœ€å¤§ãƒªãƒˆãƒ©ã‚¤æœŸé–“** ã‚’è¦‹ã¦æ±ºã‚ã‚‹ï¼ˆWebhookç³»ã¯é•·ã‚ã«ãªã‚ŠãŒã¡ï¼‰ğŸ“®ğŸ•’ ([OpenAI Platform][4])

[1]: https://docs.stripe.com/api/idempotent_requests?utm_source=chatgpt.com "Idempotent requests | Stripe API Reference"
[2]: https://docs.aws.amazon.com/lambda/latest/dg/durable-best-practices.html?utm_source=chatgpt.com "Best practices for Lambda durable functions"
[3]: https://docs.stripe.com/error-low-level?utm_source=chatgpt.com "Advanced error handling - Stripe API"
[4]: https://platform.openai.com/docs/guides/webhooks?utm_source=chatgpt.com "Webhooks | OpenAI API"

