# ç¬¬22ç« ï¼šãƒªãƒˆãƒ©ã‚¤è¨­è¨ˆï¼ˆå›žæ•°ãƒ»é–“éš”ãƒ»ãƒãƒƒã‚¯ã‚ªãƒ•ï¼‰ðŸ”ðŸ“‰

## 1) ãƒªãƒˆãƒ©ã‚¤ã£ã¦ã€ãã‚‚ãã‚‚ä½•ã‚’â€œå®ˆã‚‹â€ãŸã‚ï¼ŸðŸ›¡ï¸âœ¨

ãƒªãƒˆãƒ©ã‚¤ï¼ˆå†è©¦è¡Œï¼‰ã¯ã€ŒãŸã¾ãŸã¾å¤±æ•—ã—ãŸã ã‘ã®é€šä¿¡ãƒ»å‡¦ç†ã€ã‚’ã€ã¡ã‚‡ã£ã¨å¾…ã£ã¦ã‹ã‚‰ã‚„ã‚Šç›´ã—ã¦æˆåŠŸçŽ‡ã‚’ä¸Šã’ã‚‹ãŸã‚ã®ä»•çµ„ã¿ã ã‚ˆðŸ˜ŠðŸ“¶
ãŸã ã—ï¼ã‚„ã‚Šæ–¹ã‚’é–“é•ãˆã‚‹ã¨ã€å¤±æ•—ã—ã¦ã‚‹ç›¸æ‰‹ã«ã•ã‚‰ã«è² è·ã‚’ã‹ã‘ã¦ã€å¾©æ—§ã‚’é‚ªé­”ã—ã¡ã‚ƒã†ã“ã¨ã‚‚ã‚ã‚‹ã®â€¦ðŸ˜µâ€ðŸ’«ðŸ’¥ï¼ˆãƒªãƒˆãƒ©ã‚¤ã¯â€œåŠ¹ãã‘ã©å¼·ã„è–¬â€ã¿ãŸã„ãªã‚‚ã®ï¼‰([Amazon Web Services, Inc.][1])

---

## 2) ã¾ãšè¶…é‡è¦ï¼šä½•ã§ã‚‚ãƒªãƒˆãƒ©ã‚¤ã—ã¡ã‚ƒãƒ€ãƒ¡ðŸ™…â€â™€ï¸âš ï¸

### âœ… ãƒªãƒˆãƒ©ã‚¤å‘ãï¼ˆï¼ä¸€æ™‚çš„ï¼štransientï¼‰ðŸŒ¦ï¸

ä»£è¡¨ä¾‹ï¼š

* ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çž¬æ–­ã€æŽ¥ç¶šãƒªã‚»ãƒƒãƒˆã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆâ³ðŸ“¡
* HTTPãªã‚‰ **408 / 429 / 5xx** ã¿ãŸã„ãªã€Œä¸€æ™‚çš„ã€ã£ã½ã„ã‚‚ã®ðŸ§¯

Google Cloudã®ã‚¬ã‚¤ãƒ‰ã‚‚ã€Œä¸€æ™‚çš„ã‚¨ãƒ©ãƒ¼ã ã‘ã‚’ãƒªãƒˆãƒ©ã‚¤ã—ã¦ã­ã€ã£ã¦ã¯ã£ãã‚Šè¨€ã£ã¦ã‚‹ã‚ˆðŸ“Œ([Google Cloud Documentation][2])

### âŒ ãƒªãƒˆãƒ©ã‚¤ã—ãªã„æ–¹ãŒã„ã„ï¼ˆï¼æ°¸ç¶šçš„ï¼špermanentï¼‰ðŸ§±

ä»£è¡¨ä¾‹ï¼š

* èªè¨¼ãƒŸã‚¹ï¼ˆ401/403ï¼‰ðŸ”‘âŒ
* ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤‰ï¼ˆ400ï¼‰ðŸ§©âŒ
* ãã‚‚ãã‚‚å­˜åœ¨ã—ãªã„ï¼ˆ404ï¼‰ðŸ‘»âŒ

ã“ã†ã„ã†ã®ã¯ã€å¾…ã£ã¦ã‚‚ç›´ã‚‰ãªã„ã‹ã‚‰ã€ŒåŽŸå› ã‚’ç›´ã™ã€æ–¹å‘ã«é€²ã‚€ã®ãŒæ­£è§£ã ã‚ˆðŸ› ï¸âœ¨([Google Cloud Documentation][2])

```mermaid
flowchart TD
    Err[ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ] --> Type{ç¨®é¡žã¯?}
    Type -- "ä¸€æ™‚çš„ (Transient)" --> Retry[ãƒªãƒˆãƒ©ã‚¤å¯¾è±¡ âœ…]
    Type -- "æ°¸ç¶šçš„ (Permanent)" --> Stop[ãƒªãƒˆãƒ©ã‚¤ã—ãªã„ âŒ]
    Retry -- "ä¾‹" --> T1[503 / 429 / TO]
    Stop -- "ä¾‹" --> S1[400 / 401 / 404]
```

---

## 3) ãƒªãƒˆãƒ©ã‚¤ã®â€œä¸‰ç‚¹ã‚»ãƒƒãƒˆâ€ðŸŽâœ¨ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‹ãƒãƒƒã‚¯ã‚ªãƒ•ï¼‹ã‚¸ãƒƒã‚¿ãƒ¼ï¼‰

ãƒªãƒˆãƒ©ã‚¤ã‚’å®‰å…¨ã«ã™ã‚‹åŸºæœ¬ã‚»ãƒƒãƒˆã¯ã“ã‚ŒðŸ‘‡

### (A) ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆâ°

ã€Œã„ã¤ã¾ã§å¾…ã¤ã‹ã€ã‚’æ±ºã‚ãªã„ã¨ã€1å›žã®è©¦è¡ŒãŒã‚ºãƒ«ã‚ºãƒ«é•·å¼•ã„ã¦å…¨ä½“ãŒå´©ã‚Œã‚‹ã‚ˆðŸ˜µâ€ðŸ’«
Azureã®ã‚¬ã‚¤ãƒ‰ã§ã‚‚ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¨ãƒªãƒˆãƒ©ã‚¤é–“éš”ã¨å›žæ•°ã‚’åˆã‚ã›ãŸâ€œç·æ™‚é–“â€ã‚’å¿…ãšè€ƒãˆã‚ˆã†ã­ã€ã£ã¦è¨€ã£ã¦ã‚‹ðŸ“Œ([Microsoft Learn][3])

### (B) ãƒãƒƒã‚¯ã‚ªãƒ•ï¼ˆå¾…ã¡æ™‚é–“ã‚’ä¼¸ã°ã™ï¼‰ðŸ“ˆ

å¤±æ•—ã—ãŸã‚‰ **ã™ãé€£æ‰“ã—ãªã„**ï¼
æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼ˆexponential backoffï¼‰ã§ã€å¾…ã¡æ™‚é–“ã‚’å¢—ã‚„ã—ã¦ã„ãã®ãŒå®šç•ªã ã‚ˆðŸ”ðŸ“‰([Microsoft Learn][3])

### (C) ã‚¸ãƒƒã‚¿ãƒ¼ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ãªæºã‚‰ãŽï¼‰ðŸŽ²

ã¿ã‚“ãªãŒåŒæ™‚ã«ã€Œ2ç§’å¾Œã«å†è©¦è¡Œï¼ã€ã£ã¦ãªã‚‹ã¨ã€ã¾ãŸåŒæ™‚ã«æ®ºåˆ°ã—ã¦å†ã³è½ã¡ã‚‹ã®â€¦ðŸ˜±ðŸŒ€
ã ã‹ã‚‰â€œã¡ã‚‡ã„ãƒ©ãƒ³ãƒ€ãƒ â€ã‚’æ··ãœã¦ã€å†è©¦è¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’ãƒãƒ©ã‘ã•ã›ã‚‹ã®ãŒã‚³ãƒ„ã ã‚ˆðŸŽ¯([Amazon Web Services, Inc.][4])

![Backoff & Jitter](./picture/saga_ts_study_022_backoff.png)

```mermaid
graph LR
    subgraph Backoff ["æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ• + ã‚¸ãƒƒã‚¿ãƒ¼ ðŸ“ˆðŸŽ²"]
        B1[1å›žç›®: 200ms] --> B2[2å›žç›®: 400ms Â± Î±]
        B2 --> B3[3å›žç›®: 800ms Â± Î±]
        B3 --> B4[...ä¸Šé™ã¾ã§]
    end
```

---

## 4) å›žæ•°ãƒ»é–“éš”ã®æ±ºã‚æ–¹ï¼ˆåˆå¿ƒè€…å‘ã‘ã®é‰„æ¿ãƒ«ãƒ¼ãƒ«ï¼‰ðŸ§ âœ¨

### ãƒ«ãƒ¼ãƒ«â‘ ï¼šã¾ãšã€Œç·ãƒªãƒŸãƒƒãƒˆæ™‚é–“ã€ã‚’æ±ºã‚ã‚‹â³ðŸŽ¯

ä¾‹ï¼šã“ã®Stepã¯æœ€å¤§ã§ã‚‚30ç§’ä»¥å†…ã«ã‚±ãƒªã‚’ã¤ã‘ãŸã„ã€ã¿ãŸã„ã«ã­ã€‚
ãã®ç¯„å›²ã§ã€Œã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‹å¾…ã¡ï¼‹å›žæ•°ã€ã‚’è¨­è¨ˆã™ã‚‹ã®ãŒåŸºæœ¬ã ã‚ˆðŸ“Œ([Microsoft Learn][3])

### ãƒ«ãƒ¼ãƒ«â‘¡ï¼šæœ€åˆã®1å›žã ã‘â€œå³ãƒªãƒˆãƒ©ã‚¤â€ã¯ã‚¢ãƒªï¼ˆã§ã‚‚1å›žã ã‘ï¼‰âš¡

ä¸€çž¬ã®é€šä¿¡ãƒ–ãƒ¬ãªã‚‰ã€å³ãƒªãƒˆãƒ©ã‚¤ã§é€šã‚‹ã“ã¨ãŒã‚ã‚‹ã‚ˆðŸ˜Š
ã§ã‚‚é€£æ‰“ã¯ç¦æ­¢ï¼ã€Œå³ãƒªãƒˆãƒ©ã‚¤ã¯æœ€å¤§1å›žã¾ã§ã€ã£ã¦è€ƒãˆã‚‹ã®ãŒå®‰å…¨âœ¨([Microsoft Learn][3])

### ãƒ«ãƒ¼ãƒ«â‘¢ï¼šãƒãƒƒã‚¯ã‚ªãƒ•ã¯â€œä¸Šé™ï¼ˆcapï¼‰â€ã‚’å¿…ãšä»˜ã‘ã‚‹ðŸ§¢

æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã¯æ”¾ç½®ã™ã‚‹ã¨å¾…ã¡ãŒé•·ããªã‚Šã™ãŽã‚‹ã‹ã‚‰ã€ä¸Šé™ã§æ­¢ã‚ã‚‹ã‚ˆï¼ˆä¾‹ï¼šæœ€å¤§30ç§’ï¼‰â›”
AWSã‚‚ã€Œä¸Šé™ã‚’ä»˜ã‘ã‚ˆã†ã€ã£ã¦å¼·èª¿ã—ã¦ã‚‹ðŸ“Œ([Amazon Web Services, Inc.][1])

---

## 5) Sagaã§ã®â€œãƒªãƒˆãƒ©ã‚¤è¨­è¨ˆâ€ã¯ã“ã“ãŒè‚ðŸ”¥ðŸ§©

Sagaã¯åˆ†å‰²å‡¦ç†ã ã‹ã‚‰ã€ãƒªãƒˆãƒ©ã‚¤ã‚’é›‘ã«å…¥ã‚Œã‚‹ã¨äº‹æ•…ã‚Šã‚„ã™ã„ã‚ˆã€œï¼ðŸ˜µâ€ðŸ’«ðŸ’£

### è‚â‘ ï¼šãƒªãƒˆãƒ©ã‚¤ã¯â€œ1ã‹æ‰€â€ã§ã‚„ã‚‹æ„è­˜ï¼ˆå¤šæ®µãƒªãƒˆãƒ©ã‚¤åœ°ç„ã‚’å›žé¿ï¼‰ðŸ§¯

ã‚µãƒ¼ãƒ“ã‚¹å‘¼ã³å‡ºã—ãŒä½•æ®µã‚‚é‡ãªã£ã¦ã‚‹ã¨ã€å„æ®µã§3å›žãƒªãƒˆãƒ©ã‚¤â€¦ã¿ãŸã„ã«ã™ã‚‹ã¨ã€ä¸‹æµã¸ã®è² è·ãŒçˆ†å¢—ã—ã¡ã‚ƒã†ðŸ¥¶
AWSã¯ã€Œãƒ¬ã‚¤ãƒ¤ãƒ¼ã”ã¨ã«å‹æ‰‹ã«ãƒªãƒˆãƒ©ã‚¤ãŒå¢—ãˆã‚‹ã¨ã€è² è·ãŒæŽ›ã‘ç®—ã§å¢—ãˆã‚‹ã€ã£ã¦å…·ä½“ä¾‹ã¾ã§å‡ºã—ã¦è­¦å‘Šã—ã¦ã‚‹ã‚ˆâš ï¸([Amazon Web Services, Inc.][1])

ðŸ‘‰ ã ã‹ã‚‰Sagaã§ã¯åŸºæœ¬ã€

* **ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆå¸ä»¤å¡”ï¼‰å´ã§â€œã¾ã¨ã‚ã¦åˆ¶å¾¡â€**
* Stepã®å†…éƒ¨ã§ã¯â€œã‚€ã‚„ã¿ã«ç‹¬è‡ªãƒªãƒˆãƒ©ã‚¤ã—ãªã„â€
  ã£ã¦è¨­è¨ˆãŒã‚ã‹ã‚Šã‚„ã™ã„ã‚ˆðŸŽ»âœ¨

### è‚â‘¡ï¼šå†ªç­‰æ€§ãŒãªã„Stepã¯ã€ãƒªãƒˆãƒ©ã‚¤ãŒå‡¶å™¨ðŸ”ªðŸ˜±

ãƒªãƒˆãƒ©ã‚¤ï¼åŒã˜StepãŒè¤‡æ•°å›žèµ°ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€ã£ã¦ã“ã¨ã€‚
ã€ŒäºŒé‡æ±ºæ¸ˆã€ã€ŒäºŒé‡å‡ºè·ã€ã¿ãŸã„ãªåœ°ç„ãŒèµ·ãã‚‹ã‹ã‚‰ã€**å†ªç­‰æ€§ï¼ˆç¬¬16ã€œ17ç« ï¼‰ã¨ã‚»ãƒƒãƒˆ**ã§è€ƒãˆã‚‹ã®ãŒå¤§å‰æã ã‚ˆðŸ”‘ðŸ’•

### è‚â‘¢ï¼šSagaãƒ­ã‚°ã«ã€Œè©¦è¡Œå›žæ•°ã€ã€Œæ¬¡å›žå®Ÿè¡Œäºˆå®šã€ã‚’æ®‹ã™ðŸ“’ðŸ–Šï¸

æœ€ä½Žã§ã‚‚ã“ã‚“ãªæ„Ÿã˜ã‚’æŒã¤ã¨é‹ç”¨ã—ã‚„ã™ã„ðŸ‘‡

* attemptCountï¼ˆä½•å›žç›®ï¼Ÿï¼‰ðŸ”¢
* nextRetryAtï¼ˆæ¬¡ã¯ã„ã¤ï¼Ÿï¼‰ðŸ—“ï¸
* lastErrorï¼ˆæœ€å¾Œã®å¤±æ•—ç†ç”±ï¼‰ðŸ§¯
* statusï¼ˆRETRYING / FAILED ãªã©ï¼‰ðŸš¦

---

## 6) ãƒãƒƒã‚¯ã‚ªãƒ•ï¼‹ã‚¸ãƒƒã‚¿ãƒ¼ã®å®šç•ªï¼šFull Jitterï¼ˆè¶…ã‚ˆãä½¿ã†ï¼‰ðŸŽ²ðŸ“‰

AWSã®è§£èª¬ã§ã¯ã€ã‚¸ãƒƒã‚¿ãƒ¼ã®å…¥ã‚Œæ–¹ã¨ã—ã¦ **Full Jitter** ã¿ãŸã„ãªãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ãŒç´¹ä»‹ã•ã‚Œã¦ã‚‹ã‚ˆâœ¨([Amazon Web Services, Inc.][4])

```mermaid
graph TD
    subgraph Constant ["ã‚¸ãƒƒã‚¿ãƒ¼ãªã— (é€£æ‰“) ðŸ’¥"]
        direction LR
        R1[è¤‡æ•°äººãŒ] -- åŒæ™‚ã« --> R2[å†è©¦è¡Œ]
    end
    subgraph Jitter ["ã‚¸ãƒƒã‚¿ãƒ¼ã‚ã‚Š (åˆ†æ•£) âœ…"]
        direction LR
        J1[è¤‡æ•°äººãŒ] -- ãƒãƒ©ãƒãƒ©ã« --> J2[å†è©¦è¡Œ]
    end
```

ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆã–ã£ãã‚Šï¼‰ðŸ‘‡

* æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã§ä¸Šé™ã¾ã§å¢—ã‚„ã™ï¼ˆcapã‚ã‚Šï¼‰ðŸ“ˆðŸ§¢
* ãã®ç¯„å›²å†…ã§ãƒ©ãƒ³ãƒ€ãƒ ãªå¾…ã¡æ™‚é–“ã«ã™ã‚‹ðŸŽ²

---

## 7) TypeScriptã§â€œä½¿ã„å›žã›ã‚‹â€ãƒªãƒˆãƒ©ã‚¤é–¢æ•°ã‚’ä½œã‚ã†ðŸ§‘â€ðŸ’»ðŸ’–

### 7-1) ã‚¨ãƒ©ãƒ¼åˆ†é¡žï¼ˆãƒªãƒˆãƒ©ã‚¤ã™ã‚‹ï¼Ÿã—ãªã„ï¼Ÿï¼‰ðŸ§©

HTTPã‚’æƒ³å®šã™ã‚‹ãªã‚‰ã€ã¨ã‚Šã‚ãˆãšã“ã®æ–¹é‡ãŒå®‰å…¨å¯„ã‚ŠðŸ‘‡

* 408 / 429 / 5xx â†’ ãƒªãƒˆãƒ©ã‚¤å€™è£œâœ…
* ãã‚Œä»¥å¤– â†’ åŽŸå› ä¿®æ­£ãƒ»è£œå„Ÿãƒ»å¤±æ•—ç¢ºå®šã¸âŒ([Google Cloud Documentation][2])

```mermaid
graph TD
    subgraph Log ["Sagaãƒ­ã‚° & è©¦è¡Œå±¥æ­´ ðŸ“’"]
        A[attemptCount: 3]
        B[nextRetryAt: 14:00:05]
        C[lastError: Timeout]
    end
```

### 7-2) å®Ÿè£…ä¾‹ï¼ˆæŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼‹Full Jitterï¼‰ðŸ”ðŸŽ²

```typescript
type RetryDecision =
  | { ok: true }
  | { ok: false; reason: string };

type RetryOptions = {
  maxAttempts: number;       // åˆè¨ˆè©¦è¡Œå›žæ•°ï¼ˆä¾‹ï¼š5ï¼‰
  baseDelayMs: number;       // æœ€åˆã®åŸºæº–ï¼ˆä¾‹ï¼š200msï¼‰
  maxDelayMs: number;        // ä¸Šé™ï¼ˆä¾‹ï¼š30_000msï¼‰
  timeoutPerAttemptMs: number; // 1å›žã‚ãŸã‚Šã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆä¾‹ï¼š2_000msï¼‰
  // ã‚‚ã—å¤–ã‹ã‚‰ä¸­æ–­ã—ãŸã„ã¨ãï¼ˆSagaå…¨ä½“ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç­‰ï¼‰
  signal?: AbortSignal;
  // ãƒ†ã‚¹ãƒˆã—ã‚„ã™ãã™ã‚‹ãŸã‚ã€ä¹±æ•°ã‚’å·®ã—æ›¿ãˆã‚‰ã‚Œã‚‹ã‚ˆã†ã«
  rng?: () => number;
};

function sleep(ms: number, signal?: AbortSignal): Promise<void> {
  return new Promise((resolve, reject) => {
    if (signal?.aborted) return reject(new Error("aborted"));

    const t = setTimeout(resolve, ms);
    const onAbort = () => {
      clearTimeout(t);
      reject(new Error("aborted"));
    };

    signal?.addEventListener("abort", onAbort, { once: true });
  });
}

// Full Jitter: 0ã€œcap ã®ç¯„å›²ã§ãƒ©ãƒ³ãƒ€ãƒ 
function fullJitterDelayMs(
  attemptIndex: number, // 0,1,2...
  baseDelayMs: number,
  maxDelayMs: number,
  rng: () => number
): number {
  const exp = baseDelayMs * Math.pow(2, attemptIndex);
  const cap = Math.min(exp, maxDelayMs);
  return Math.floor(rng() * cap);
}

// ä¾‹ï¼šHTTPã£ã½ã„ã‚¨ãƒ©ãƒ¼åˆ¤å®šï¼ˆå¿…è¦ã«å¿œã˜ã¦æ‹¡å¼µã—ã¦OKï¼‰
function shouldRetryHttpStatus(status: number): RetryDecision {
  if (status === 408 || status === 429) return { ok: true };
  if (status >= 500 && status <= 599) return { ok: true };
  return { ok: false, reason: `non-retryable status: ${status}` };
}

// 1å›žã®è©¦è¡Œã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ä»˜ã‘ã‚‹
async function withTimeout<T>(p: Promise<T>, ms: number, signal?: AbortSignal): Promise<T> {
  const timeout = new Promise<never>((_, reject) => {
    const t = setTimeout(() => reject(new Error("timeout")), ms);
    if (signal) {
      signal.addEventListener("abort", () => {
        clearTimeout(t);
        reject(new Error("aborted"));
      }, { once: true });
    }
  });
  return Promise.race([p, timeout]);
}

export async function withRetry<T>(
  runOnce: (attempt: number) => Promise<T>,
  decideRetry: (err: unknown) => RetryDecision,
  opt: RetryOptions
): Promise<T> {
  const rng = opt.rng ?? Math.random;

  for (let attempt = 1; attempt <= opt.maxAttempts; attempt++) {
    try {
      // 1å›žã®è©¦è¡Œè‡ªä½“ã‚’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã§åŒºåˆ‡ã‚‹
      return await withTimeout(runOnce(attempt), opt.timeoutPerAttemptMs, opt.signal);
    } catch (err) {
      // æœ€å¾Œã®å¤±æ•—ã¯ãã®ã¾ã¾æŠ•ã’ã‚‹
      if (attempt === opt.maxAttempts) throw err;

      const decision = decideRetry(err);
      if (!decision.ok) throw err;

      // æ¬¡ã®å¾…ã¡ï¼ˆFull Jitterï¼‰
      const attemptIndex = attempt - 1; // 1å›žç›®å¤±æ•—å¾Œ=0
      const delay = fullJitterDelayMs(attemptIndex, opt.baseDelayMs, opt.maxDelayMs, rng);

      // ã“ã“ã§ãƒ­ã‚°ï¼šattempt / delay / err ãªã©ã‚’å‡ºã™ã¨é‹ç”¨ã—ã‚„ã™ã„
      await sleep(delay, opt.signal);
    }
  }

  // ã“ã“ã«ã¯æ¥ãªã„æƒ³å®š
  throw new Error("unreachable");
}
```

---

## 8) Sagaã®Stepã«å½“ã¦ã¯ã‚ã‚‹ã¨ã“ã†ãªã‚‹ã‚ˆðŸ§©ðŸš¶â€â™€ï¸ðŸ”

ä¾‹ï¼šStepã€Œåœ¨åº«ç¢ºä¿ã€ã‚’å‘¼ã¶ã¨ãã«ã€å¸ä»¤å¡”å´ã§ã“ã†åŒ…ã‚€ã‚¤ãƒ¡ãƒ¼ã‚¸ðŸ‘‡

* Stepæœ¬ä½“ã¯â€œç´”ç²‹ã«å‡¦ç†ã™ã‚‹â€
* ãƒªãƒˆãƒ©ã‚¤å›žæ•°ãƒ»é–“éš”ã¯â€œå¸ä»¤å¡”ãŒæ±ºã‚ã‚‹â€
* å†ªç­‰ã‚­ãƒ¼ã§äºŒé‡å®Ÿè¡Œã‚’é˜²ãï¼ˆç¬¬16ã€œ17ç« ã®è€ƒãˆæ–¹ï¼‰ðŸ”‘âœ¨

ãƒªãƒˆãƒ©ã‚¤ãŒå°½ããŸã‚‰ã€ãã“ã§åˆã‚ã¦ã€Œè£œå„Ÿã¸é€²ã‚€ã€ã€Œå¤±æ•—ã§æ­¢ã‚ã‚‹ã€ã€Œäººã«æ¸¡ã™ã€ã¿ãŸã„ã«åˆ†å²ã™ã‚‹ã‚ˆðŸ§¯ðŸ§‘â€ðŸ’¼

---

## 9) â€œã‚„ã‚ŠãŒã¡äº‹æ•…â€å›³é‘‘ ðŸ˜‡â†’ðŸ˜±

### äº‹æ•…â‘ ï¼šãƒãƒƒã‚¯ã‚ªãƒ•ãªã—ã§é€£æ‰“ðŸ”«ðŸ’¥

å³ãƒªãƒˆãƒ©ã‚¤é€£æ‰“ã¯ã€ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰éšœå®³ï¼ˆé€£éŽ–çš„ã«è½ã¡ã‚‹ï¼‰ã‚’èµ·ã“ã—ã‚„ã™ã„â€¦ï¼
Google Cloudã‚‚ã€Œãƒãƒƒã‚¯ã‚ªãƒ•ãªã—ãƒªãƒˆãƒ©ã‚¤ã¯ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³ã€ã£ã¦æ³¨æ„ã—ã¦ã‚‹ã‚ˆâš ï¸([Google Cloud Documentation][2])

### äº‹æ•…â‘¡ï¼šå†ªç­‰ã˜ã‚ƒãªã„å‡¦ç†ã‚’ç„¡æ¡ä»¶ãƒªãƒˆãƒ©ã‚¤ðŸ§¨

ã€Œå‰Šé™¤ã€ã€Œä¸Šæ›¸ãã€ã€Œæ±ºæ¸ˆã€ã¿ãŸã„ãªå‰¯ä½œç”¨ç³»ã¯å±é™ºðŸ’£
â€œå†ªç­‰æ€§ã®æ¡ä»¶ã‚’ç†è§£ã—ã¦ã€ç„¡æ¡ä»¶ãƒªãƒˆãƒ©ã‚¤ã—ãªã„ã§ã­â€ã£ã¦æ˜Žè¨€ã•ã‚Œã¦ã‚‹ã‚ˆðŸ“Œ([Google Cloud Documentation][2])

### äº‹æ•…â‘¢ï¼šå„ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå‹æ‰‹ã«ãƒªãƒˆãƒ©ã‚¤ã—ã¦è² è·ãŒæŽ›ã‘ç®—ðŸ“›

ã€ŒAãŒ3å›žã€Bã‚‚3å›žã€Cã‚‚3å›žã€ã¿ãŸã„ã«ç©ã¿é‡ãªã‚‹ã¨ã€ä¸‹æµãŒã¨ã‚“ã§ã‚‚ãªã„ã“ã¨ã«â€¦ðŸ˜±
AWSã®ä¾‹ãŒã¾ã•ã«ã“ã‚Œâš ï¸([Amazon Web Services, Inc.][1])

### äº‹æ•…â‘£ï¼šRetry-After ã‚’ç„¡è¦–ã™ã‚‹ðŸ™ˆ

503ãªã©ã§ã€ŒRetry-Afterï¼ˆä½•ç§’å¾Œã«è©¦ã—ã¦ã­ï¼‰ã€ãŒè¿”ã‚‹å ´åˆãŒã‚ã‚‹ã‚ˆã€‚
ã“ã†ã„ã†ãƒ’ãƒ³ãƒˆãŒã‚ã‚‹ãªã‚‰ã€ãã‚Œã«åˆã‚ã›ã‚‹ã®ãŒè³¢ã„è¨­è¨ˆâœ¨([Microsoft Learn][3])

---

## 10) ç« æœ«ãƒŸãƒ‹æ¼”ç¿’ðŸ“ðŸ’–

1. ä¸Šã® **withRetry** ã‚’è‡ªåˆ†ã®Sagaã®Stepå‘¼ã³å‡ºã—ã«1ã¤ã ã‘é©ç”¨ã—ã¦ã¿ã‚ˆã†ðŸ”
2. å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½œã£ã¦ã€ãƒ­ã‚°ã« **attempt / delay / error** ã‚’å‡ºã—ã¦ã¿ã‚ˆã†ðŸ‘€ðŸ§¾
3. 429ç›¸å½“ï¼ˆæ··é›‘ï¼‰ã‚’æƒ³å®šã—ã¦ã€å¾…ã¡ãŒä¼¸ã³ã¦ã„ãã®ã‚’ç¢ºèªã—ã‚ˆã†ðŸ“‰ðŸŽ²
4. ã€Œæœ€å¾Œã¾ã§å¤±æ•—ã—ãŸã‚‰è£œå„Ÿã¸ã€ã¾ã§ã¤ãªã’ã¦ã¿ã‚ˆã†ðŸ§¯âœ¨

---

## 11) ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆâœ…âœ¨ï¼ˆã“ã®ç« ã®ã‚´ãƒ¼ãƒ«ï¼‰

* ä¸€æ™‚çš„ã‚¨ãƒ©ãƒ¼ã ã‘ã‚’ãƒªãƒˆãƒ©ã‚¤å¯¾è±¡ã«ã§ãã‚‹ðŸŒ¦ï¸
* ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‹ãƒãƒƒã‚¯ã‚ªãƒ•ï¼‹ã‚¸ãƒƒã‚¿ãƒ¼ã®ä¸‰ç‚¹ã‚»ãƒƒãƒˆã§çµ„ã‚ã‚‹â°ðŸ“ˆðŸŽ²([Microsoft Learn][3])
* â€œç·æ™‚é–“â€ã‚’æ„è­˜ã—ã¦å›žæ•°ã¨é–“éš”ã‚’æ±ºã‚ã‚‰ã‚Œã‚‹â³ðŸŽ¯([Microsoft Learn][3])
* Sagaã§ã¯ã€Œå¸ä»¤å¡”ã§ãƒªãƒˆãƒ©ã‚¤åˆ¶å¾¡ã€ã€Œå¤šæ®µãƒªãƒˆãƒ©ã‚¤å›žé¿ã€ã‚’æ„è­˜ã§ãã‚‹ðŸŽ»ðŸš¦([Amazon Web Services, Inc.][1])

[1]: https://aws.amazon.com/builders-library/timeouts-retries-and-backoff-with-jitter/ "Timeouts, retries and backoff with jitter"
[2]: https://docs.cloud.google.com/storage/docs/retry-strategy "Retry strategy Â |Â  Cloud Storage Â |Â  Google Cloud Documentation"
[3]: https://learn.microsoft.com/en-us/azure/well-architected/design-guides/handle-transient-faults "Recommendations for handling transient faults - Microsoft Azure Well-Architected Framework | Microsoft Learn"
[4]: https://aws.amazon.com/blogs/architecture/exponential-backoff-and-jitter/ "Exponential Backoff And Jitter | AWS Architecture Blog"
