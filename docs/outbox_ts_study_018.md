# ç¬¬18ç« ï¼šé †åºï¼ˆOrderingï¼‰ã‚’ã©ã†æ‰±ã†ï¼ŸğŸ±â¡ï¸ğŸ±

## ã“ã®ç« ã®ã‚´ãƒ¼ãƒ«ğŸ¯âœ¨

* ã€Œé †åºãŒå¤§äº‹ãªã‚±ãƒ¼ã‚¹ã€ã¨ã€Œãã“ã¾ã§è¦ã‚‰ãªã„ã‚±ãƒ¼ã‚¹ã€ã‚’è¦‹åˆ†ã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹ğŸ™‚ğŸ‘
* Outboxã§èµ·ããŒã¡ãªâ€œé †åºå´©ã‚Œâ€ã®åŸå› ã‚’çŸ¥ã£ã¦ã€å¯¾ç­–ã®é¸æŠè‚¢ã‚’æŒã¦ã‚‹ã‚ˆã†ã«ãªã‚‹ğŸ§ ğŸ”§
* ã„ã¡ã°ã‚“ç¾å®Ÿçš„ãª **ã€ŒåŒã˜IDï¼ˆä¾‹ï¼šæ³¨æ–‡IDï¼‰ã ã‘é †åºã‚’å®ˆã‚‹ã€** å®Ÿè£…ã®å‹ã‚’ä½œã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹ğŸ“¦ğŸ”âœ…

---

## 18-1. é †åºãŒå´©ã‚Œã‚‹ã¨ä½•ãŒå›°ã‚‹ã®ï¼ŸğŸ˜µâ€ğŸ’«ğŸ’¥
![outbox_ts_study_018_order_vs_chaos.png](./picture/outbox_ts_study_018_order_vs_chaos.png)


é †åºã£ã¦ã€ã–ã£ãã‚Šè¨€ã†ã¨ **ã€Œèµ·ããŸé †ã«å±Šã„ã¦ã»ã—ã„ã€** ã£ã¦ã“ã¨ã ã‚ˆã­ğŸ“©âœ¨
ã§ã‚‚ã€é †åºãŒå´©ã‚Œã‚‹ã¨ã“ã†ãªã‚‹ğŸ‘‡

## ä¾‹ï¼šæ³¨æ–‡ã‚¤ãƒ™ãƒ³ãƒˆğŸ›’ğŸ“¦

```mermaid
graph LR
    subgraph Lane1 ["Lane 1 (Order A)"]
        A1["1. Placed"] --> A2["2. Paid"] --> A3["3. Shipped"]
    end
    subgraph Lane2 ["Lane 2 (Order B)"]
        B1["1. Placed"] --> B2["2. Paid"] --> B3["3. Shipped"]
    end
```

![lanes](./picture/outbox_ts_study_018_lanes.png)
* `OrderPaid`ï¼ˆæ”¯æ‰•ã„å®Œäº†ğŸ’³âœ…ï¼‰ãŒå…ˆã«å±Šã
* ãã®å¾Œã« `OrderPlaced`ï¼ˆæ³¨æ–‡ç¢ºå®šğŸ§¾âœ…ï¼‰ãŒå±Šã

å—ã‘å´ãŒã€Œæ³¨æ–‡ãŒå­˜åœ¨ã—ãªã„ã®ã«æ”¯æ‰•ã„å®Œäº†â€¦ï¼Ÿã€ã£ã¦ãªã‚‹ğŸŒ€ğŸ˜‡
çµæœã¨ã—ã¦â€¦

* ã‚¨ãƒ©ãƒ¼ã§è½ã¡ã‚‹ğŸ’¥
* å¤‰ãªä¸­é–“çŠ¶æ…‹ã«ãªã‚‹ğŸ˜±
* å¾Œç¶šã®å‡¦ç†ãŒè©°ã¾ã‚‹ğŸš§

---

## 18-2. ã€Œé †åºã€ã«ã¯ãƒ¬ãƒ™ãƒ«ãŒã‚ã‚‹ã‚ˆğŸ“¶ğŸ™‚

é †åºã£ã¦å®Ÿã¯3æ®µéšãã‚‰ã„ã§è€ƒãˆã‚‹ã¨ãƒ©ã‚¯ã ã‚ˆğŸ€

## A) å…¨ä½“é †åºï¼ˆå…¨éƒ¨ãœã‚“ã¶1åˆ—ã«ä¸¦ã¶ï¼‰ğŸš‚
![outbox_ts_study_018_global_ordering.png](./picture/outbox_ts_study_018_global_ordering.png)


* ã©ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚‚ **1æœ¬ã®åˆ—** ã§é †ç•ªé€šã‚Š
* å¼·ã„ã‘ã©ã€ã ã„ãŸã„é‡ã„ï¼ˆã‚¹ã‚±ãƒ¼ãƒ«ã—ã¥ã‚‰ã„ï¼‰ğŸ¥²

## B) ã‚­ãƒ¼å˜ä½é †åºï¼ˆåŒã˜IDã ã‘é †åºã‚’å®ˆã‚‹ï¼‰ğŸ”‘ğŸ±

* ä¾‹ï¼š**åŒã˜æ³¨æ–‡IDã ã‘é †ç•ªé€šã‚Š**
* Outboxè¨­è¨ˆã§ã„ã¡ã°ã‚“â€œä½¿ã„ã©ã“ã‚â€ãŒå¤šã„âœ¨

## C) å¤šå°‘ã®å‰å¾Œã¯OKï¼ˆå—ã‘å´ã§å¸åã™ã‚‹ï¼‰ğŸ§½âœ¨

* ã€Œæœ€çµ‚çš„ã«åˆãˆã°OKã€ãªã‚„ã¤
* å†ªç­‰æ€§ï¼ˆç¬¬17ç« ï¼‰ã¨ç›¸æ€§â—ğŸ›¡ï¸ğŸ”

---

## 18-3. ã¾ãšä»•åˆ†ã‘ã—ã‚ˆã†âš–ï¸âœ…ã€Œé †åºãŒå¿…è¦ã€åˆ¤å®šãƒã‚§ãƒƒã‚¯

æ¬¡ã®ã©ã‚Œã‹ã«å½“ã¦ã¯ã¾ã£ãŸã‚‰ã€é †åºãŒå¿…è¦ã«ãªã‚Šã‚„ã™ã„ã‚ˆğŸ‘‡

* **åŒã˜IDã®çŠ¶æ…‹é·ç§»**ï¼ˆä¾‹ï¼šæ³¨æ–‡ï¼šä½œæˆâ†’æ”¯æ‰•ã„â†’ç™ºé€ï¼‰ğŸ“¦â¡ï¸ğŸšš
* å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆãŒ **å‰ã®ã‚¤ãƒ™ãƒ³ãƒˆã®å‰æ** ã«ãªã£ã¦ã‚‹ï¼ˆä¾‹ï¼šä½œæˆã•ã‚Œã¦ã‹ã‚‰æ›´æ–°ï¼‰ğŸ§©
* å—ã‘å´ãŒã€Œå­˜åœ¨ãƒã‚§ãƒƒã‚¯ã€ã‚„ã€Œå‰çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ã€ã‚’å¼·ãã—ã¦ã‚‹ğŸ”’
* â€œå–ã‚Šæ¶ˆã—â€ã‚„â€œæˆ»ã—â€ãŒçµ¡ã‚€ï¼ˆä¾‹ï¼šã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰ğŸš«ğŸ”™

é€†ã«ã€é †åºãŒä¸è¦ã«ãªã‚Šã‚„ã™ã„ã®ã¯ğŸ‘‡

* ãŸã ã®é€šçŸ¥ï¼ˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ğŸ“§ï¼‰ã¿ãŸã„ã«ã€Œå¤šå°‘å‰å¾Œã—ã¦ã‚‚è‡´å‘½çš„ã˜ã‚ƒãªã„ã€
* ã€Œä¸Šæ›¸ãã—ã¦æœ€çµ‚çŠ¶æ…‹ã«å¯„ã›ã‚Œã°è‰¯ã„ã€ã‚¿ã‚¤ãƒ—ï¼ˆä¾‹ï¼šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åŒæœŸï¼‰ğŸª„

---

## 18-4. Outboxãªã®ã«é †åºãŒå´©ã‚Œã‚‹ã®ã¯ãªãœï¼ŸğŸ¤”ğŸŒ€

Outboxã¯ã€Œé€ä¿¡æ¼ã‚Œã€ã‚’å¼·ãé˜²ã’ã‚‹ä»•çµ„ã¿ã ã‘ã©ğŸ“¦ğŸ›¡ï¸ã€**é †åº**ã¯åˆ¥å•é¡Œã«ãªã‚‹ã“ã¨ãŒã‚ã‚‹ã‚ˆğŸ™‚

## å´©ã‚Œãƒã‚¤ãƒ³ãƒˆâ‘ ï¼šè¤‡æ•°Publisherã§ä¸¦åˆ—å‡¦ç†ğŸ‘¯â€â™€ï¸
![outbox_ts_study_018_race_condition.png](./picture/outbox_ts_study_018_race_condition.png)


åŒæ™‚ã«æ‹¾ã£ã¦é€ã‚‹ã¨ã€é€ä¿¡ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒã‚ºãƒ¬ã‚‹â±ï¸ğŸ’¨
ï¼ˆç¬¬14ç« ã®â€œä¸¦è¡Œå®Ÿè¡Œâ€ã®ä¸–ç•Œï¼‰

## å´©ã‚Œãƒã‚¤ãƒ³ãƒˆâ‘¡ï¼šãƒªãƒˆãƒ©ã‚¤ãŒæ··ã–ã‚‹ğŸ”ğŸŒ§ï¸

å…ˆã«é€ã£ãŸã‚„ã¤ãŒå¤±æ•—â†’é…ã‚Œã¦å†é€ã€ã¿ãŸã„ã« **å¤±æ•—ãŒé †åºã‚’æ›²ã’ã‚‹** ğŸ˜‡

## å´©ã‚Œãƒã‚¤ãƒ³ãƒˆâ‘¢ï¼šé€ä¿¡å…ˆã®â€œé †åºä¿è¨¼â€ã¯ç¯„å›²ãŒã‚ã‚‹ğŸ“¬

ãŸã¨ãˆã° **Kafka** ã¯ã€ŒåŒã˜ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³å†…ã¯é †åºOKã€åˆ¥ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³é–“ã¯ä¿è¨¼ã—ãªã„ã€ã‚¿ã‚¤ãƒ—ã§æœ‰åã ã‚ˆğŸ“Œ([Confluent][1])
ã ã‹ã‚‰ã€ŒåŒã˜ã‚­ãƒ¼ã‚’åŒã˜ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«å¯„ã›ã‚‹ã€ï¼partition key ãŒå¤§äº‹ã«ãªã‚‹ğŸ—ï¸([Confluent][1])

**Amazon SQS FIFO** ã‚‚ã€ŒMessageGroupId å˜ä½ã§é †åºã‚’å®ˆã‚‹ã€è¨­è¨ˆã ã‚ˆğŸ“®ğŸ”‘([AWS ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][2])

**RabbitMQ** ã¯åŸºæœ¬çš„ã«ã‚­ãƒ¥ãƒ¼ã¯é †åºã‚’ä¿ã¨ã†ã¨ã™ã‚‹ã‘ã©ã€è¤‡æ•°ã‚³ãƒ³ã‚·ãƒ¥ãƒ¼ãƒã‚„å†é…é€ï¼ˆredeliveryï¼‰ã§â€œçµ¶å¯¾â€ã«ã¯ãªã‚‰ãªã„ã€ã¿ãŸã„ãªæ³¨æ„ãŒã‚ã‚‹ã‚ˆğŸ°ğŸ“©([rabbitmq.com][3])

---

## 18-5. çµè«–ï¼šãŠã™ã™ã‚ã®åŸºæœ¬æ–¹é‡âœ¨ï¼ˆè¿·ã£ãŸã‚‰ã“ã‚Œï¼‰

## âœ… æ–¹é‡1ï¼šé †åºä¿è¨¼ã¯ã€Œå¿…è¦ãªã‚­ãƒ¼ã ã‘ã€ã«çµã‚‹ğŸ”‘

* ã ã„ãŸã„ **æ³¨æ–‡ID / ãƒ¦ãƒ¼ã‚¶ãƒ¼ID / åœ¨åº«SKU** ã¿ãŸã„ãªâ€œä¸»èªâ€ãŒã‚­ãƒ¼ã«ãªã‚‹ã‚ˆğŸ™‚

## âœ… æ–¹é‡2ï¼šå—ã‘å´ã¯ã€Œé †åºãŒå´©ã‚Œã¦ã‚‚å£Šã‚Œãªã„ã€ä½œã‚Šã‚’æ··ãœã‚‹ğŸ›¡ï¸

* å†ªç­‰æ€§ï¼ˆç¬¬17ç« ï¼‰ï¼‹ã€Œå¤ã„ã‚¤ãƒ™ãƒ³ãƒˆã¯ç„¡è¦–ã€ã¿ãŸã„ãªå®‰å…¨ç­–ã‚’å…¥ã‚Œã‚‹ã¨å¼·ã„ğŸ’ªâœ¨

---

## 18-6. å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³â‘ ï¼šé †åºã‚’æ°—ã«ã—ãªã„ï¼ˆæœ€çµ‚çŠ¶æ…‹ã§å‹ã¤ï¼‰ğŸğŸ§½

## ä½¿ã„ã©ã“ã‚ğŸ™†â€â™€ï¸

* é€šçŸ¥ç³»ğŸ“§
* çŠ¶æ…‹åŒæœŸï¼ˆæœ€å¾Œã®çŠ¶æ…‹ãŒæ­£ã—ã‘ã‚Œã°OKï¼‰ğŸ”„

## ã‚³ãƒ„âœ¨

* payloadã« `occurredAt`ï¼ˆç™ºç”Ÿæ™‚åˆ»ï¼‰ã‚„ `version` ã‚’å…¥ã‚Œã‚‹
* å—ã‘å´ã§ã€Œå¤ã„æ›´æ–°ãªã‚‰æ¨ã¦ã‚‹ã€ãƒ«ãƒ¼ãƒ«ã«ã™ã‚‹ğŸ—‘ï¸

### ä¾‹ï¼šå—ã‘å´ã®ã‚¬ãƒ¼ãƒ‰ï¼ˆè¶…ãƒŸãƒ‹ï¼‰ğŸ§ 

```ts
type IncomingEvent = {
  entityId: string;
  version: number;      // å˜èª¿å¢—åŠ ï¼ˆä¾‹ï¼šæ³¨æ–‡ã®æ›´æ–°å›æ•°ï¼‰
  payload: unknown;
};

type StoredState = { entityId: string; lastVersion: number };

function shouldApply(current: StoredState, incoming: IncomingEvent): boolean {
  // åŒã˜ or å¤ã„ã‚‚ã®ã¯æ¨ã¦ã‚‹ï¼ˆå†ªç­‰ï¼‹é †åºå´©ã‚Œè€æ€§ï¼‰
  return incoming.version > current.lastVersion;
}
```

---

## 18-7. å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³â‘¡ï¼šåŒã˜IDï¼ˆä¾‹ï¼šæ³¨æ–‡IDï¼‰ã ã‘é †åºã‚’å®ˆã‚‹ğŸ±â¡ï¸ğŸ±ï¼ˆæœ¬å‘½âœ¨ï¼‰

## ã¾ãšè¨­è¨ˆã‚’â€œè¨€èªåŒ–â€ã—ã‚ˆã†ğŸ§ âœ¨

* **streamKey**ï¼šé †åºã‚’å®ˆã‚ŠãŸã„å˜ä½ï¼ˆä¾‹ï¼š`orderId`ï¼‰
* **streamSeq**ï¼šãã®streamKeyå†…ã§ã®é€£ç•ªï¼ˆä¾‹ï¼šæ³¨æ–‡ã®çŠ¶æ…‹é·ç§»ã®ç•ªå·ï¼‰
* **lane**ï¼šstreamKeyã‚’ã€Œè»Šç·šã€ã«æŒ¯ã‚Šåˆ†ã‘ã‚‹ç•ªå·ï¼ˆä¸¦åˆ—åŒ–ã®ãŸã‚ï¼‰ğŸš—ğŸš—ğŸš—

> ã€Œé †åºã¯ streamKey å†…ã ã‘ã€
> ã€Œä¸¦åˆ—åŒ–ã¯ lane å˜ä½ã€
> ã“ã®è€ƒãˆæ–¹ãŒè¶…å¼·ã„ã‚ˆğŸ™‚ğŸ’ª

---

## 18-8. Outboxãƒ†ãƒ¼ãƒ–ãƒ«ã«è¶³ã™ã¨å¼·ã„ã‚«ãƒ©ãƒ æ¡ˆğŸ§¾âœ¨
![outbox_ts_study_018_stream_columns.png](./picture/outbox_ts_study_018_stream_columns.png)


æœ€å°ï¼ˆç¬¬9ç« ï¼‰ã«ã€é †åºã®ãŸã‚ã«ã“ã‚Œã‚’è¶³ã™ã‚¤ãƒ¡ãƒ¼ã‚¸ğŸ‘‡

* `stream_key`ï¼šä¾‹ `order:123` ğŸ§·
* `stream_seq`ï¼š1,2,3â€¦ ğŸ”¢
* `lane`ï¼š0..N-1 ğŸš¦
* `locked_until`ï¼šãƒ¯ãƒ¼ã‚«ãƒ¼ãŒä¸€æ™‚çš„ã«ç¢ºä¿ã™ã‚‹æ™‚é–“ï¼ˆãƒªãƒ¼ã‚¹ï¼‰â³
* `status`ï¼š`pending` / `processing` / `sent` / `failed` ğŸš¦

---

## 18-9. ã€Œlaneï¼ˆè»Šç·šï¼‰ã€ã§â€œé †åºÃ—ã‚¹ã‚±ãƒ¼ãƒ«â€ã‚’ä¸¡ç«‹ã™ã‚‹ğŸš—ğŸ’¨
![outbox_ts_study_018_lane_distribution.png](./picture/outbox_ts_study_018_lane_distribution.png)


## ãªãœlaneãŒåŠ¹ãã®ï¼ŸğŸ¤”

* å…¨ã‚¤ãƒ™ãƒ³ãƒˆã‚’1åˆ—ã«ã™ã‚‹ã¨è©°ã¾ã‚‹ğŸš§
* ã§ã‚‚ã€Œæ³¨æ–‡ã”ã¨ã«1åˆ—ã€ãªã‚‰åŒæ™‚ã«ã„ã£ã±ã„èµ°ã‚Œã‚‹ğŸš—ğŸš—ğŸš—âœ¨
* ãã“ã§ã€æ³¨æ–‡IDã‚’ãƒãƒƒã‚·ãƒ¥ã—ã¦ lane ã«æŒ¯ã‚Šåˆ†ã‘ã‚‹ï¼ˆ=è«–ç†çš„ãªåˆ†å‰²ï¼‰ğŸ”€

ã“ã‚Œã¯Kafkaã®ã€Œã‚­ãƒ¼ã§åŒã˜ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«å¯„ã›ã‚‹ã€ç™ºæƒ³ã¨ä¼¼ã¦ã‚‹ã‚ˆğŸ§ ğŸ“Œ([Confluent][1])
SQS FIFO ã® MessageGroupId ã‚‚åŒã˜ç³»çµ±ã ã‚ˆğŸ“®ğŸ”‘([AWS ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][2])

---

## 18-10. ãƒãƒ³ã‚ºã‚ªãƒ³ï¼šlaneä»˜ãOutbox Publisherï¼ˆTypeScriptï¼‰ğŸ› ï¸âœ¨

ã“ã“ã‹ã‚‰ã¯ã€ŒPublisherï¼ˆé€ä¿¡ä¿‚ï¼‰ã€å´ã®å‹ã‚’ä½œã‚‹ã‚ˆğŸ“¤ğŸ™‚
DBã¯â€œSQLã§å–ã‚Œã‚‹â€å‰æã§ã€ã‚¯ã‚¨ãƒªã®å½¢ã‚’è¦‹ã›ã‚‹ã­ğŸ‘€

## â‘  laneã‚’æ±ºã‚ã‚‹é–¢æ•°ï¼ˆå®‰å®šãƒãƒƒã‚·ãƒ¥ï¼‰ğŸ”¢ğŸ”§

```ts
// ã‹ã‚“ãŸã‚“FNV-1aï¼ˆååˆ†å®‰å®šãªã‚‰OKï¼‰
function fnv1a32(input: string): number {
  let hash = 0x811c9dc5;
  for (let i = 0; i < input.length; i++) {
    hash ^= input.charCodeAt(i);
    hash = Math.imul(hash, 0x01000193);
  }
  return hash >>> 0;
}

function laneOf(streamKey: string, laneCount: number): number {
  return fnv1a32(streamKey) % laneCount;
}
```

## â‘¡ â€œæ¬¡ã«é€ã‚‹ã¹ã1ä»¶â€ã‚’å®‰å…¨ã«ç¢ºä¿ã™ã‚‹ï¼ˆã‚¤ãƒ¡ãƒ¼ã‚¸SQLï¼‰ğŸ”’ğŸ§²

è¤‡æ•°ãƒ¯ãƒ¼ã‚«ãƒ¼ãŒã„ã¦ã‚‚äºŒé‡å–ã‚Šã—ãªã„ãŸã‚ã«ã€`FOR UPDATE SKIP LOCKED` ã¿ãŸã„ãªä»•çµ„ã¿ãŒã‚ˆãä½¿ã‚ã‚Œã‚‹ã‚ˆğŸ”([Netdata][4])
ãŸã ã—ã€ãƒ­ãƒƒã‚¯ã‚„åˆ†é›¢ãƒ¬ãƒ™ãƒ«ã§æƒ³å®šå¤–ã®æŒ™å‹•ãŒå‡ºã‚‹è©±ã‚‚ã‚ã‚‹ã®ã§ã€**æ¤œè¨¼ã—ãªãŒã‚‰**ãŒå¤§äº‹ã ã‚ˆğŸ§ª([CYBERTEC PostgreSQL | Services & Support][5])

### ãƒã‚¤ãƒ³ãƒˆğŸ¯

* laneã‚’å›ºå®šã—ãŸãƒ¯ãƒ¼ã‚«ãƒ¼ãŒã€laneå†…ã® `pending` ã‚’é †ã«å‡¦ç†
* `ORDER BY stream_seq` ã§ã€ŒåŒã˜streamKeyã®é †åºã€ã‚’å®ˆã‚‹
* ã§ã‚‚ laneå†…ã«ã¯è¤‡æ•°streamKeyãŒæ··ã–ã‚‹ã®ã§ã€**å„streamKeyã®å…ˆé ­ã ã‘å–ã‚‹** ã®ãŒã‚³ãƒ„ğŸ™‚

ï¼ˆSQLã¯DBæ–¹è¨€ãŒã‚ã‚‹ã®ã§â€œå½¢â€ã¨ã—ã¦è¦‹ã¦ã­ï¼‰

```sql
-- lane = :lane ã®ãƒ¯ãƒ¼ã‚«ãƒ¼ãŒã€å‡¦ç†å¯èƒ½ãª1ä»¶ã‚’ç¢ºä¿ã™ã‚‹ä¾‹ï¼ˆã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰
WITH candidate AS (
  SELECT o.*
  FROM outbox o
  WHERE o.status = 'pending'
    AND o.lane = :lane
    AND (o.locked_until IS NULL OR o.locked_until < now())
  ORDER BY o.stream_key, o.stream_seq
  FOR UPDATE SKIP LOCKED
  LIMIT 1
)
UPDATE outbox u
SET status = 'processing',
    locked_until = now() + interval '30 seconds'
FROM candidate c
WHERE u.id = c.id
RETURNING u.*;
```

## â‘¢ TypeScriptå´ï¼ˆã–ã£ãã‚Šéª¨æ ¼ï¼‰ğŸ¦´âœ¨

```ts
type OutboxRow = {
  id: string;
  streamKey: string;
  streamSeq: number;
  lane: number;
  eventType: string;
  payload: unknown;
  status: "pending" | "processing" | "sent" | "failed";
};

type Db = {
  claimNext(lane: number): Promise<OutboxRow | null>;
  markSent(id: string): Promise<void>;
  markFailed(id: string, reason: string): Promise<void>;
};

type Sender = {
  send(row: OutboxRow): Promise<void>;
};

export async function runWorkerLoop(db: Db, sender: Sender, lane: number): Promise<void> {
  for (;;) {
    const row = await db.claimNext(lane);
    if (!row) {
      await sleep(200); // ã¡ã‚‡ã„å¾…ã¤ğŸ˜´
      continue;
    }

    try {
      // ã“ã“ã§ã€Œé€ä¿¡å…ˆã€ã« streamKey ã‚’ã‚­ãƒ¼ã¨ã—ã¦æ¸¡ã™ã¨ã€
      // é€ä¿¡å…ˆå´ï¼ˆKafka partition key / SQS MessageGroupIdï¼‰ã¨ã‚‚ç›¸æ€§â—ğŸ”‘
      await sender.send(row);
      await db.markSent(row.id);
    } catch (e) {
      const reason = e instanceof Error ? e.message : String(e);
      await db.markFailed(row.id, reason);
    }
  }
}

function sleep(ms: number) {
  return new Promise<void>((r) => setTimeout(r, ms));
}
```

---

## 18-11. é€ä¿¡å…ˆåˆ¥ï¼šé †åºã‚’å®ˆã‚‹â€œã‚­ãƒ¼ã®æ¸¡ã—æ–¹â€ğŸ”‘ğŸ“¬

## Kafkaã®å ´åˆğŸ§©

* åŒã˜ã‚­ãƒ¼ã‚’åŒã˜ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã¸ â†’ **ãã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³å†…ã§é †åºãŒä¿ãŸã‚Œã‚„ã™ã„**
* ã¤ã¾ã‚Š `key = streamKey` ãŒåŸºæœ¬ã«ãªã‚‹ã‚ˆğŸ™‚([Confluent][1])

## SQS FIFOã®å ´åˆğŸ“®

* `MessageGroupId = streamKey` ã«ã™ã‚‹ã¨ã€ãã®ã‚°ãƒ«ãƒ¼ãƒ—å†…ã®é †åºã‚’ç¶­æŒã§ãã‚‹ã‚ˆâœ¨([AWS ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][2])

## RabbitMQã®å ´åˆğŸ°

* 1ã‚­ãƒ¥ãƒ¼1ã‚³ãƒ³ã‚·ãƒ¥ãƒ¼ãƒã«å¯„ã›ã‚‹ã¨é †åºãŒç´ ç›´ã«ãªã‚Šã‚„ã™ã„ã‘ã©ã€ä¸¦åˆ—åŒ–ã¨ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ãŒã‚ã‚‹ã‚ˆâš–ï¸([rabbitmq.com][3])

---

## 18-12. ãã‚Œã§ã‚‚â€œå—ã‘å´ã‚¬ãƒ¼ãƒ‰â€ã¯å…¥ã‚Œã‚ˆã†ğŸ›¡ï¸ğŸ™‚ï¼ˆä¿é™ºâœ¨ï¼‰
![outbox_ts_study_018_receiver_guard.png](./picture/outbox_ts_study_018_receiver_guard.png)


é †åºã‚’å®ˆã‚‹è¨­è¨ˆã§ã‚‚ã€ç¾å®Ÿã¯ã€Œå†é€ã€ã€Œéšœå®³ã€ã€Œå†é…é€ã€ãªã©ãŒã‚ã‚‹ã‹ã‚‰ã­ğŸŒ§ï¸ğŸ”
ãªã®ã§å—ã‘å´ã§ã“ã‚Œã‚’å…¥ã‚Œã‚‹ã¨äº‹æ•…ãŒæ¸›ã‚‹ã‚ˆğŸ‘‡

## å—ã‘å´ã®å®šç•ªã‚¬ãƒ¼ãƒ‰âœ…

* `lastProcessedSeq` ã‚’DBã«ä¿å­˜
* `incoming.streamSeq <= lastProcessedSeq` ã¯æ¨ã¦ã‚‹ï¼ˆå†ªç­‰ï¼‰ğŸ—‘ï¸
* `incoming.streamSeq == last+1` ã ã‘é©ç”¨âœ¨
* `incoming.streamSeq > last+1` ãŒæ¥ãŸã‚‰â€¦

  * ã„ã£ãŸã‚“ä¿ç•™ï¼ˆstashï¼‰ã—ã¦ã€Œå¾…ã¤ã€ã‹
  * â€œæ¬ ç•ªãŒæ¥ãªã„å‰æâ€ã®è¨­è¨ˆã«ã™ã‚‹ï¼ˆé€ä¿¡å´ã§é †åºä¿è¨¼ã‚’å¼·ãã™ã‚‹ï¼‰ğŸ§ 

---

## 18-13. ã‚ˆãã‚ã‚‹è½ã¨ã—ç©´ğŸ˜‡ğŸ•³ï¸

## è½ã¨ã—ç©´â‘ ï¼šå…¨éƒ¨ã«é †åºä¿è¨¼ã‚’ã‹ã‘ã¦è©°ã¾ã‚‹ğŸš§

* å…¨ä½“é †åºã¯è¶…ç°¡å˜ã ã‘ã©ã€é…å»¶ãŒç©ã¿ä¸ŠãŒã‚Šã‚„ã™ã„ğŸ¥²
* ã¾ãšã¯ **ã‚­ãƒ¼å˜ä½** ã«çµã‚‹ã®ãŒã‚³ã‚¹ãƒ‘è‰¯ã„âœ¨

## è½ã¨ã—ç©´â‘¡ï¼šé †åºã ã‘å®ˆã£ã¦å†ªç­‰æ€§ã‚’æ¨ã¦ã‚‹ğŸ’¥

* â€œçµ¶å¯¾é †åºâ€ãªã‚“ã¦é‹ç”¨ã§ã¯å´©ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹
* å†ªç­‰æ€§ï¼ˆç¬¬17ç« ï¼‰ã¯ã‚»ãƒƒãƒˆã§æŒã¤ã®ãŒå®‰å…¨ğŸ›¡ï¸ğŸ”

## è½ã¨ã—ç©´â‘¢ï¼šãƒ­ãƒƒã‚¯/åˆ†é›¢ãƒ¬ãƒ™ãƒ«ã®æ€ã„è¾¼ã¿ğŸ§ ğŸ’£

`FOR UPDATE` ç³»ã¯ä¾¿åˆ©ã ã‘ã©ã€åˆ†é›¢ãƒ¬ãƒ™ãƒ«ãªã©ã§æ„å¤–ãªæŒ™å‹•ãŒèµ·ãã‚‹ã“ã¨ãŒã‚ã‚‹ã‚ˆğŸ§ª([CYBERTEC PostgreSQL | Services & Support][5])
ï¼ˆãªã®ã§ãƒ†ã‚¹ãƒˆã§ä¸¦åˆ—ã‚’ã—ã£ã‹ã‚Šå›ã™ã®ãŒå¤§äº‹ğŸ’ªï¼‰

---

## 18-14. æ¼”ç¿’ãƒŸãƒ‹èª²é¡ŒğŸ“ğŸ‰

## èª²é¡ŒAï¼šé †åºãŒå¿…è¦ã‹åˆ¤å®šã—ã‚ˆã†âš–ï¸

æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆã€é †åºå¿…è¦ï¼Ÿï¼ˆç†ç”±ã‚‚ä¸€è¨€ã§ï¼‰ğŸ™‚

1. `OrderPlaced` â†’ `OrderPaid`
2. `EmailSent` â†’ `PushSent`
3. `UserProfileUpdated(name)` â†’ `UserProfileUpdated(icon)`

## èª²é¡ŒBï¼šstreamè¨­è¨ˆã—ã¦ã¿ã‚ˆã†ğŸ”‘ğŸ”¢

æ³¨æ–‡ID = `O-100` ã®ã‚¤ãƒ™ãƒ³ãƒˆåˆ—ã‚’è€ƒãˆã¦ã€`streamSeq` ã‚’æŒ¯ã£ã¦ã¿ã¦ã­ğŸ‘‡

* æ³¨æ–‡ç¢ºå®š
* æ”¯æ‰•ã„å®Œäº†
* ç™ºé€é–‹å§‹
* é…é”å®Œäº†

## èª²é¡ŒCï¼šlaneæ•°ã‚’æ±ºã‚ã‚ˆã†ğŸš¦

* laneCount = 4 / 8 / 16 ã®ã©ã‚Œã«ã™ã‚‹ï¼Ÿ
* ã€Œå¢—ã‚„ã™ã¨ä½•ãŒå¬‰ã—ã„ï¼Ÿ ä½•ãŒå›°ã‚‹ï¼Ÿã€ã‚’ç®‡æ¡æ›¸ãã§ğŸ™‚âœï¸

---

## 18-15. AIæ´»ç”¨ãƒŸãƒ‹å‹ï¼ˆã“ã®ç« å°‚ç”¨ï¼‰ğŸ¤–âœ¨

## 1) ã€Œé †åºãŒå¿…è¦ãªã‚¤ãƒ™ãƒ³ãƒˆã ã‘ã€æ´—ã„å‡ºã—ğŸ”

* ã€Œã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã‚’è²¼ã‚‹ â†’ é †åºãŒå¿…è¦ãªçµ„ã ã‘æŠ½å‡ºã—ã¦ã€ã£ã¦é ¼ã‚€ã¨é€Ÿã„ğŸ’¨

## 2) streamKeyå€™è£œã®ææ¡ˆğŸ§ 

* ã€Œæ³¨æ–‡ç³»ã¯ orderIdã€åœ¨åº«ç³»ã¯ skuã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ç³»ã¯ userId ã§è‰¯ã„ï¼Ÿã€ã¿ãŸã„ã«ç›¸è«‡ã™ã‚‹ã®ãŒâ—ğŸ™‚

## 3) ä¸¦åˆ—ãƒ†ã‚¹ãƒˆæ¡ˆã‚’ä½œã£ã¦ã‚‚ã‚‰ã†ğŸ§ª

* ã€Œ2ãƒ¯ãƒ¼ã‚«ãƒ¼/4ãƒ¯ãƒ¼ã‚«ãƒ¼ã§ã€é †åºã¨äºŒé‡é€ä¿¡ãŒèµ·ããªã„ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã€ã‚’å‡ºã—ã¦ã‚‚ã‚‰ã†ã¨å¼·ã„ğŸ’ªâœ¨

---

## 18-16. ã¾ã¨ã‚ğŸ“¦âœ…

* é †åºã¯ **å…¨éƒ¨ã«ä¿è¨¼ã—ãªã„** ã®ãŒã‚³ãƒ„ğŸ™‚
* ã ã„ãŸã„ã¯ **ã€ŒåŒã˜IDï¼ˆstreamKeyï¼‰ã ã‘é †åºã€** ãŒæœ¬å‘½ğŸ±â¡ï¸ğŸ±
* é€ä¿¡å…ˆï¼ˆKafka/SQS FIFOãªã©ï¼‰ã‚‚ **ã‚­ãƒ¼å˜ä½ã®é †åº** ãŒåŸºæœ¬æ€æƒ³ã ã‚ˆğŸ”‘([Confluent][1])
* æœ€å¾Œã«ã€å†ªç­‰æ€§ï¼‹å—ã‘å´ã‚¬ãƒ¼ãƒ‰ã¯â€œä¿é™ºâ€ã˜ã‚ƒãªãã¦â€œæ¨™æº–è£…å‚™â€ğŸ›¡ï¸ğŸ”

---

## ï¼ˆè±†çŸ¥è­˜ï¼‰2026å¹´ã®TypeScriptã¾ã‚ã‚Šå°ãƒã‚¿ğŸ§âœ¨

* TypeScriptã¯ã€ŒGoã§ã®ãƒã‚¤ãƒ†ã‚£ãƒ–å®Ÿè£…ï¼ˆTypeScript 7ï¼‰ã€ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå…¬é–‹ã•ã‚Œã¦ã€ãƒ“ãƒ«ãƒ‰é«˜é€ŸåŒ–ï¼ˆå¤§è¦æ¨¡ã§10å€ç´šã‚’ã†ãŸã†è©±ï¼‰ãªã©ãŒè©±é¡Œã«ãªã£ã¦ã‚‹ã‚ˆâš¡([Microsoft Developer][6])
* Node.jsã¯ v24 ãŒ Active LTSã€v25 ãŒ Current ã¨ã„ã†ä½ç½®ã¥ã‘ã«ãªã£ã¦ã‚‹ã‚ˆğŸŸ©([nodejs.org][7])

[1]: https://www.confluent.io/learn/kafka-partition-key/?utm_source=chatgpt.com "Apache Kafka Partition Key: A Comprehensive Guide"
[2]: https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/using-messagegroupid-property.html?utm_source=chatgpt.com "Using the message group ID with Amazon SQS FIFO Queues"
[3]: https://www.rabbitmq.com/blog/2020/06/23/quorum-queues-local-delivery?utm_source=chatgpt.com "How quorum queues deliver locally while still offering ..."
[4]: https://www.netdata.cloud/academy/update-skip-locked/?utm_source=chatgpt.com "Using FOR UPDATE SKIP LOCKED for Queue-Based ..."
[5]: https://www.cybertec-postgresql.com/en/transaction-anomalies-with-select-for-update/?utm_source=chatgpt.com "Transaction anomalies with SELECT FOR UPDATE"
[6]: https://developer.microsoft.com/blog/typescript-7-native-preview-in-visual-studio-2026?utm_source=chatgpt.com "TypeScript 7 native preview in Visual Studio 2026"
[7]: https://nodejs.org/en/about/previous-releases?utm_source=chatgpt.com "Node.js Releases"
