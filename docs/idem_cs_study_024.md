# ç¬¬24ç« ï¼šä»•ä¸Šã’ï¼ˆãƒ†ã‚¹ãƒˆãƒ»è¦³æ¸¬ãƒ»ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆãƒ»å’æ¥­èª²é¡Œï¼‰ğŸ“âœ¨
![ç¬¬24ç« ï¼šä»•ä¸Šã’](./picture/idem_cs_study_024_graduation_summary.png)


## 24.0 ã“ã®ç« ã®ã‚´ãƒ¼ãƒ«ğŸ¯

ã“ã®ç« ã§ã¯ã€å†ªç­‰æ€§ã‚’ã€Œå®Ÿè£…ã—ãŸæ°—ãŒã™ã‚‹ã€ã‹ã‚‰ã€Œå£Šã‚Œãªã„ã£ã¦è¨¼æ˜ã§ãã‚‹ğŸ’ªã€ã«ä»•ä¸Šã’ã¾ã™âœ¨
ã‚„ã‚‹ã“ã¨ã¯4ã¤ã ã‘ğŸ‘‡

* **ãƒ†ã‚¹ãƒˆ**ã§å£Šã‚Œãªã„ã®ã‚’ç¢ºèªã™ã‚‹âœ…
* **è¦³æ¸¬ï¼ˆãƒ­ã‚°/ãƒˆãƒ¬ãƒ¼ã‚¹/ãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼‰**ã§å£Šã‚ŒãŸæ™‚ã«ç§’é€Ÿã§è¿½ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ğŸ”
* **ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ**ã§è¦‹è½ã¨ã—ã‚’ã‚¼ãƒ­ã«è¿‘ã¥ã‘ã‚‹ğŸ§¾
* **å’æ¥­èª²é¡Œ**ã§ã€Œå®Ÿå‹™ã£ã½ã„å®Œæˆå½¢ã€ã«ã™ã‚‹ğŸ

---

## 24.1 å†ªç­‰æ€§ãƒ†ã‚¹ãƒˆã®å…¨ä½“åƒï¼ˆ3å±¤ã§å®ˆã‚‹ï¼‰ğŸ›¡ï¸ğŸ§ª

![å†ªç­‰æ€§ãƒ†ã‚¹ãƒˆã®ãƒ”ãƒ©ãƒŸãƒƒãƒ‰](./picture/idem_cs_study_024_testing_pyramid.png)

å†ªç­‰æ€§ã¯ã€**ã€Œ1å›ãªã‚‰å‹•ãã€ã˜ã‚ƒãƒ€ãƒ¡**ã§ã€ã“ã†ã„ã†â€œç¾å®Ÿâ€ã«è€ãˆã‚‹å¿…è¦ãŒã‚ã‚‹ã‚ˆã­ğŸ˜‡

* åŒã˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒ **2å›/10å›** æ¥ã‚‹ğŸ”
* ã»ã¼åŒæ™‚ã« **ä¸¦åˆ—ã§** æ¥ã‚‹ğŸï¸ğŸ’¥
* é€”ä¸­ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¦ **æˆåŠŸãªã®ã«å¤±æ•—æ‰±ã„** ã«ãªã‚‹âŒ›

ã ã‹ã‚‰ãƒ†ã‚¹ãƒˆã‚‚3å±¤ã§ã„ãã®ãŒç‹é“âœ¨

1. **å˜ä½“ãƒ†ã‚¹ãƒˆ**ï¼šå†ªç­‰ã‚­ãƒ¼ã®åˆ¤å®šãƒ«ãƒ¼ãƒ«ï¼ˆåŒä¸€/å·®åˆ†/æœŸé™åˆ‡ã‚Œãªã©ï¼‰ã‚’å°ã•ãæ¤œè¨¼
2. **çµ±åˆãƒ†ã‚¹ãƒˆ**ï¼šHTTPã§å©ã„ã¦ã€APIã¨ã—ã¦å†ªç­‰ã«è¦‹ãˆã‚‹ã‹ç¢ºèªï¼ˆTestServerï¼‰([Microsoft Learn][1])
3. **ä¸¦åˆ—ãƒ†ã‚¹ãƒˆ**ï¼šåŒæ™‚ã‚¢ã‚¯ã‚»ã‚¹ã§â€œ1ä»¶ã«åæŸâ€ã™ã‚‹ã‹ç¢ºèªğŸ

---

## 24.2 çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆHTTPã§â€œå†ªç­‰ã«è¦‹ãˆã‚‹ã‹â€ã‚’ä¿è¨¼ã™ã‚‹ï¼‰ğŸ“®âœ…

ASP.NET Core ã®çµ±åˆãƒ†ã‚¹ãƒˆã¯ã€**ã‚¢ãƒ—ãƒªã‚’ãƒ†ã‚¹ãƒˆç”¨ã«èµ·å‹•ã—ã¦ HttpClient ã§å©ã**ã®ãŒå®šç•ªã ã‚ˆã€œâœ¨
`WebApplicationFactory<T>` ãŒãã®ãŸã‚ã®ä»•çµ„ã¿ã‚’ç”¨æ„ã—ã¦ãã‚Œã¦ã¾ã™([Microsoft Learn][2])

### 24.2.1 ãƒ†ã‚¹ãƒˆã§æœ€ä½é™ãƒã‚§ãƒƒã‚¯ã—ãŸã„3æœ¬æŸ±ğŸ§±

#### âœ… (A) åŒã˜ã‚­ãƒ¼ + åŒã˜æœ¬æ–‡ â†’ åŒã˜çµæœ

* 1å›ç›®ï¼šæ³¨æ–‡ä½œæˆï¼ˆorderId ãŒè¿”ã‚‹ï¼‰
* 2å›ç›®ï¼šåŒã˜ `Idempotency-Key` ã§å†é€ â†’ **åŒã˜ orderId ãŒè¿”ã‚‹**ï¼ˆå†å®Ÿè¡Œã—ãªã„ï¼‰

#### âœ… (B) åŒã˜ã‚­ãƒ¼ + é•ã†æœ¬æ–‡ â†’ è¡çªã¨ã—ã¦æ­¢ã‚ã‚‹ï¼ˆä¾‹ï¼š409ï¼‰

* â€œåŒã˜ãƒã‚±ãƒƒãƒˆã§åˆ¥ã®å†…å®¹â€ã¯å±é™ºâš ï¸ï¼ˆæ”»æ’ƒãƒ»ãƒã‚°ãƒ»èª¤å®Ÿè£…ã®æ¸©åºŠï¼‰

#### âœ… (C) é€£æ‰“ï¼ˆ10å›ï¼‰ã§ã‚‚ç ´ç¶»ã—ãªã„

* æˆåŠŸå›æ•°ã¯1å›ã€çµæœã¯10å›åŒã˜ã€ãŒç†æƒ³âœ¨

---

### 24.2.2 ã‚µãƒ³ãƒ—ãƒ«ï¼šxUnit + WebApplicationFactory ã§å†ªç­‰æ€§ã‚’çµ±åˆãƒ†ã‚¹ãƒˆğŸ”ğŸ§ª

> ä¾‹ï¼š`POST /orders` ã« `Idempotency-Key` ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä»˜ã‘ã‚‹æƒ³å®š
> ï¼ˆçµ±åˆãƒ†ã‚¹ãƒˆã®åœŸå°ã¨ã—ã¦ `Microsoft.AspNetCore.Mvc.Testing` ã‚’ä½¿ã†ã‚ˆï¼‰([NuGet][3])

```csharp
using System.Net;
using System.Net.Http.Json;
using Microsoft.AspNetCore.Mvc.Testing;
using Xunit;

public class IdempotencyTests : IClassFixture<WebApplicationFactory<Program>>
{
    private readonly HttpClient _client;

    public IdempotencyTests(WebApplicationFactory<Program> factory)
    {
        _client = factory.CreateClient();
    }

    [Fact]
    public async Task SameKey_SameBody_ReturnsSameResult()
    {
        var key = Guid.NewGuid().ToString("N");

        var body = new
        {
            customerId = "C-001",
            items = new[] { new { sku = "SKU-AAA", qty = 1 } }
        };

        // 1å›ç›®
        var req1 = new HttpRequestMessage(HttpMethod.Post, "/orders")
        {
            Content = JsonContent.Create(body)
        };
        req1.Headers.Add("Idempotency-Key", key);

        var res1 = await _client.SendAsync(req1);
        res1.EnsureSuccessStatusCode();

        var json1 = await res1.Content.ReadFromJsonAsync<OrderResponse>();
        Assert.NotNull(json1);

        // 2å›ç›®ï¼ˆå†é€ï¼‰
        var req2 = new HttpRequestMessage(HttpMethod.Post, "/orders")
        {
            Content = JsonContent.Create(body)
        };
        req2.Headers.Add("Idempotency-Key", key);

        var res2 = await _client.SendAsync(req2);
        res2.EnsureSuccessStatusCode();

        var json2 = await res2.Content.ReadFromJsonAsync<OrderResponse>();
        Assert.NotNull(json2);

        Assert.Equal(json1!.orderId, json2!.orderId);
    }

    [Fact]
    public async Task SameKey_DifferentBody_ReturnsConflict()
    {
        var key = Guid.NewGuid().ToString("N");

        var body1 = new { customerId = "C-001", items = new[] { new { sku = "SKU-AAA", qty = 1 } } };
        var body2 = new { customerId = "C-999", items = new[] { new { sku = "SKU-BBB", qty = 9 } } };

        // 1å›ç›®
        var req1 = new HttpRequestMessage(HttpMethod.Post, "/orders") { Content = JsonContent.Create(body1) };
        req1.Headers.Add("Idempotency-Key", key);

        var res1 = await _client.SendAsync(req1);
        res1.EnsureSuccessStatusCode();

        // 2å›ç›®ï¼ˆã‚­ãƒ¼åŒã˜ãƒ»æœ¬æ–‡é•ã„ï¼‰
        var req2 = new HttpRequestMessage(HttpMethod.Post, "/orders") { Content = JsonContent.Create(body2) };
        req2.Headers.Add("Idempotency-Key", key);

        var res2 = await _client.SendAsync(req2);

        Assert.Equal(HttpStatusCode.Conflict, res2.StatusCode);
    }

    private sealed record OrderResponse(string orderId);
}
```

---

## 24.3 ä¸¦åˆ—ãƒ†ã‚¹ãƒˆï¼ˆâ€œåŒæ™‚ã«æ¥ãŸã‚‰1ä»¶ã«åæŸâ€ã‚’ç¢ºèªï¼‰ğŸï¸ğŸ’¥âœ…

å†ªç­‰æ€§ã®æœ¬ç•ªãƒã‚¤ãƒ³ãƒˆã¯ã“ã“ï¼
**åŒã˜ã‚­ãƒ¼ãŒã»ã¼åŒæ™‚ã«2ã€œ10æœ¬æ¥ã¦ã‚‚ã€çµæœãŒ1ä»¶ã«åæŸã™ã‚‹**ã®ãŒåˆæ ¼ãƒ©ã‚¤ãƒ³ğŸ¯

### 24.3.1 ã‚µãƒ³ãƒ—ãƒ«ï¼šåŒã˜ã‚­ãƒ¼ã‚’10ä¸¦åˆ—ã§å©ãğŸ”ğŸ”ğŸ”

```csharp
using System.Net.Http.Json;
using Microsoft.AspNetCore.Mvc.Testing;
using Xunit;

public class ConcurrencyIdempotencyTests : IClassFixture<WebApplicationFactory<Program>>
{
    private readonly HttpClient _client;

    public ConcurrencyIdempotencyTests(WebApplicationFactory<Program> factory)
    {
        _client = factory.CreateClient();
    }

    [Fact]
    public async Task SameKey_Parallel10_AllReturnSameOrderId()
    {
        var key = Guid.NewGuid().ToString("N");
        var body = new
        {
            customerId = "C-001",
            items = new[] { new { sku = "SKU-AAA", qty = 1 } }
        };

        async Task<string> CallOnce()
        {
            var req = new HttpRequestMessage(HttpMethod.Post, "/orders")
            {
                Content = JsonContent.Create(body)
            };
            req.Headers.Add("Idempotency-Key", key);

            var res = await _client.SendAsync(req);
            res.EnsureSuccessStatusCode();

            var json = await res.Content.ReadFromJsonAsync<OrderResponse>();
            return json!.orderId;
        }

        var tasks = Enumerable.Range(0, 10).Select(_ => CallOnce()).ToArray();
        var results = await Task.WhenAll(tasks);

        // å…¨éƒ¨åŒã˜ orderId ãªã‚‰OKâœ¨
        Assert.True(results.Distinct().Count() == 1);
    }

    private sealed record OrderResponse(string orderId);
}
```

### 24.3.2 ä¸¦åˆ—ãƒ†ã‚¹ãƒˆãŒè½ã¡ãŸæ™‚ã®â€œã‚ã‚ŠãŒã¡åŸå› â€ğŸ˜­

* DB ã® **ä¸€æ„åˆ¶ç´„**ãŒç„¡ã„ / åŠ¹ã„ã¦ãªã„ğŸ§¨
* ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¢ƒç•ŒãŒã‚ºãƒ¬ã¦ã‚‹ğŸŒ€
* ã€Œä½œæˆã€â†’ã€Œå†ªç­‰è¨˜éŒ²ä¿å­˜ã€ã®é †ãŒé€†ã§ã€éš™é–“ãŒã‚ã‚‹ğŸ˜µ
* In-Progress ã®æ‰±ã„ãŒã‚ã„ã¾ã„ã§äºŒé‡å®Ÿè¡Œã«ãªã‚‹âš ï¸

---

## 24.4 è¦³æ¸¬ï¼ˆãƒ­ã‚°ãƒ»ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ»ãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼‰ã§â€œè¿½ãˆã‚‹å†ªç­‰æ€§â€ã«ã™ã‚‹ğŸ”ğŸ“ˆâœ¨

å†ªç­‰æ€§ã£ã¦ã€**å£Šã‚ŒãŸæ™‚ã«åŸå› ãŒè¿½ãˆãªã„ã¨é‹ç”¨ã§è©°ã‚€**ã®â€¦ğŸ˜‡
ãªã®ã§ã€Œãƒ­ã‚°ã«ä½•ã‚’å‡ºã™ã‹ã€ã‚’ä»•ä¸Šã’ã¾ã™ğŸ§°

### 24.4.1 ãƒ­ã‚°ã«å¿…ãšå‡ºã—ãŸã„3ç‚¹ã‚»ãƒƒãƒˆğŸ§¾âœ¨

* **ç›¸é–¢IDï¼ˆCorrelation IDï¼‰**ï¼š1ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¿½è·¡ã™ã‚‹ãŸã‚ã®IDğŸ§µ
* **å†ªç­‰ã‚­ãƒ¼ï¼ˆIdempotency-Keyï¼‰**ï¼šä»Šå›ã®å†ªç­‰ã®ä¸»å½¹ğŸ”‘
* **çµæœã®çŠ¶æ…‹**ï¼š`Created / Replayed / Conflict / InProgress` ã¿ãŸã„ãªåˆ†é¡ğŸ·ï¸

### 24.4.2 ã¾ãšã¯ â€œãƒ­ã‚°ã‚¹ã‚³ãƒ¼ãƒ—â€ ã§ä¸€æ°—ã«æ¥½ã™ã‚‹ğŸª„

```csharp
using System.Diagnostics;

app.Use(async (ctx, next) =>
{
    var correlationId =
        ctx.Request.Headers.TryGetValue("X-Correlation-ID", out var cid) && !string.IsNullOrWhiteSpace(cid)
            ? cid.ToString()
            : Guid.NewGuid().ToString("N");

    ctx.Response.Headers["X-Correlation-ID"] = correlationId;

    var idemKey =
        ctx.Request.Headers.TryGetValue("Idempotency-Key", out var ik) ? ik.ToString() : "(none)";

    // Activity ã¯åˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚¹ã®åŸºç¤ï¼ˆTraceIdãªã©ï¼‰ã«ã‚‚ãªã‚‹ã‚ˆâœ¨
    var traceId = Activity.Current?.TraceId.ToString() ?? "(no-trace)";

    using (logger.BeginScope(new Dictionary<string, object>
    {
        ["correlationId"] = correlationId,
        ["idempotencyKey"] = idemKey,
        ["traceId"] = traceId
    }))
    {
        await next();
    }
});
```

ã“ã‚Œã§ä»¥é™ã®ãƒ­ã‚°ã« `correlationId / idempotencyKey / traceId` ã‚’è‡ªç„¶ã«æ··ãœã‚‰ã‚Œã‚‹ğŸ‘Œâœ¨

---

## 24.5 OpenTelemetry ã§ â€œãƒˆãƒ¬ãƒ¼ã‚¹/ãƒ¡ãƒˆãƒªã‚¯ã‚¹/ãƒ­ã‚°â€ ã‚’æƒãˆã‚‹ï¼ˆæœ€çŸ­ãƒ«ãƒ¼ãƒˆï¼‰ğŸ›°ï¸âœ¨

2026å¹´æ™‚ç‚¹ã® .NET ã¯ã€**Activity/ILogger ãªã©åœŸå°ãŒãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã«ã‚ã‚Š**ã€OpenTelemetry ã¯ãã‚Œã‚’æ´»ç”¨ã™ã‚‹å½¢ã«ãªã£ã¦ã¾ã™([Microsoft Learn][4])
ASP.NET Core å´ã§ã‚‚ OpenTelemetry ã‚’ä½¿ã£ãŸå¯è¦–åŒ–ãŒå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æ¡ˆå†…ã•ã‚Œã¦ã„ã¾ã™([Microsoft Learn][5])

### 24.5.1 ã€Œã¾ãšãƒ­ãƒ¼ã‚«ãƒ«ã§å¯è¦–åŒ–ã€ã™ã‚‹ãªã‚‰ï¼šOTLP + Dashboard ãŒä¾¿åˆ©ğŸ–¥ï¸âœ¨

OTLP ã§åã„ãŸãƒ†ãƒ¬ãƒ¡ãƒˆãƒªã‚’ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§çœºã‚ã‚‹ä¾‹ãŒç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã™([Microsoft Learn][6])

> ã“ã“ã¯â€œé‹ç”¨ã®å…¥ã‚Šå£â€ãªã®ã§ã€æœ€åˆã¯ **Traceï¼ˆã©ã“ã§æ­¢ã¾ã£ãŸï¼Ÿï¼‰** ãŒè¦‹ãˆã‚Œã°OKğŸ™†â€â™€ï¸
> ãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼ˆæˆåŠŸç‡/è¡çªç‡ï¼‰ã¾ã§è¦‹ãˆã‚‹ã¨å¼·ã„ğŸ’ª

---

## 24.6 å®Ÿå‹™ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼ˆã“ã‚Œã‚’å®ˆã‚Œã°äº‹æ•…ãŒæ¿€æ¸›ã™ã‚‹ï¼‰ğŸ§¾âœ…âœ¨

### 24.6.1 APIè¨­è¨ˆãƒã‚§ãƒƒã‚¯ğŸ”‘ğŸ“®

* [ ] å†ªç­‰ã‚­ãƒ¼ã®å—ã‘å–ã‚Šå ´æ‰€ãŒæ±ºã¾ã£ã¦ã‚‹ï¼ˆä¾‹ï¼š`Idempotency-Key` ãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰
* [ ] ã‚­ãƒ¼ã®å½¢å¼ãƒ»æœ€å¤§é•·ãŒæ±ºã¾ã£ã¦ã‚‹ï¼ˆUUIDæ¨å¥¨ãªã©ï¼‰
* [ ] **åŒã˜ã‚­ãƒ¼ + æœ¬æ–‡é•ã„**ã¯è¡çªæ‰±ã„ï¼ˆ409ãªã©ï¼‰
* [ ] ã€ŒåŒã˜ã‚­ãƒ¼ã€ã¯ **åŒã˜ãƒ¬ã‚¹ãƒãƒ³ã‚¹**ã‚’è¿”ã™ï¼ˆå†å®Ÿè¡Œã—ãªã„ï¼‰

### 24.6.2 DB/æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ğŸ—ƒï¸ğŸ›¡ï¸

* [ ] å†ªç­‰è¨˜éŒ²ãƒ†ãƒ¼ãƒ–ãƒ«ã« **ä¸€æ„åˆ¶ç´„**ï¼ˆã‚­ãƒ¼+æ“ä½œç¨®åˆ¥ãªã©ï¼‰
* [ ] ç«¶åˆæ™‚ï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯é•åãªã©ï¼‰ã®å‡¦ç†ãŒã‚ã‚‹ï¼ˆæ—¢å­˜çµæœã‚’è¿”ã™ç­‰ï¼‰
* [ ] In-Progress ã®çŠ¶æ…‹ãŒã‚ã‚‹ï¼ˆä¸¦åˆ—ã§äºŒé‡å®Ÿè¡Œã—ãªã„ï¼‰
* [ ] TTLï¼ˆä¿æŒæœŸé™ï¼‰ã¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—æ–¹é‡ãŒæ±ºã¾ã£ã¦ã‚‹ğŸ§¹

### 24.6.3 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£/é‹ç”¨ãƒã‚§ãƒƒã‚¯ğŸ”’ğŸ§¯

* [ ] ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¿å­˜ã« **å€‹äººæƒ…å ±**ã‚’å…¥ã‚Œã™ããªã„ï¼ˆå¿…è¦æœ€å°é™ï¼‰
* [ ] ãƒ­ã‚°ã«æ©Ÿå¾®æƒ…å ±ã‚’å‡ºã•ãªã„ï¼ˆã‚«ãƒ¼ãƒ‰æƒ…å ±ãƒ»ç§˜å¯†ãªã©ï¼‰
* [ ] å†ªç­‰ã‚­ãƒ¼ã® **å†åˆ©ç”¨ãƒªã‚¹ã‚¯**ï¼ˆæ¨æ¸¬ã•ã‚Œãªã„/æ¼ã‚Œãªã„ï¼‰ã«é…æ…®
* [ ] ç›£è¦–ã—ãŸã„æŒ‡æ¨™ãŒæ±ºã¾ã£ã¦ã‚‹ï¼ˆä¾‹ï¼šReplayç‡ã€Conflictç‡ã€InProgressæ»ç•™ï¼‰ğŸ“ˆ

### 24.6.4 ãƒ†ã‚¹ãƒˆãƒã‚§ãƒƒã‚¯ğŸ§ªâœ…

* [ ] åŒä¸€è¦æ±‚ã‚’2å› â†’ åŒã˜çµæœ
* [ ] åŒä¸€è¦æ±‚ã‚’10å› â†’ åŒã˜çµæœ
* [ ] **10ä¸¦åˆ—** â†’ 1ä»¶ã«åæŸ
* [ ] åŒã˜ã‚­ãƒ¼ã§æœ¬æ–‡é•ã„ â†’ 409ï¼ˆã¾ãŸã¯è¨­è¨ˆã§æ±ºã‚ãŸã‚¨ãƒ©ãƒ¼ï¼‰
* [ ] ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæƒ³å®šï¼ˆç–‘ä¼¼ï¼‰ â†’ å†é€ã—ã¦ã‚‚ç ´ç¶»ã—ãªã„

### 24.6.5 è¦³æ¸¬ãƒã‚§ãƒƒã‚¯ğŸ”âœ¨

* [ ] ãƒ­ã‚°ã« `correlationId / idempotencyKey / traceId` ãŒå…¥ã£ã¦ã‚‹
* [ ] `Created / Replayed / Conflict / InProgress` ã®åˆ†é¡ãŒãƒ­ã‚°ã‹ã‚‰åˆ†ã‹ã‚‹
* [ ] è¿½è·¡ã®èµ·ç‚¹ï¼ˆç›¸é–¢IDï¼‰ãŒãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ã‚‚è¿”ã‚‹

---

## 24.7 å’æ¥­èª²é¡ŒğŸï¼šæ³¨æ–‡ä½œæˆAPIã‚’â€œå®Ÿå‹™å“è³ªâ€ã«ä»•ä¸Šã’ã‚ˆã†ğŸ›’ğŸ“

### ğŸ¯ èª²é¡Œå†…å®¹

ã€Œæ³¨æ–‡ä½œæˆAPIã€ã‚’ **å†ªç­‰ã‚­ãƒ¼æ–¹å¼**ã§å†ªç­‰åŒ–ã—ã€**ä¸¦åˆ—ã§ã‚‚1ä»¶ã«åæŸ**ã•ã›ã‚‹âœ¨
ã•ã‚‰ã« **ãƒ­ã‚°/è¦³æ¸¬**ã§è¿½ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ğŸ”

### âœ… å¿…é ˆè¦ä»¶ï¼ˆåˆæ ¼ãƒ©ã‚¤ãƒ³ï¼‰ğŸ

* [ ] `POST /orders` ãŒå†ªç­‰ã‚­ãƒ¼ã‚’å—ã‘å–ã‚‹
* [ ] åŒã˜ã‚­ãƒ¼ + åŒã˜æœ¬æ–‡ â†’ **åŒã˜çµæœ**
* [ ] åŒã˜ã‚­ãƒ¼ + æœ¬æ–‡é•ã„ â†’ **409 Conflict**ï¼ˆã¾ãŸã¯æ˜ç¢ºãªã‚¨ãƒ©ãƒ¼ï¼‰
* [ ] åŒã˜ã‚­ãƒ¼ã§10å›å†é€ â†’ çµæœãŒå…¨éƒ¨åŒã˜
* [ ] åŒã˜ã‚­ãƒ¼ã§10ä¸¦åˆ— â†’ **çµæœãŒå…¨éƒ¨åŒã˜**ï¼ˆåæŸï¼‰
* [ ] ãƒ­ã‚°ã« `correlationId / idempotencyKey / traceId` ãŒå‡ºã‚‹

### â­ åŠ ç‚¹ï¼ˆã§ããŸã‚‰å¼·ã„ï¼‰ğŸ’ªâœ¨

* [ ] In-Progress ã‚’è¡¨ç¾ã—ã€æ»ç•™ã—ãŸã‚‰æ¤œçŸ¥ã§ãã‚‹
* [ ] Replay/Conflict ã‚’ãƒ¡ãƒˆãƒªã‚¯ã‚¹åŒ–ã—ã¦ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§è¦‹ãˆã‚‹
* [ ] æœŸé™åˆ‡ã‚Œï¼ˆTTLï¼‰å¾Œã®æŒ™å‹•ãŒä»•æ§˜ã¨ã—ã¦èª¬æ˜ã§ãã‚‹

### ğŸ“ æå‡ºç‰©

* ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ï¼ˆçµ±åˆãƒ†ã‚¹ãƒˆ + ä¸¦åˆ—ãƒ†ã‚¹ãƒˆï¼‰
* å®Ÿè£…ã‚³ãƒ¼ãƒ‰ï¼ˆå†ªç­‰ã®ä¸­æ ¸ï¼‰
* ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã« â€œâœ…â€ ãŒä»˜ã„ãŸçŠ¶æ…‹ã®ãƒ¡ãƒ¢ğŸ§¾

---

## 24.8 ãƒŸãƒ‹å°ãƒ†ã‚¹ãƒˆï¼ˆ8å•ï¼‰ğŸ§ âœ¨

1. å†ªç­‰æ€§ãŒå¿…è¦ã«ãªã‚‹å…¸å‹ä¾‹ã‚’2ã¤è¨€ã£ã¦ã­ğŸ”
2. åŒã˜å†ªç­‰ã‚­ãƒ¼ã§æœ¬æ–‡ãŒé•ã†æ™‚ã€ãªãœå±é™ºï¼Ÿâš ï¸
3. ã€Œ10ä¸¦åˆ—ã§1ä»¶ã«åæŸã€ã‚’å£Šã™ã‚ã‚ŠãŒã¡ãªåŸå› ã‚’1ã¤è¨€ã£ã¦ã­ğŸï¸
4. çµ±åˆãƒ†ã‚¹ãƒˆã§ `WebApplicationFactory` ã‚’ä½¿ã†ãƒ¡ãƒªãƒƒãƒˆã¯ï¼ŸğŸ“® ([Microsoft Learn][2])
5. ãƒ­ã‚°ã«å…¥ã‚Œã‚‹ã¹ã3ç‚¹ã‚»ãƒƒãƒˆã¯ï¼ŸğŸ§¾
6. In-Progress çŠ¶æ…‹ã‚’æŒã¤ãƒ¡ãƒªãƒƒãƒˆã¯ï¼ŸğŸŒ€
7. TTLï¼ˆä¿æŒæœŸé™ï¼‰ãŒç„¡ã„ã¨ä½•ãŒèµ·ããŒã¡ï¼ŸğŸ§¹
8. è¦³æ¸¬ãŒå¼±ã„ã¨ã€å†ªç­‰æ€§ã¯ãªãœé‹ç”¨ã§è©°ã¿ãŒã¡ï¼ŸğŸ˜‡

---

## 24.9 AIæ´»ç”¨ï¼ˆCopilot/Codexï¼‰ã§ä»•ä¸Šã’ã‚’çˆ†é€Ÿã«ã™ã‚‹ğŸ¤–âš¡

### 24.9.1 ãƒ†ã‚¹ãƒˆç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹ğŸ§ª

* ã€Œ`POST /orders` ã®å†ªç­‰æ€§çµ±åˆãƒ†ã‚¹ãƒˆã‚’ xUnit + WebApplicationFactory ã§æ›¸ã„ã¦ã€‚
  åŒã˜Idempotency-Keyã§2å›é€ã‚‹ã¨åŒã˜orderIdã€æœ¬æ–‡é•ã„ã¯409ã€10ä¸¦åˆ—ã‚‚è¿½åŠ ã—ã¦ã€‚ã€

### 24.9.2 ãƒ­ã‚°æ”¹å–„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹ğŸ§¾

* ã€ŒASP.NET Coreã§ correlationId / idempotencyKey / traceId ã‚’ãƒ­ã‚°ã‚¹ã‚³ãƒ¼ãƒ—ã«å…¥ã‚Œã‚‹ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢æ¡ˆã‚’å‡ºã—ã¦ã€‚
  ã•ã‚‰ã« Created/Replayed/Conflict ã‚’ãƒ­ã‚°ã«æ®‹ã™å®Ÿè£…ä¾‹ã‚‚ã€‚ã€

### 24.9.3 Copilot ã‚’â€œãƒ†ã‚¹ãƒˆå‘ãâ€ã«ä½¿ã†ã‚³ãƒ„ğŸ’¡

* å…ˆã«ãƒ†ã‚¹ãƒˆã® **æœŸå¾…ä»•æ§˜ï¼ˆGiven/When/Thenï¼‰** ã‚’æ—¥æœ¬èªã§ç®‡æ¡æ›¸ã
* ãã‚Œã‚’ãã®ã¾ã¾è²¼ã£ã¦ç”Ÿæˆã•ã›ã‚‹
* ç”Ÿæˆå¾Œã¯ã€Œä¸¦åˆ—ã€ã€Œè¡çªã€ã€Œã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã€ã‚’è¿½åŠ ã§è¦æ±‚ã™ã‚‹âœ¨
  Visual Studio ã® Copilot ã«ã¯è£œå®Œã‚„ãƒãƒ£ãƒƒãƒˆã®ã‚¬ã‚¤ãƒ‰ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™([Microsoft Learn][7])

---

## 24.10 ãŠã¾ã‘ï¼šã„ã¾ã® .NET ã®â€œæœ€æ–°ç‰ˆâ€ãƒ¡ãƒ¢ï¼ˆ2026å¹´1æœˆæ™‚ç‚¹ï¼‰ğŸ—’ï¸âœ¨

* .NET 10 ã¯ **LTS** ã§ã€2025å¹´11æœˆãƒªãƒªãƒ¼ã‚¹ãƒ»2028å¹´11æœˆã¾ã§ã‚µãƒãƒ¼ãƒˆäºˆå®š([Microsoft][8])
* Visual Studio 2022 ã¯ 2026å¹´1æœˆæ™‚ç‚¹ã§ 17.14 ç³»ãŒç¶™ç¶šã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™([Microsoft Learn][9])

[1]: https://learn.microsoft.com/en-us/aspnet/core/test/integration-tests?view=aspnetcore-10.0&utm_source=chatgpt.com "Integration tests in ASP.NET Core"
[2]: https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1?view=aspnetcore-10.0&utm_source=chatgpt.com "WebApplicationFactory<TEntryPoint> Class"
[3]: https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Testing?utm_source=chatgpt.com "Microsoft.AspNetCore.Mvc.Testing 10.0.2"
[4]: https://learn.microsoft.com/en-us/dotnet/core/diagnostics/observability-with-otel?utm_source=chatgpt.com ".NET Observability with OpenTelemetry"
[5]: https://learn.microsoft.com/en-us/aspnet/core/log-mon/metrics/metrics?view=aspnetcore-10.0&utm_source=chatgpt.com "ASP.NET Core metrics"
[6]: https://learn.microsoft.com/ja-jp/dotnet/core/diagnostics/observability-otlp-example?utm_source=chatgpt.com "OTLP ã¨ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ Aspire Dashboard ã‚’ OpenTelemetry ..."
[7]: https://learn.microsoft.com/en-us/visualstudio/ide/visual-studio-github-copilot-get-started?view=visualstudio&utm_source=chatgpt.com "Get Started with GitHub Copilot - Visual Studio (Windows)"
[8]: https://dotnet.microsoft.com/en-us/platform/support/policy/dotnet-core?utm_source=chatgpt.com "NET and .NET Core official support policy"
[9]: https://learn.microsoft.com/en-us/visualstudio/releases/2022/release-history?utm_source=chatgpt.com "Visual Studio 2022 Release History"
