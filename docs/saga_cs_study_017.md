# ç¬¬17ç« ï¼šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¨äººé–“ã®ä»‹å…¥ï¼ˆé‹ç”¨ã«æ¸¡ã™è¨­è¨ˆï¼‰ğŸ‘©â€ğŸ’¼â°

## ä»Šæ—¥ã®ã‚´ãƒ¼ãƒ«ğŸ¯âœ¨

* SagaãŒ**æ­¢ã¾ã‚Šã£ã±ãªã—ï¼ˆæ°¸é å¾…ã¡ï¼‰**ã«ãªã‚‰ãªã„ã‚ˆã†ã«ã€**ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**ã‚’è¨­è¨ˆã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ğŸ§ 
* è‡ªå‹•ã§ç›´ã‚‰ãªã„ã¨ãã«ã€**äººãŒå®‰å…¨ã«ä»‹å…¥ã§ãã‚‹å½¢ï¼ˆé‹ç”¨ï¼‰**ã‚’ä½œã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹ğŸ›¡ï¸
* ã€Œ30åˆ†æ±ºæ¸ˆãŒæ¥ãªã‹ã£ãŸã‚‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã¿ãŸã„ãª**æ¥­å‹™ãƒ«ãƒ¼ãƒ«**ã‚’ã€çŠ¶æ…‹ã¨ã‚³ãƒ¼ãƒ‰ã«è½ã¨ã›ã‚‹ã‚ˆã†ã«ãªã‚‹ğŸ’»âœ…

---

# 1) ãã‚‚ãã‚‚Sagaã£ã¦â€œé•·ããªã‚‹â€å‰æã ã‚ˆã­ğŸ˜µâ€ğŸ’«ğŸ§©

Sagaã¯ã€Œè¤‡æ•°ã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®é€£ãªã‚Šã€ã§ã€é€”ä¸­ã§å¤±æ•—ã—ãŸã‚‰è£œå„Ÿï¼ˆå¸³å°»åˆã‚ã›ï¼‰ã™ã‚‹ä»•çµ„ã¿ã ã‚ˆã€œã€ã£ã¦è©±ã ã£ãŸã­ğŸ“šğŸ”ï¼ˆå®šç¾©ã®é›°å›²æ°—ã¯ã“ã‚ŒãŒè¿‘ã„ã‚ˆï¼‰([microservices.io][1])
ã§ã€ã“ã“ãŒé‡è¦ğŸ‘‡

* ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ»å¤–éƒ¨APIãƒ»æ±ºæ¸ˆãªã©ãŒçµ¡ã‚€ã¨ã€**å¾…ã¡æ™‚é–“ã‚„å¤±æ•—ã¯æ—¥å¸¸èŒ¶é£¯äº‹**ğŸŒ€
* ã ã‹ã‚‰Sagaã¯ã€Œé•·ãèµ°ã‚‹ã€ã“ã¨ãŒå¤šã„ï¼**ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãŒãªã„ã¨ã€æ­¢ã¾ã£ãŸã¾ã¾æ”¾ç½®**ãŒèµ·ãã‚‹ğŸ˜±
  ã€ŒSagaã¯é•·ãã¦ã‚‚ã„ã„ã‘ã©ã€ç„¡æœŸé™ã¯ãƒ€ãƒ¡ã€‚ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå…¥ã‚Œã‚‹ã®å¤§äº‹ã€ã¿ãŸã„ãªè€ƒãˆæ–¹ã¯ä¸€èˆ¬çš„ã«èªã‚‰ã‚Œã¦ã‚‹ã‚ˆâ³ğŸ§¯([Apache Camel][2])

---

# 2) ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¯2ç¨®é¡ã‚ã‚‹ã‚ˆâ±ï¸ğŸ§ 

## A. æŠ€è¡“ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆç§’ã€œåˆ†ï¼‰âš¡

ä¾‹ï¼šHTTPãŒè¿”ã£ã¦ã“ãªã„ã€DBæ¥ç¶šãŒè©°ã¾ã£ãŸã€å¤–éƒ¨APIãŒå›ºã¾ã£ãŸâ€¦ğŸ˜‡

# * ã“ã‚Œã¯ä¸»ã« **ãƒªãƒˆãƒ©ã‚¤æˆ¦ç•¥ï¼ˆç¬¬16ç« ï¼‰** ã¨ã‚»ãƒƒãƒˆã§æ‰±ã†ã“ã¨ãŒå¤šã„ã‚ˆğŸ”

**.NETã®ä¾‹ï¼ˆHTTPï¼‰**
`HttpClient.Timeout` ã¯æ—¢å®šã§ **100ç§’**ã ã‚ˆâ²ï¸ï¼ˆæ„å¤–ã¨é•·ã„ï¼ï¼‰([Microsoft Learn][3])
ãŸã ã—ã€ŒDNSè§£æ±ºã ã‘ã§æœ€å¤§15ç§’ã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚‹ã€ã¿ãŸã„ãªæ³¨æ„ã‚‚ã‚ã‚‹ã‹ã‚‰ã€çŸ­ãã—ã™ãã«ã‚‚æ³¨æ„âš ï¸([Microsoft Learn][3])

## B. æ¥­å‹™ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆåˆ†ã€œæ—¥ï¼‰ğŸ“¦ğŸ§¾

ä¾‹ï¼š

* ã€Œæ±ºæ¸ˆãŒ30åˆ†ä»¥å†…ã«ç¢ºå®šã—ãªã‘ã‚Œã°æ³¨æ–‡ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ğŸ›’ğŸ’³
* ã€Œåœ¨åº«ç¢ºä¿ãŒ10åˆ†ã§ããªã‘ã‚Œã°ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€ğŸ“¦
* ã€Œä¸æ­£æ¤œçŸ¥ã§ä¿ç•™â†’24æ™‚é–“ä»¥å†…ã«äººãŒåˆ¤æ–­ã€ğŸ‘€â°

ğŸ‘‰ ç¬¬17ç« ã®ä¸»å½¹ã¯ã“ã£ã¡ï¼âœ¨

---

## 3) â€œæ°¸é å¾…ã¡â€ã‚’ãªãã™åŸºæœ¬è¨­è¨ˆğŸ§±âœ…

ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­è¨ˆã®ã‚³ã‚¢ã¯ã“ã®3ç‚¹ã ã‚ˆğŸ‘‡

### â‘  çŠ¶æ…‹ã«ã€Œå¾…ã¡ã€ã‚’å…¥ã‚Œã‚‹ğŸ§Š

ä¾‹ï¼š

* `PendingPayment`ï¼ˆæ±ºæ¸ˆå¾…ã¡ï¼‰
* `PendingManualReview`ï¼ˆäººã®åˆ¤æ–­å¾…ã¡ï¼‰
* `TimedOut`ï¼ˆæœŸé™åˆ‡ã‚Œï¼‰

### â‘¡ æœŸé™ï¼ˆDeadlineï¼‰ã‚’ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦æŒã¤ğŸ“…

Sagaã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã“ã†ã„ã†ã®ã‚’æŒã¤ã‚¤ãƒ¡ãƒ¼ã‚¸ğŸ‘‡

* `DeadlineUtc`ï¼ˆæœŸé™ã€UTCãŒãƒ©ã‚¯âœ¨ï¼‰
* `LastUpdatedUtc`
* `State`
* `LastError`
* `RetryCount`

### â‘¢ æœŸé™ã‚’ç›£è¦–ã—ã¦ã€ŒæœŸé™åˆ‡ã‚Œã‚¤ãƒ™ãƒ³ãƒˆã€ã‚’ç™ºç«ã™ã‚‹ğŸ””

ã‚„ã‚Šæ–¹ã¯ä¸»ã«2ã¤ğŸ’¡

* **(a) ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©/é…å»¶ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**ï¼ˆã€Œ30åˆ†å¾Œã«Timeoutã‚³ãƒãƒ³ãƒ‰ã‚’æŠ•ã’ã‚‹ã€ï¼‰ğŸ“¨â³
* **(b) å®šæœŸã‚¹ã‚­ãƒ£ãƒ³**ï¼ˆ1åˆ†ã”ã¨ã«DBã‚’è¦‹ã¦æœŸé™åˆ‡ã‚Œã‚’å‡¦ç†ï¼‰ğŸ”ğŸ—„ï¸

æœ€åˆã¯(b)ãŒã‚ã‹ã‚Šã‚„ã™ã„ã‚ˆğŸ˜Šï¼ˆå¾Œã§Outboxã‚„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸åŸºç›¤ã¨çµ±åˆã—ã‚„ã™ã„ï¼‰

---

## 4) ã€Œäººé–“ã®ä»‹å…¥ã€ãŒå¿…è¦ã«ãªã‚‹ç¬é–“ã‚ã‚‹ã‚ã‚‹ğŸ‘©â€ğŸ’¼ğŸ’¥

è‡ªå‹•ã§ç›´ã‚‰ãªã„ã®ã¯ã ã„ãŸã„ã“ã®ã¸ã‚“ğŸ‘‡

* è£œå„ŸãŒå¤±æ•—ã—ã¦ã€ã©ã£ã¡ã¤ã‹ãšğŸ˜µâ€ğŸ’«ï¼ˆä¾‹ï¼šè¿”é‡‘APIãŒè½ã¡ã¦ã‚‹ï¼‰
* å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ãŒã€Œçµæœä¸æ˜ã€ğŸ¤·â€â™€ï¸ï¼ˆæ±ºæ¸ˆãŒæˆåŠŸã—ãŸã‹å¤±æ•—ã—ãŸã‹ã‚ã‹ã‚‰ãªã„ï¼‰
* ä¸æ­£/ä¾‹å¤–ã‚±ãƒ¼ã‚¹ã§åˆ¤æ–­ãŒå¿…è¦ğŸ‘€ï¼ˆé«˜é¡æ³¨æ–‡ã€ä½æ‰€ä¸å‚™ã€åœ¨åº«ãŒå¾®å¦™â€¦ï¼‰
* â€œä»•æ§˜ä¸Šâ€ äººã®æ‰¿èªãŒå¿…è¦âœ…ï¼ˆä¸ä¿¡ã‚„å¯©æŸ»ï¼‰

ã€Œå¤±æ•—ã—ãŸã‚‰å…¨éƒ¨è‡ªå‹•ã§æˆ»ã™ã€ã¯å¤¢è¦‹ãŒã¡ãªã®ã§ğŸ˜‚ã€é‹ç”¨ã«æ¸¡ã™é“ã‚’ç”¨æ„ã™ã‚‹ã®ãŒç¾å®Ÿçš„ã ã‚ˆğŸ›Ÿ
ï¼ˆæ˜”ã‹ã‚‰â€œæ‰‹å‹•ä»‹å…¥ã§å¾©æ—§ã—ã¦å†å®Ÿè¡Œâ€ã¿ãŸã„ãªè©±ã¯èªã‚‰ã‚Œã¦ã‚‹ï¼‰([Speaker Deck][4])

---

## 5) é‹ç”¨ã«æ¸¡ã™ã¨ãã®â€œå®‰å…¨ãªãƒœã‚¿ãƒ³è¨­è¨ˆâ€ğŸ›¡ï¸ğŸ§¨

äººãŒè§¦ã‚Œã‚‹ï¼äº‹æ•…ã‚Šã‚„ã™ã„ã®ã§ã€**æŠ¼ã›ã‚‹ãƒœã‚¿ãƒ³ã‚’æ…é‡ã«**ã™ã‚‹ã®ãŒè¶…å¤§äº‹ğŸ’¦

### é‹ç”¨ãƒœã‚¿ãƒ³ã®ãŠã™ã™ã‚æ§‹æˆğŸ”˜âœ¨

* âœ… **Retryï¼ˆå†å®Ÿè¡Œï¼‰**ï¼šå¤±æ•—ã—ãŸã€Œç›´å‰ã‚¹ãƒ†ãƒƒãƒ—ã€ã‚’ã‚‚ã†ä¸€å›ã‚„ã‚‹
* âœ… **Compensateï¼ˆè£œå„Ÿé–‹å§‹ï¼‰**ï¼šè£œå„Ÿãƒ•ãƒ­ãƒ¼ã¸é€²ã‚ã‚‹
* âœ… **Extend Deadlineï¼ˆæœŸé™å»¶é•·ï¼‰**ï¼šåˆ¤æ–­å¾…ã¡ã‚’å»¶é•·
* âœ… **Mark as Resolvedï¼ˆè§£æ±ºæ‰±ã„ï¼‰**ï¼šæ‰‹ä½œæ¥­ã§å¸³å°»ã‚’åˆã‚ã›ãŸã®ã§é–‰ã˜ã‚‹ï¼ˆç›£æŸ»ãƒ­ã‚°å¿…é ˆï¼‰

### ã‚„ã£ã¡ã‚ƒãƒ€ãƒ¡å¯„ã‚ŠğŸ˜‡ğŸš«

* DBã‚’ç›´æ¥UPDATEã—ã¦çŠ¶æ…‹ã ã‘å¤‰ãˆã‚‹ï¼ˆã‚ã¨ã§åœ°ç„ï¼‰ğŸ”¥
* â€œå¼·åˆ¶å®Œäº†â€ã‚’ç„¡æ¡ä»¶ã§è¨±ã™ï¼ˆä¸æ•´åˆã®æ¸©åºŠï¼‰ğŸŒ€

### æœ€ä½é™ã®å®‰å…¨è£…ç½®ğŸ§¯âœ…

* **RBACï¼ˆæ¨©é™ï¼‰**ï¼šé–²è¦§ã ã‘ / æ“ä½œOK / æ‰¿èªè€… ã¿ãŸã„ã«åˆ†ã‘ã‚‹ğŸ‘®
* **ç›£æŸ»ãƒ­ã‚°ï¼ˆèª°ãŒã„ã¤ä½•ã‚’ï¼‰**ï¼šã‚ã¨ã§èª¬æ˜ã§ãã‚‹ğŸ“œ
* **äºŒé‡å®Ÿè¡Œå¯¾ç­–**ï¼šé‹ç”¨ãƒœã‚¿ãƒ³ã‚‚å†ªç­‰ã«ğŸ”ï¼ˆç¬¬9ã€œ10ç« ã®å¿œç”¨âœ¨ï¼‰

---

## 6) å…·ä½“ä¾‹ï¼šæ³¨æ–‡Sagaï¼ˆæ±ºæ¸ˆ30åˆ†å¾…ã¡â†’æœŸé™åˆ‡ã‚Œã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰ğŸ›’ğŸ’³â°

### ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è€ƒæ…®ã—ãŸçŠ¶æ…‹é·ç§» â°âš™ï¸
```mermaid
stateDiagram-v2
    [*] --> PendingPayment
    PendingPayment --> ReservingInventory: æ”¯æ‰•ã„æˆåŠŸé€šçŸ¥
    PendingPayment --> TimedOut: æœŸé™åˆ‡ã‚Œ (30åˆ†)
    TimedOut --> Compensating: è‡ªå‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ«é–‹å§‹
    Compensating --> Compensated: å®Œäº†
    
    PendingManualReview --> ReservingInventory: äººé–“ãŒæ‰¿èª
    PendingManualReview --> Compensating: äººé–“ãŒå¦èª
```

---

* `Started` â†’ `PendingPayment` â†’ï¼ˆæ”¯æ‰•ã„OKï¼‰â†’ `ReserveInventory` â†’ `Ship` â†’ `Completed` ğŸ‰
* `PendingPayment` â†’ï¼ˆ30åˆ†çµŒéï¼‰â†’ `TimedOut` â†’ `Compensating`ï¼ˆæ³¨æ–‡å–æ¶ˆ/åœ¨åº«æˆ»ã—ï¼‰â†’ `Compensated` ğŸ§¾

---

## 7) C#ãƒŸãƒ‹å®Ÿè£…ï¼ˆæœ€å°æ§‹æˆã§ä½“æ„Ÿã™ã‚‹ï¼‰ğŸ§‘â€ğŸ’»âœ¨

ã“ã“ã§ã¯ã€ŒDBã˜ã‚ƒãªãã¦ã‚‚ç†è§£ã§ãã‚‹ã€ã‚ˆã†ã«ã€ã¾ãšã¯ **ãƒ¡ãƒ¢ãƒªå®Ÿè£…ï¼‹BackgroundService** ã§ä½œã‚‹ã‚ˆğŸ˜Š
ï¼ˆæœ¬ç•ªã¯DBã«ç½®ãæ›ãˆã‚‹ã ã‘ã€ã£ã¦å½¢ã«ã™ã‚‹ã®ãŒã‚³ãƒ„ğŸ§±ï¼‰

### 7-1. ãƒ¢ãƒ‡ãƒ«ã¨çŠ¶æ…‹ğŸŒ±

```csharp
public enum SagaState
{
    PendingPayment,
    ReservingInventory,
    Shipping,
    Completed,

    TimedOut,
    Compensating,
    Compensated,

    PendingManualReview,
    Failed
}

public sealed record OrderSaga(
    Guid SagaId,
    string OrderId,
    SagaState State,
    DateTimeOffset CreatedUtc,
    DateTimeOffset UpdatedUtc,
    DateTimeOffset? DeadlineUtc,
    string? LastError,
    int RetryCount,
    long Version
);
```

### 7-2. â€œæœŸé™åˆ‡ã‚Œã‚¹ã‚­ãƒ£ãƒ³â€ãƒ¯ãƒ¼ã‚«ãƒ¼â³ğŸ”

```csharp
using Microsoft.Extensions.Hosting;

public sealed class SagaTimeoutWorker : BackgroundService
{
    private readonly ISagaStore _store;
    private readonly TimeSpan _interval = TimeSpan.FromSeconds(30);

    public SagaTimeoutWorker(ISagaStore store) => _store = store;

    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        while (!stoppingToken.IsCancellationRequested)
        {
            var now = DateTimeOffset.UtcNow;
            var expired = _store.FindExpired(now);

            foreach (var saga in expired)
            {
                // æœŸé™åˆ‡ã‚Œå‡¦ç†ã¯ â€œçŠ¶æ…‹é·ç§»â€ ã¨ã—ã¦æ‰±ã†ã®ãŒãƒã‚¤ãƒ³ãƒˆâœ¨
                _store.TryTransitionToTimedOut(saga.SagaId, now);
            }

            await Task.Delay(_interval, stoppingToken);
        }
    }
}
```

### 7-3. ã‚¹ãƒˆã‚¢ï¼ˆè¶…ç°¡æ˜“ï¼‰ğŸ§º

```csharp
public interface ISagaStore
{
    OrderSaga CreatePendingPayment(string orderId, DateTimeOffset now, TimeSpan paymentWindow);
    OrderSaga? Get(Guid sagaId);

    IReadOnlyList<OrderSaga> FindExpired(DateTimeOffset now);

    bool ConfirmPayment(Guid sagaId, DateTimeOffset now);

    bool TryTransitionToTimedOut(Guid sagaId, DateTimeOffset now);

    // é‹ç”¨ãƒœã‚¿ãƒ³ä¾‹
    bool ExtendDeadline(Guid sagaId, DateTimeOffset now, TimeSpan extend);
    bool StartCompensation(Guid sagaId, DateTimeOffset now, string reason);
}

public sealed class InMemorySagaStore : ISagaStore
{
    private readonly object _lock = new();
    private readonly Dictionary<Guid, OrderSaga> _db = new();

    public OrderSaga CreatePendingPayment(string orderId, DateTimeOffset now, TimeSpan paymentWindow)
    {
        var saga = new OrderSaga(
            SagaId: Guid.NewGuid(),
            OrderId: orderId,
            State: SagaState.PendingPayment,
            CreatedUtc: now,
            UpdatedUtc: now,
            DeadlineUtc: now.Add(paymentWindow),
            LastError: null,
            RetryCount: 0,
            Version: 1
        );

        lock (_lock) _db[saga.SagaId] = saga;
        return saga;
    }

    public OrderSaga? Get(Guid sagaId)
    {
        lock (_lock) return _db.TryGetValue(sagaId, out var s) ? s : null;
    }

    public IReadOnlyList<OrderSaga> FindExpired(DateTimeOffset now)
    {
        lock (_lock)
        {
            return _db.Values
                .Where(s => s.State == SagaState.PendingPayment
                         && s.DeadlineUtc is not null
                         && s.DeadlineUtc <= now)
                .ToList();
        }
    }

    public bool ConfirmPayment(Guid sagaId, DateTimeOffset now)
    {
        lock (_lock)
        {
            if (!_db.TryGetValue(sagaId, out var s)) return false;
            if (s.State != SagaState.PendingPayment) return false;

            // æœ¬å½“ã¯æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆåœ¨åº«ç¢ºä¿ãªã©ï¼‰ã¸é€²ã‚ã‚‹
            _db[sagaId] = s with
            {
                State = SagaState.ReservingInventory,
                UpdatedUtc = now,
                DeadlineUtc = null,
                Version = s.Version + 1
            };
            return true;
        }
    }

    public bool TryTransitionToTimedOut(Guid sagaId, DateTimeOffset now)
    {
        lock (_lock)
        {
            if (!_db.TryGetValue(sagaId, out var s)) return false;
            if (s.State != SagaState.PendingPayment) return false;

            _db[sagaId] = s with
            {
                State = SagaState.TimedOut,
                UpdatedUtc = now,
                LastError = "Payment deadline expired",
                Version = s.Version + 1
            };
            return true;
        }
    }

    public bool ExtendDeadline(Guid sagaId, DateTimeOffset now, TimeSpan extend)
    {
        lock (_lock)
        {
            if (!_db.TryGetValue(sagaId, out var s)) return false;
            if (s.State is not (SagaState.PendingPayment or SagaState.PendingManualReview)) return false;
            if (s.DeadlineUtc is null) return false;

            _db[sagaId] = s with
            {
                DeadlineUtc = s.DeadlineUtc.Value.Add(extend),
                UpdatedUtc = now,
                Version = s.Version + 1
            };
            return true;
        }
    }

    public bool StartCompensation(Guid sagaId, DateTimeOffset now, string reason)
    {
        lock (_lock)
        {
            if (!_db.TryGetValue(sagaId, out var s)) return false;
            if (s.State is SagaState.Completed or SagaState.Compensated) return false;

            _db[sagaId] = s with
            {
                State = SagaState.Compensating,
                UpdatedUtc = now,
                LastError = reason,
                Version = s.Version + 1
            };
            return true;
        }
    }
}
```

### 7-4. Minimal APIï¼ˆé‹ç”¨ãƒœã‚¿ãƒ³ä»˜ãï¼‰ğŸ”˜ğŸ§‘â€ğŸ’¼

```csharp
using Microsoft.AspNetCore.Builder;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;

var builder = WebApplication.CreateBuilder(args);

builder.Services.AddSingleton<ISagaStore, InMemorySagaStore>();
builder.Services.AddHostedService<SagaTimeoutWorker>();

var app = builder.Build();

// æ³¨æ–‡é–‹å§‹ï¼šæ±ºæ¸ˆå¾…ã¡ï¼ˆ30åˆ†ï¼‰
app.MapPost("/orders/{orderId}/start", (string orderId, ISagaStore store) =>
{
    var saga = store.CreatePendingPayment(orderId, DateTimeOffset.UtcNow, TimeSpan.FromMinutes(30));
    return Results.Ok(new { saga.SagaId, saga.State, saga.DeadlineUtc });
});

// æ±ºæ¸ˆç¢ºå®šï¼ˆå¤–éƒ¨ã‹ã‚‰é€šçŸ¥ãŒæ¥ãŸæƒ³å®šï¼‰
app.MapPost("/payments/{sagaId:guid}/confirmed", (Guid sagaId, ISagaStore store) =>
{
    var ok = store.ConfirmPayment(sagaId, DateTimeOffset.UtcNow);
    return ok ? Results.Ok() : Results.Conflict("State mismatch or not found");
});

// çŠ¶æ…‹ç¢ºèªï¼ˆé‹ç”¨ç”»é¢ãŒå‘¼ã¶æƒ³å®šï¼‰
app.MapGet("/admin/sagas/{sagaId:guid}", (Guid sagaId, ISagaStore store) =>
{
    var saga = store.Get(sagaId);
    return saga is null ? Results.NotFound() : Results.Ok(saga);
});

// æœŸé™å»¶é•·ï¼ˆé‹ç”¨ãƒœã‚¿ãƒ³ï¼‰
app.MapPost("/admin/sagas/{sagaId:guid}/extend", (Guid sagaId, int minutes, ISagaStore store) =>
{
    var ok = store.ExtendDeadline(sagaId, DateTimeOffset.UtcNow, TimeSpan.FromMinutes(minutes));
    return ok ? Results.Ok() : Results.Conflict("Not extendable");
});

// è£œå„Ÿé–‹å§‹ï¼ˆé‹ç”¨ãƒœã‚¿ãƒ³ï¼‰
app.MapPost("/admin/sagas/{sagaId:guid}/compensate", (Guid sagaId, string reason, ISagaStore store) =>
{
    var ok = store.StartCompensation(sagaId, DateTimeOffset.UtcNow, reason);
    return ok ? Results.Ok() : Results.Conflict("Not compensatable");
});

app.Run();
```

> ãƒã‚¤ãƒ³ãƒˆğŸ’¡ï¼šæœ¬ç•ªé‹ç”¨ã§ã¯ã€ã“ã“ã« **ç›£æŸ»ãƒ­ã‚°** ã¨ **å†ªç­‰ã‚­ãƒ¼**ï¼ˆé‹ç”¨ãƒœã‚¿ãƒ³é€£æ‰“å¯¾ç­–ğŸ˜‚ï¼‰ã‚’è¶³ã—ã¦ã„ãæ„Ÿã˜ã«ãªã‚‹ã‚ˆğŸ›¡ï¸âœ¨

---

## 8) HTTPã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆæŠ€è¡“ï¼‰ã‚‚æ³¨æ„ã—ã‚ˆã€œâš ï¸ğŸ“¡

Sagaã®å„ã‚¹ãƒ†ãƒƒãƒ—ã§å¤–éƒ¨HTTPã‚’å©ããªã‚‰ã€æœ€ä½é™ã“ã‚Œã ã‘ã¯æŠ¼ã•ãˆãŸã„ğŸ‘‡

* å…¨ä½“ã®æ—¢å®šå€¤ã¨ã—ã¦ `HttpClient.Timeout` ã‚’æŠŠæ¡ï¼ˆæ—¢å®š100ç§’ï¼‰([Microsoft Learn][3])
* ã•ã‚‰ã«ã€Œã“ã®1å›ã ã‘çŸ­ãã—ãŸã„ã€ã¯ `CancellationTokenSource` ã§**ãƒªã‚¯ã‚¨ã‚¹ãƒˆå˜ä½ã®ç· åˆ‡**ã‚’ä½œã‚‹ğŸ§¨
* ãƒªãƒˆãƒ©ã‚¤ã‚„ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼ã¯ â€œå›å¾©æ€§ï¼ˆResilienceï¼‰â€ ã®ä»•çµ„ã¿ã§ã¾ã¨ã‚ã‚‹ã¨ãƒ©ã‚¯ğŸ’–
  .NETã§ã¯ `Microsoft.Extensions.Http.Resilience` ãªã©ãŒæ¡ˆå†…ã•ã‚Œã¦ã‚‹ã‚ˆğŸ“¦([Microsoft Learn][5])

---

## 9) ãƒŸãƒ‹æ¼”ç¿’ï¼šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼†äººæ‰‹ä»‹å…¥ãƒ«ãƒ¼ãƒ«ã‚’æ±ºã‚ã‚ˆã†ğŸ“ğŸ’—

æ¬¡ã®è¡¨ã‚’ã€è‡ªåˆ†ã®æƒ³å®šã‚¢ãƒ—ãƒªã§åŸ‹ã‚ã¦ã¿ã¦ã­ğŸ˜Š
ï¼ˆæ­£è§£ã¯ãªã„ã‘ã©ã€ŒæœŸé™ã€ã¨ã€Œæ¬¡ã®è¡Œå‹•ã€ãŒæ±ºã¾ã£ã¦ã‚‹ã®ãŒæ­£ç¾©âœ¨ï¼‰

| å¾…ã£ã¦ã‚‹ã“ã¨  |   æœŸé™ | æœŸé™åˆ‡ã‚Œã«ãªã£ãŸã‚‰         | äººãŒä»‹å…¥ã§ãã‚‹ï¼Ÿ   |
| ------- | ---: | ----------------- | ---------- |
| æ±ºæ¸ˆç¢ºå®š    |  30åˆ† | æ³¨æ–‡ã‚­ãƒ£ãƒ³ã‚»ãƒ«â†’è£œå„Ÿã¸ğŸ”     | æœŸé™å»¶é•·/æ‰‹å‹•ç¢ºèªâœ… |
| åœ¨åº«ç¢ºä¿    |  10åˆ† | æ³¨æ–‡ã‚­ãƒ£ãƒ³ã‚»ãƒ«â†’è£œå„Ÿã¸ğŸ“¦     | å†è©¦è¡Œ/ä»£æ›¿åœ¨åº«âœ…  |
| é…é€ãƒ©ãƒ™ãƒ«ç™ºè¡Œ |  15åˆ† | æ‰‹å‹•ã‚¿ã‚¹ã‚¯ã¸ğŸ‘©â€ğŸ’¼       | Retry/åˆ¥æ‰‹æ®µâœ… |
| ä¸æ­£æ¤œçŸ¥ã®å¯©æŸ» | 24æ™‚é–“ | è‡ªå‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ« or å¼·åˆ¶ä¿ç•™ğŸ§Š | æ‰¿èª/å¦èªâœ…     |

---

## 10) AIæ´»ç”¨ï¼ˆCopilot/Codexï¼‰ã§çˆ†é€Ÿã«ã™ã‚‹å‘ªæ–‡ğŸª„ğŸ¤–âœ¨

### â‘  æœŸé™ã¨çŠ¶æ…‹ã®æ´—ã„å‡ºã—ğŸ—‚ï¸

* ã€Œæ³¨æ–‡ãƒ•ãƒ­ãƒ¼ï¼ˆæ³¨æ–‡â†’æ±ºæ¸ˆâ†’åœ¨åº«â†’é…é€ï¼‰ã§ã€å¾…ã¡çŠ¶æ…‹ã¨æœŸé™ã€æœŸé™åˆ‡ã‚Œæ™‚ã®å‹•ä½œã‚’è¡¨ã«ã—ã¦ã€

### â‘¡ â€œé‹ç”¨ãƒœã‚¿ãƒ³â€ã®ä»•æ§˜æ›¸åŒ–ğŸ“œ

* ã€Œé‹ç”¨ç”»é¢ã«å¿…è¦ãªæ“ä½œï¼ˆRetry/Compensate/Extend/Resolveï¼‰ã¨ã€ãã®å®‰å…¨è£…ç½®ï¼ˆæ¨©é™/ç›£æŸ»ãƒ­ã‚°/äºŒé‡ç¢ºèªï¼‰ã‚’ç®‡æ¡æ›¸ãã§ã€

### â‘¢ çŠ¶æ…‹é·ç§»ãƒã‚§ãƒƒã‚¯ç”Ÿæˆâš™ï¸

* ã€ŒSagaStateã®é·ç§»ã‚’switchã§å®Ÿè£…ã—ã¦ã€‚ä¸æ­£é·ç§»ã¯Conflictã§è¿”ã™æ„Ÿã˜ã§ã€

---

## 11) ã‚ˆãã‚ã‚‹è½ã¨ã—ç©´ãƒ™ã‚¹ãƒˆ5ğŸ˜‡ğŸ•³ï¸

1. **æœŸé™ãŒãªã„** â†’ æ°¸é å¾…ã¡åœ°ç„ğŸ˜±
2. **æœŸé™ã¯ã‚ã‚‹ã‘ã©ç›£è¦–ãŒãªã„** â†’ èª°ã‚‚æ°—ã¥ã‹ãªã„ğŸ‘»
3. **é‹ç”¨ãƒœã‚¿ãƒ³ãŒå¼·ã™ã** â†’ èª¤æ“ä½œã§ç ´å£ŠğŸ’¥
4. **ç›£æŸ»ãƒ­ã‚°ãŒãªã„** â†’ å¾Œã§èª¬æ˜ã§ããªã„ğŸ“‰
5. **ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ãŒæ··ã–ã‚‹** â†’ ã€Œã„ã¤åˆ‡ã‚ŒãŸï¼Ÿã€ãŒæ··ä¹±ğŸŒğŸŒ€ï¼ˆUTCã§çµ±ä¸€ãŒãƒ©ã‚¯âœ¨ï¼‰

---

## 12) ã¾ã¨ã‚ğŸ€âœ…

* Sagaã¯é•·ãèµ°ã‚‹ã‹ã‚‰ã€**æ¥­å‹™ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆç· åˆ‡ï¼‰**ãŒè¶…é‡è¦â°
* è¨­è¨ˆã®åŸºæœ¬ã¯ **çŠ¶æ…‹ï¼ˆå¾…ã¡ï¼‰ï¼‹æœŸé™ï¼ˆãƒ‡ãƒ¼ã‚¿ï¼‰ï¼‹æœŸé™ç›£è¦–ï¼ˆä»•çµ„ã¿ï¼‰** ã®3ç‚¹ã‚»ãƒƒãƒˆğŸ§©
* è‡ªå‹•ã§ç›´ã‚‰ãªã„æ™‚ã¯ **äººãŒå®‰å…¨ã«ä»‹å…¥ã§ãã‚‹é‹ç”¨ãƒœã‚¿ãƒ³**ã‚’ç”¨æ„ã™ã‚‹ğŸ‘©â€ğŸ’¼ğŸ”˜
* â€œå®‰å…¨è£…ç½®ï¼ˆæ¨©é™ãƒ»ç›£æŸ»ãƒ­ã‚°ãƒ»å†ªç­‰ï¼‰â€ ã‚’å…¥ã‚Œã‚‹ã¨ã€ç¾å ´ã§å£Šã‚Œã«ãããªã‚‹ã‚ˆğŸ›¡ï¸âœ¨

ï¼ˆãªãŠã€C# 14 ã¯ .NET 10 ã¨ä¸€ç·’ã«è©¦ã›ã‚‹ã‚ˆã€ã¿ãŸã„ãªæœ€æ–°å‰æã¯ã“ã“ã«è¼‰ã£ã¦ã‚‹ã‚ˆï¼‰([Microsoft Learn][6])

[1]: https://microservices.io/patterns/data/saga.html?utm_source=chatgpt.com "Pattern: Saga"
[2]: https://camel.apache.org/components/4.14.x/eips/saga-eip.html?utm_source=chatgpt.com "Saga - Apache Camel"
[3]: https://learn.microsoft.com/en-us/dotnet/api/system.net.http.httpclient.timeout?view=net-10.0&utm_source=chatgpt.com "HttpClient.Timeout Property (System.Net.Http)"
[4]: https://speakerdeck.com/ufried/beyond-the-saga-pattern?utm_source=chatgpt.com "Beyond the saga pattern"
[5]: https://learn.microsoft.com/ja-jp/dotnet/core/resilience/?utm_source=chatgpt.com "å›å¾©æ€§ã®ã‚ã‚‹ã‚¢ãƒ—ãƒªé–‹ç™ºã®æ¦‚è¦ - .NET"
[6]: https://learn.microsoft.com/en-us/dotnet/csharp/whats-new/csharp-14?utm_source=chatgpt.com "What's new in C# 14"
