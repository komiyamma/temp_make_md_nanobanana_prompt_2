# ç¬¬12ç« ï¼šå†ªç­‰ã‚­ãƒ¼è¨­è¨ˆã®ãƒ«ãƒ¼ãƒ«ï¼ˆã‚¹ã‚³ãƒ¼ãƒ—/TTL/å†åˆ©ç”¨ç¦æ­¢ï¼‰â³ğŸ§·

## ã“ã®ç« ã®ã‚´ãƒ¼ãƒ«ğŸ¯âœ¨

* å†ªç­‰ã‚­ãƒ¼ã‚’ã€Œã©ã“ã¾ã§åŒã˜æ‰±ã„ã«ã™ã‚‹ã‹ï¼ˆã‚¹ã‚³ãƒ¼ãƒ—ï¼‰ã€ã‚’æ±ºã‚ã‚‰ã‚Œã‚‹ğŸ‘¤ğŸ”‘
* å†ªç­‰ã‚­ãƒ¼ã‚’ã€Œã„ã¤ã¾ã§è¦šãˆã¦ãŠãã‹ï¼ˆTTLï¼‰ã€ã‚’æ±ºã‚ã‚‰ã‚Œã‚‹ğŸ•’ğŸ§ 
* å†ªç­‰ã‚­ãƒ¼ã®ã€Œå†åˆ©ç”¨ç¦æ­¢ãƒ«ãƒ¼ãƒ«ã€ã‚’ä½œã‚Œã¦ã€äº‹æ•…ï¼ˆåˆ¥å†…å®¹ãªã®ã«åŒã˜ã‚­ãƒ¼ï¼‰ã‚’é˜²ã’ã‚‹ğŸš«ğŸ’¥
* ãã®ã¾ã¾DBãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆï¼ˆãŸãŸãå°ï¼‰ã‚’æ›¸ã‘ã‚‹ğŸ—ƒï¸âœï¸

![Concept](./picture/idem_ts_study_012_scope_ttl.png)

---

## ã¾ãšçµè«–ï¼šå†ªç­‰ã‚­ãƒ¼è¨­è¨ˆã®â€œä¸‰å¤§ãƒ«ãƒ¼ãƒ«â€ğŸ”‘ğŸ”ğŸ“Œ

### â‘  ã‚¹ã‚³ãƒ¼ãƒ—ï¼šã‚­ãƒ¼ã¯ã€Œèª°ã®ã€ã€Œã©ã®æ“ä½œã®ã€ã‚­ãƒ¼ï¼ŸğŸ‘¤â¡ï¸ğŸ§¾

åŒã˜å†ªç­‰ã‚­ãƒ¼ã§ã‚‚ã€**èª°ãŒ**ä½¿ã£ãŸã‹ã§æ„å‘³ãŒå¤‰ã‚ã‚‹ã‚ˆã­ï¼Ÿ
ã ã‹ã‚‰ã€Œå†ªç­‰ã‚­ãƒ¼ã ã‘ã€ã‚’ãƒ¦ãƒ‹ãƒ¼ã‚¯ã«ã™ã‚‹ã®ã¯å±é™ºâš ï¸

**åŸºæœ¬ã¯ã“ã®å½¢ãŒå¼·ã„ğŸ’ª**

* ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼è­˜åˆ¥å­ ãªã©ï¼‰ï¼‹ï¼ˆAPIæ“ä½œã®ç¨®é¡ ãªã©ï¼‰ï¼‹ï¼ˆå†ªç­‰ã‚­ãƒ¼ï¼‰

ä¾‹ï¼š

* userId å˜ä½ã§ãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼ˆåŒã˜ userId ã®ä¸­ã§ key ãŒé‡è¤‡ã—ãªã„ï¼‰
* ã•ã‚‰ã«ã€Œæ³¨æ–‡ä½œæˆã€ãªã©ã®æ“ä½œå˜ä½ã‚‚æ··ãœã‚‹ï¼ˆåˆ¥ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ã®äº‹æ•…ã‚’æ¸›ã‚‰ã™ï¼‰

---

### â‘¡ TTLï¼šã„ã¤ã¾ã§â€œåŒã˜çµæœã‚’è¿”ã™â€ã®ï¼ŸğŸ•’ğŸ”

å†ªç­‰ã‚­ãƒ¼ã¯ãšãƒ¼ã£ã¨ä¿å­˜ã—ãªã„ğŸ™…â€â™€ï¸
ä¿å­˜ã—ã£ã±ãªã—ã ã¨ã€ã‚³ã‚¹ãƒˆã‚‚å¢—ãˆã‚‹ã—ã€é‹ç”¨ã‚‚é‡ããªã‚‹ğŸ“¦ğŸ’¸

ã§ã‚‚çŸ­ã™ãã‚‹ã¨ã€**æ™‚é–“ãŒãŸã£ã¦ã‹ã‚‰ã®ãƒªãƒˆãƒ©ã‚¤ã§äºŒé‡ä½œæˆ**ãŒèµ·ãã‚‹ğŸ˜±
ãªã®ã§ã€Œãƒªãƒˆãƒ©ã‚¤ãŒèµ·ãã†ã‚‹æœŸé–“ã€ã‚’æƒ³åƒã—ã¦æ±ºã‚ã‚‹ã®ãŒã‚³ãƒ„ğŸ§ âœ¨

å®Ÿä¾‹ã¨ã—ã¦ã€Stripeã¯ã‚­ãƒ¼ã‚’æœ€å¤§255æ–‡å­—ã¾ã§æ‰±ãˆã¦ã€å°‘ãªãã¨ã‚‚24æ™‚é–“å¾Œã«è‡ªå‹•å‰Šé™¤ã§ãã‚‹ï¼ˆå¤ã„ã‚­ãƒ¼ã¯å‰Šé™¤ã•ã‚Œã€å‰Šé™¤å¾Œã«åŒã˜ã‚­ãƒ¼ã‚’ä½¿ã†ã¨æ–°è¦æ‰±ã„ã«ãªã‚‹ï¼‰ã¨ã„ã†é‹ç”¨ã‚’æ¡ˆå†…ã—ã¦ã‚‹ã‚ˆğŸ“Œ ([Stripeãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][1])
Adyenã¯ã‚­ãƒ¼ãŒæœ€ä½7æ—¥é–“æœ‰åŠ¹ï¼ˆcompany accountå˜ä½ã§ãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼‰ã¨ã„ã†é‹ç”¨ã‚’æ¡ˆå†…ã—ã¦ã‚‹ã‚ˆğŸ“Œ ([docs.adyen.com][2])

---

### â‘¢ å†åˆ©ç”¨ç¦æ­¢ï¼šåŒã˜ã‚­ãƒ¼ã¯ã€ŒåŒã˜å†…å®¹ã€ã«ã—ã‹ä½¿ã£ã¡ã‚ƒãƒ€ãƒ¡ğŸš«ğŸ§¾

ã“ã“ãŒä¸€ç•ªäº‹æ•…ã‚‹ãƒã‚¤ãƒ³ãƒˆğŸ’¥
åŒã˜ã‚­ãƒ¼ã§ã€å†…å®¹ãŒé•ã†ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã£ã¡ã‚ƒã†ã¨â€¦

* ã‚µãƒ¼ãƒãƒ¼ã¯ã€ŒåŒã˜å‡¦ç†ã ã‚ˆã­ï¼Ÿã€ã£ã¦æ€ã£ã¦å‰ã®çµæœã‚’è¿”ã™
* ã§ã‚‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ã€Œåˆ¥ã®æ³¨æ–‡ã®ã¤ã‚‚ã‚Šã€
  â†’ ãã¡ã‚ƒãã¡ã‚ƒğŸ˜µâ€ğŸ’«

ã ã‹ã‚‰ç‹é“ã¯ã“ã‚ŒğŸ‘‡

* **åŒã˜ã‚­ãƒ¼ã§æ¥ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆå†…å®¹ï¼‰ãŒåŒä¸€ã‹ãƒã‚§ãƒƒã‚¯**
* é•ã£ãŸã‚‰ã‚¨ãƒ©ãƒ¼ã«ã™ã‚‹ï¼ˆStripeã‚‚ã€Œå…ƒã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨åŒã˜ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹æ¯”è¼ƒã—ã¦ã€é•ãˆã°ã‚¨ãƒ©ãƒ¼ã«ã™ã‚‹ã€ã¨èª¬æ˜ã—ã¦ã‚‹ã‚ˆï¼‰ ([Stripeãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][1])

ã•ã‚‰ã«ã€IETFã®Idempotency-Keyãƒ˜ãƒƒãƒ€ãƒ¼ã®æ¨™æº–åŒ–ãƒ‰ãƒ©ãƒ•ãƒˆã§ã‚‚ã€POST/PATCHãªã©ã‚’å®‰å…¨ã«ãƒªãƒˆãƒ©ã‚¤å¯èƒ½ã«ã™ã‚‹ãŸã‚ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã—ã¦æ•´ç†ã•ã‚Œã¦ã‚‹ã‚ˆğŸ“Œ ([IETF Datatracker][3])

---

## 12.1 ã‚¹ã‚³ãƒ¼ãƒ—è¨­è¨ˆï¼šä½•ã‚’ã€ŒåŒã˜æ“ä½œã€ã¨ã¿ãªã™ï¼ŸğŸ§©ğŸ”

### ã‚¹ã‚³ãƒ¼ãƒ—å€™è£œï¼ˆå¼·ã•é †ï¼‰ğŸ’ªâœ¨

#### A. ã€ŒuserId + idempotencyKeyã€æ–¹å¼ï¼ˆã‚ˆãã‚ã‚‹ç‹é“ï¼‰ğŸ‘¤ğŸ”‘

* åŒä¸€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸­ã§ã¯ã‚­ãƒ¼é‡è¤‡ç¦æ­¢
* åˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã‚‰åŒã˜ã‚­ãƒ¼ã§ã‚‚OK
* ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆãªã‚‰ tenantId ã‚‚æ··ãœã‚‹ã®ãŒé‰„æ¿ğŸ¢

**ãƒ¡ãƒªãƒƒãƒˆ**ï¼šã‚·ãƒ³ãƒ—ãƒ«ã§å¼·ã„ğŸ˜Š
**æ³¨æ„**ï¼šåŒä¸€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåˆ¥ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§åŒã˜ã‚­ãƒ¼ã‚’ä½¿ã†äº‹æ•…ãŒã‚ã‚Šãˆã‚‹

---

#### B. ã€ŒuserId + endpoint(ã¾ãŸã¯ operation) + idempotencyKeyã€æ–¹å¼ï¼ˆäº‹æ•…ã‚Šã«ãã„ï¼‰ğŸ‘¤ğŸ§¾ğŸ”‘

* ã€Œæ³¨æ–‡ä½œæˆã€ã¨ã€Œæ”¯æ‰•ã„ç¢ºå®šã€ã§åŒã˜ã‚­ãƒ¼ã‚’ä½¿ã£ã¦ã‚‚è¡çªã—ã«ãã„ğŸ‘

**ãŠã™ã™ã‚**ï¼šæ•™æã®ãƒŸãƒ‹æ³¨æ–‡APIã§ã¯ã“ã‚ŒãŒæ‰±ã„ã‚„ã™ã„âœ¨

---

#### C. ã€Œã‚°ãƒ­ãƒ¼ãƒãƒ«ã§ idempotencyKey ã‚’ãƒ¦ãƒ‹ãƒ¼ã‚¯ã€ï¼ˆéæ¨å¥¨å¯„ã‚Šï¼‰ğŸŒâš ï¸

* â€œä¸–ç•Œã§ä¸€æ„ãªã‚­ãƒ¼ç”Ÿæˆâ€ãŒå‰æã«ãªã£ã¦ã€é‹ç”¨ãŒé‡ã„
* äº‹æ•…ã£ãŸã¨ãã®å½±éŸ¿ç¯„å›²ã‚‚åºƒã„ğŸ˜µ

---

### ã‚¹ã‚³ãƒ¼ãƒ—è¨­è¨ˆã®ãƒã‚§ãƒƒã‚¯è³ªå•âœ…ğŸ“

* åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€åˆ¥ã®æ“ä½œã§åŒã˜ã‚­ãƒ¼ã‚’ä½¿ã†å¯èƒ½æ€§ã‚ã‚‹ï¼ŸğŸ¤”
* ãƒ¢ãƒã‚¤ãƒ«/ãƒ–ãƒ©ã‚¦ã‚¶/ãƒãƒƒãƒãªã©è¤‡æ•°ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒã‚ã‚‹ï¼ŸğŸ“±ğŸ’»
* ã€Œä¼šç¤¾å˜ä½ã§ãƒ¦ãƒ‹ãƒ¼ã‚¯ã€ã¿ãŸã„ãªå¢ƒç•ŒãŒå¿…è¦ï¼ŸğŸ¢
  ï¼ˆä¾‹ï¼šAdyenã¯ä¼šç¤¾ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå˜ä½ã§ãƒ¦ãƒ‹ãƒ¼ã‚¯ã«ã™ã‚‹é‹ç”¨ï¼‰ ([docs.adyen.com][2])

---

## 12.2 TTLè¨­è¨ˆï¼šã©ã‚Œãã‚‰ã„è¦šãˆã¦ãŠãï¼ŸğŸ•’ğŸ“¦

### TTLã‚’æ±ºã‚ã‚‹â€œè€ƒãˆæ–¹â€ğŸ§ âœ¨

TTLã¯ã€Œé©å½“ã«1æ—¥ï¼ã€ã˜ã‚ƒãªãã¦ã€ã ã„ãŸã„ã“ã®ææ–™ã§æ±ºã‚ã‚‹ã¨å®‰å…¨âœ…

1. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ãƒªãƒˆãƒ©ã‚¤æœŸé–“ï¼ˆã©ã‚Œãã‚‰ã„ç²˜ã‚‹ï¼Ÿï¼‰ğŸ”
2. ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚„é€šä¿¡ä¸å®‰å®šãŒèµ·ãã‚‹ç¾å®Ÿï¼ˆæ•°åˆ†ã€œæ•°æ™‚é–“ã‚ã‚Šãˆã‚‹ï¼‰ğŸŒ§ï¸
3. éåŒæœŸå‡¦ç†ãŒæ··ã–ã‚‹ãªã‚‰ã€å®Œäº†ã¾ã§ã®æœ€é•·æ™‚é–“ã‚‚è€ƒãˆã‚‹â³
4. ç›£æŸ»ãƒ»å•ã„åˆã‚ã›å¯¾å¿œï¼ˆã€Œã‚ã®æ³¨æ–‡ã©ã†ãªã£ãŸï¼Ÿã€ï¼‰ã®éƒ½åˆã‚‚å°‘ã—å…¥ã‚Œã‚‹ğŸ“

### æœ‰åã©ã“ã‚ã®â€œç›®å®‰â€æ„ŸğŸ“Œ

* Stripeï¼šã‚­ãƒ¼ã¯å°‘ãªãã¨ã‚‚24æ™‚é–“å¾Œã«è‡ªå‹•å‰Šé™¤ã§ãã€å‰Šé™¤å¾Œã«åŒã˜ã‚­ãƒ¼ã‚’ä½¿ã†ã¨æ–°è¦æ‰±ã„ã«ãªã‚‹ï¼ˆã¾ãŸã€åŒã˜ã‚­ãƒ¼ã§ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒé•ã†ã¨ã‚¨ãƒ©ãƒ¼ï¼‰ ([Stripeãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][1])
* Adyenï¼šã‚­ãƒ¼ã¯æœ€ä½7æ—¥æœ‰åŠ¹ ([docs.adyen.com][2])
* PayPalï¼šãƒªã‚¯ã‚¨ã‚¹ãƒˆIDã‚’ä¸€å®šæœŸé–“ä¿æŒã—ã€ãã®é–“ã¯ãƒªãƒˆãƒ©ã‚¤å¯èƒ½ã¨ã—ã¦èª¬æ˜ ([developer.paypal.com][4])

### æ•™æãƒŸãƒ‹APIã®ãŠã™ã™ã‚TTLï¼ˆè¿·ã£ãŸã‚‰ï¼‰ğŸ°âœ¨

* åŒæœŸå‡¦ç†ãƒ¡ã‚¤ãƒ³ï¼š**24æ™‚é–“**ï¼ˆæ‰±ã„ã‚„ã™ã„ï¼†ç¾å®Ÿã«å¼·ã„ï¼‰ğŸ•›
* éåŒæœŸãŒæ··ã–ã‚‹ï¼š**å®Œäº†æƒ³å®šæ™‚é–“ + ä½™è£•**ï¼ˆä¾‹ï¼šæœ€å¤§2æ™‚é–“ãªã‚‰ 24æ™‚é–“ã§OKã€æœ€å¤§2æ—¥ãªã‚‰ 3ã€œ7æ—¥ã‚‚æ¤œè¨ï¼‰ğŸ“®
* è¶…é‡è¦ï¼ˆæ±ºæ¸ˆç´šï¼‰ã§å•ã„åˆã‚ã›ã‚‚å¤šã„ï¼š**7æ—¥**ã‚‚ç¾å®Ÿçš„ï¼ˆãŸã ã—ä¿å­˜ã‚³ã‚¹ãƒˆâ†‘ï¼‰ğŸ’³ğŸ“ˆ

---

## 12.3 å†åˆ©ç”¨ç¦æ­¢ï¼šåŒã˜ã‚­ãƒ¼ã¯â€œåŒã˜å†…å®¹â€ã ã‘ï¼ğŸš«ğŸ§¾

### ã©ã†ã‚„ã£ã¦é˜²ãï¼Ÿï¼ˆè¶…ãŠã™ã™ã‚ã®ã‚„ã‚Šæ–¹ï¼‰ğŸ”’âœ¨

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å†…å®¹ã‚’ãƒãƒƒã‚·ãƒ¥åŒ–ã—ã¦ä¿å­˜**ã—ã¦ãŠãã®ãŒç‹é“ğŸ‘

![Request Hash Calculation](./picture/idem_ts_study_012_hash_logic.png)

* åˆå›ï¼š

  * ï¼ˆuserId, operation, keyï¼‰ã§ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œã‚‹
  * requestHash ã‚‚ä¿å­˜ã™ã‚‹
* 2å›ç›®ä»¥é™ï¼š

  * åŒã˜ï¼ˆuserId, operation, keyï¼‰ã‚’ç™ºè¦‹
  * requestHash ãŒåŒã˜ãªã‚‰ â€œãƒªãƒ—ãƒ¬ã‚¤â€ï¼ˆåŒã˜çµæœã‚’è¿”ã™ï¼‰ğŸ”
  * requestHash ãŒé•ã†ãªã‚‰ â€œä¸æ­£å†åˆ©ç”¨â€ï¼ˆã‚¨ãƒ©ãƒ¼ï¼‰ğŸ’¥

Stripeã‚‚ã€Œæœ€åˆã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨åŒã˜ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹æ¯”è¼ƒã—ã€é•ãˆã°ã‚¨ãƒ©ãƒ¼ã«ã™ã‚‹ã€é‹ç”¨ã‚’èª¬æ˜ã—ã¦ã‚‹ã‚ˆğŸ“Œ ([Stripeãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][1])

```mermaid
sequenceDiagram
    participant C as ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    participant S as ã‚µãƒ¼ãƒãƒ¼
    participant DB as DB

    C->>S: Request (Key: K1, Data: A)
    S->>S: Compute Hash(A) = H1
    S->>DB: Save(Key: K1, Hash: H1, Status: Done)
    S-->>C: Response (Success)

    Note over C,S: --- æ‚ªæ„ã‚ã‚‹/é–“é•ã„å†åˆ©ç”¨ ---

    C->>S: Request (Key: K1, Data: B)
    S->>S: Compute Hash(B) = H2
    S->>DB: Find(Key: K1) -> returns Hash: H1
    S->>S: Compare H1 != H2
    S-->>C: 409 Conflict / 422 Unprocessable
```

---

## 12.4 DBãƒ†ãƒ¼ãƒ–ãƒ«æ¡ˆï¼ˆãŸãŸãå°ï¼‰ğŸ—ƒï¸âœï¸

ã“ã“ã§ã¯ã€Œå¾Œã§ç¬¬13ç« ã®â€œçµæœä¿å­˜â€ã«ã¤ãªãŒã‚‹å½¢ã€ã§ä½œã‚‹ã‚ˆğŸ“¦ğŸ“¤

### æœ€ä½é™ã»ã—ã„åˆ—ï¼ˆãƒŸãƒ‹ãƒãƒ ï¼‰âœ…

* scopeç”¨ï¼šuserIdï¼ˆï¼‹å¿…è¦ãªã‚‰tenantIdï¼‰
* operationï¼ˆä¾‹ï¼šcreateOrderï¼‰
* idempotencyKey
* requestHashï¼ˆå†åˆ©ç”¨ç¦æ­¢ãƒã‚§ãƒƒã‚¯ç”¨ï¼‰
* statusï¼ˆprocessing/succeeded/failedï¼‰
* createdAt / expiresAt

### å®Ÿå‹™å¯„ã‚Šã«ã™ã‚‹ãªã‚‰ï¼ˆçµæœãƒªãƒ—ãƒ¬ã‚¤ç”¨ï¼‰âœ¨

* responseStatus
* responseBodyï¼ˆJSONï¼‰
* responseHeadersï¼ˆJSONï¼‰
* updatedAt

---

### SQLä¾‹ï¼ˆPostgreSQLæƒ³å®šï¼‰ğŸ˜

```sql
CREATE TABLE idempotency_records (
  id BIGSERIAL PRIMARY KEY,

  tenant_id TEXT NULL,                 -- å¿…è¦ãªã‚‰ï¼ˆãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆç”¨ï¼‰
  user_id TEXT NOT NULL,               -- ã‚¹ã‚³ãƒ¼ãƒ—
  operation TEXT NOT NULL,             -- ä¾‹: "createOrder"
  idem_key TEXT NOT NULL,              -- Idempotency-Key

  request_hash TEXT NOT NULL,          -- å†åˆ©ç”¨ç¦æ­¢ãƒã‚§ãƒƒã‚¯ç”¨

  status TEXT NOT NULL,                -- "processing" | "succeeded" | "failed"
  response_status INT NULL,
  response_body JSONB NULL,
  response_headers JSONB NULL,

  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  expires_at TIMESTAMPTZ NOT NULL
);

-- ã‚¹ã‚³ãƒ¼ãƒ—ï¼‹ã‚­ãƒ¼ã®ä¸€æ„åˆ¶ç´„ï¼ˆè¶…é‡è¦ï¼ï¼‰
CREATE UNIQUE INDEX ux_idem_scope_key
ON idempotency_records (COALESCE(tenant_id, ''), user_id, operation, idem_key);

-- æƒé™¤ç”¨ï¼ˆTTLï¼‰
CREATE INDEX ix_idem_expires_at
ON idempotency_records (expires_at);
```

---

## 12.5 TypeScriptã§ã®â€œè¨­è¨ˆã‚¤ãƒ¡ãƒ¼ã‚¸â€ï¼ˆè¶…ãƒŸãƒ‹ï¼‰ğŸ§ ğŸ’»

### ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã®ãƒãƒƒã‚·ãƒ¥åŒ–ï¼ˆä¾‹ï¼‰ğŸ”

```ts
import crypto from "node:crypto";

type CreateOrderBody = {
  productId: string;
  quantity: number;
};

function stableStringify(obj: unknown): string {
  // æ•™æç”¨ã®ç°¡æ˜“ç‰ˆï¼šã‚­ãƒ¼é †ã‚’å®‰å®šã•ã›ã‚‹ï¼ˆå®Ÿå‹™ã¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªåˆ©ç”¨ã‚‚ã‚¢ãƒªï¼‰
  return JSON.stringify(obj, Object.keys(obj as any).sort());
}

function hashRequest(body: CreateOrderBody): string {
  const s = stableStringify(body);
  return crypto.createHash("sha256").update(s, "utf8").digest("hex");
}
```

### å†åˆ©ç”¨ç¦æ­¢ãƒã‚§ãƒƒã‚¯ã®æµã‚Œï¼ˆæ“¬ä¼¼ã‚³ãƒ¼ãƒ‰ï¼‰ğŸ”âœ…

```ts
type IdemStatus = "processing" | "succeeded" | "failed";

type IdemRecord = {
  userId: string;
  operation: string;
  idemKey: string;
  requestHash: string;
  status: IdemStatus;
  responseStatus?: number;
  responseBody?: unknown;
  expiresAt: Date;
};

async function handleCreateOrder(userId: string, idemKey: string, body: CreateOrderBody) {
  const operation = "createOrder";
  const requestHash = hashRequest(body);

  const existing = await findIdemRecord(userId, operation, idemKey);

  if (!existing) {
    // åˆå›ï¼šå…ˆã«ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆï¼ˆåŒæ™‚å®Ÿè¡Œã«ã‚‚å¼·ããªã‚‹ï¼‰
    await insertIdemRecord({
      userId,
      operation,
      idemKey,
      requestHash,
      status: "processing",
      expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000),
    });

    const result = await actuallyCreateOrder(body);

    await markSucceeded(userId, operation, idemKey, {
      responseStatus: 201,
      responseBody: result,
    });

    return { status: 201, body: result };
  }

  // 2å›ç›®ä»¥é™ï¼šåŒã˜å†…å®¹ã‹ãƒã‚§ãƒƒã‚¯
  if (existing.requestHash !== requestHash) {
    // â€œåŒã˜ã‚­ãƒ¼ã§åˆ¥å†…å®¹â€ â†’ äº‹æ•…é˜²æ­¢ã§å¼¾ã
    return { status: 409, body: { message: "Idempotency key reused with different request." } };
  }

  // åŒã˜å†…å®¹ãªã‚‰çµæœã‚’è¿”ã™ï¼ˆç¬¬13ç« ã§æœ¬æ ¼åŒ–ï¼‰
  if (existing.status === "succeeded") {
    return { status: existing.responseStatus ?? 200, body: existing.responseBody };
  }

  // processingä¸­ãªã‚‰ã€Œå‡¦ç†ä¸­ã€ã¨è¿”ã™è¨­è¨ˆã‚‚ã‚¢ãƒªï¼ˆç¬¬20ç« ã§è©³ã—ãï¼‰
  return { status: 202, body: { message: "Processing. Retry with the same Idempotency-Key." } };
}

// â†“ ã“ã“ã¯DBã‚¢ã‚¯ã‚»ã‚¹å±¤ï¼ˆä»Šå›ã¯å½¢ã ã‘ï¼‰
declare function findIdemRecord(userId: string, operation: string, idemKey: string): Promise<IdemRecord | null>;
declare function insertIdemRecord(rec: IdemRecord): Promise<void>;
declare function markSucceeded(
  userId: string,
  operation: string,
  idemKey: string,
  data: { responseStatus: number; responseBody: unknown }
): Promise<void>;
declare function actuallyCreateOrder(body: CreateOrderBody): Promise<unknown>;
```

ãƒã‚¤ãƒ³ãƒˆğŸ’¡

* å…ˆã«ã€Œprocessingã€ã§ç¢ºä¿ã™ã‚‹ï¼ˆåŒæ™‚å®Ÿè¡Œã«å¼·ããªã‚‹ï¼‰ğŸ”’
* requestHash ã‚’æ¯”ã¹ã¦ã€Œåˆ¥å†…å®¹ã€ã‚’æ‹’å¦ã™ã‚‹ğŸš«
* æˆåŠŸæ¸ˆã¿ãªã‚‰çµæœã‚’è¿”ã™ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‹ï¼‰ğŸ“¦
* TTLæƒé™¤ã®ãŸã‚ expiresAt ã‚’å…¥ã‚Œã‚‹ğŸ§¹ğŸ•’

---

## 12.6 ã‚ˆãã‚ã‚‹äº‹æ•…ãƒ‘ã‚¿ãƒ¼ãƒ³é›†ğŸ˜±â¡ï¸âœ…

### äº‹æ•…â‘ ï¼šã‚¹ã‚³ãƒ¼ãƒ—ãŒå¼±ãã¦åˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼åŒå£«ãŒè¡çªğŸ’¥

* ã€ŒidempotencyKeyã ã‘ãƒ¦ãƒ‹ãƒ¼ã‚¯ã€ã«ã—ã¦ã‚‹ã¨èµ·ããŒã¡
  âœ… userIdï¼ˆï¼‹tenantIdï¼‰ã‚’æ··ãœã‚‹ğŸ‘¤ğŸ¢

### äº‹æ•…â‘¡ï¼šTTLãŒçŸ­ã™ãã¦â€œç¿Œæ—¥ãƒªãƒˆãƒ©ã‚¤â€ã§äºŒé‡ä½œæˆğŸ˜µ

âœ… ãƒªãƒˆãƒ©ã‚¤æœŸé–“ï¼‹é‹ç”¨å®Ÿæ…‹ã‹ã‚‰æ±ºã‚ã‚‹
ï¼ˆä¾‹ï¼šStripeã¯å°‘ãªãã¨ã‚‚24æ™‚é–“å¾Œã«å‰Šé™¤ã§ãã‚‹é‹ç”¨ã‚’æ¡ˆå†…ï¼‰ ([Stripeãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][1])

### äº‹æ•…â‘¢ï¼šåŒã˜ã‚­ãƒ¼ã‚’åˆ¥å†…å®¹ã«ä½¿ã£ã¦ã€æ„å›³ã—ãªã„çµæœãŒè¿”ã‚‹ğŸŒ€

âœ… requestHashï¼ˆã¾ãŸã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ¯”è¼ƒï¼‰ã§å¼¾ã
ï¼ˆStripeã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ¯”è¼ƒã—ã¦ä¸ä¸€è‡´ãªã‚‰ã‚¨ãƒ©ãƒ¼ã«ã™ã‚‹é‹ç”¨ã‚’èª¬æ˜ï¼‰ ([Stripeãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][1])

### äº‹æ•…â‘£ï¼šã‚­ãƒ¼ã«å€‹äººæƒ…å ±ã‚’å…¥ã‚Œã¦ã—ã¾ã†ğŸ«£

* ä¾‹ï¼šãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€æ°åãªã©
  âœ… UUIDã¿ãŸã„ãªãƒ©ãƒ³ãƒ€ãƒ æ–‡å­—åˆ—ã«ã™ã‚‹ğŸ”‘âœ¨
  ï¼ˆStripeã‚‚ã‚­ãƒ¼ç”Ÿæˆã¯UUID v4ãªã©ãƒ©ãƒ³ãƒ€ãƒ ã‚’æ¨å¥¨ã—ã€é•·ã•ä¸Šé™ã‚‚ç¤ºã—ã¦ã‚‹ï¼‰ ([Stripeãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][1])

---

## 12.7 ãƒŸãƒ‹æ¼”ç¿’ğŸ“âœ¨ï¼ˆã“ã®ç« ã®æ‰‹ã‚’å‹•ã‹ã™ã‚„ã¤ï¼ï¼‰

### æ¼”ç¿’1ï¼šã‚ãªãŸã®ã€Œã‚¹ã‚³ãƒ¼ãƒ—ã€ã‚’æ±ºã‚ã‚ˆã†ğŸ‘¤ğŸ”‘

æ¬¡ã‚’åŸ‹ã‚ã¦ã­âœï¸

* ã‚¹ã‚³ãƒ¼ãƒ—ã®å˜ä½ï¼š userId / tenantId / operation ã‚’ã©ã†ä½¿ã†ï¼Ÿ
* ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ï¼š ï¼ˆã€€ã€€ã€€ã€€, ã€€ã€€ã€€ã€€, ã€€ã€€ã€€ã€€, idemKey ï¼‰

### æ¼”ç¿’2ï¼šTTLã‚’æ±ºã‚ã‚ˆã†ğŸ•’

* æƒ³å®šã™ã‚‹æœ€å¤§ãƒªãƒˆãƒ©ã‚¤æ™‚é–“ï¼šï¼¿ï¼¿ï¼¿æ™‚é–“
* TTLï¼šï¼¿ï¼¿ï¼¿æ™‚é–“ï¼ˆã¾ãŸã¯ï¼¿ï¼¿ï¼¿æ—¥ï¼‰
* ãã®ç†ç”±ï¼šï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿

ãƒ’ãƒ³ãƒˆï¼š

* Stripeã¯å°‘ãªãã¨ã‚‚24æ™‚é–“å¾Œã«å‰Šé™¤ã§ãã‚‹é‹ç”¨ã‚’æ¡ˆå†… ([Stripeãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][1])
* Adyenã¯æœ€ä½7æ—¥æœ‰åŠ¹ã®é‹ç”¨ã‚’æ¡ˆå†… ([docs.adyen.com][2])

### æ¼”ç¿’3ï¼šå†åˆ©ç”¨ç¦æ­¢ãƒ«ãƒ¼ãƒ«ã‚’æ›¸ã“ã†ğŸš«ğŸ§¾

ä»•æ§˜æ–‡ï¼ˆæ—¥æœ¬èªã§OKï¼‰ã‚’1ã€œ2æ–‡ã§âœï¸
ä¾‹ã®å½¢ï¼š

* ã€ŒåŒã˜å†ªç­‰ã‚­ãƒ¼ã¯åŒä¸€å†…å®¹ã®ãƒªãƒˆãƒ©ã‚¤ã«ã®ã¿ä½¿ç”¨ã§ãã‚‹ã€‚å†…å®¹ãŒç•°ãªã‚‹å ´åˆã¯ 409 ã‚’è¿”ã™ã€‚ã€

---

## 12.8 AIæ´»ç”¨ğŸ¤–âœ¨ï¼ˆã“ã®ç« ã§ä½¿ã†ã¨å¼·ã„ï¼ï¼‰

### â‘  ã‚¹ã‚³ãƒ¼ãƒ—è¨­è¨ˆãƒ¬ãƒ“ãƒ¥ãƒ¼ğŸ”

AIã¸ã®æŠ•ã’æ–¹ä¾‹ğŸ’¬

* ã€Œã“ã®APIã®å†ªç­‰ã‚­ãƒ¼ã®ã‚¹ã‚³ãƒ¼ãƒ—æ¡ˆã‚’3ã¤å‡ºã—ã¦ã€‚äº‹æ•…ã‚Šã‚„ã™ã•ã¨é‹ç”¨ã‚³ã‚¹ãƒˆã‚‚æ¯”è¼ƒã—ã¦ã€

### â‘¡ TTLã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯ğŸ•’âœ…

* ã€Œæœ€å¤§ãƒªãƒˆãƒ©ã‚¤ãŒâ—‹æ™‚é–“ã€éåŒæœŸãŒæœ€å¤§â—‹æ™‚é–“ã€‚TTLã®å€™è£œã‚’3ã¤å‡ºã—ã¦ã€ãƒ¡ãƒªãƒ‡ãƒ¡ã‚’æ›¸ã„ã¦ã€

### â‘¢ ãƒ†ãƒ¼ãƒ–ãƒ«æ¡ˆãƒ¬ãƒ“ãƒ¥ãƒ¼ğŸ—ƒï¸

* ã€Œã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆã§â€œåŒä¸€ã‚­ãƒ¼åˆ¥å†…å®¹â€ã‚’é˜²ã’ã‚‹ï¼Ÿè¶³ã‚Šãªã„åˆ—ã‚„ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æŒ‡æ‘˜ã—ã¦ã€

ï¼ˆæ³¨æ„âš ï¸ï¼‰
AIã¯ã¨ãã©ãã€Œã‚­ãƒ¼æ°¸ç¶šä¿å­˜ã§OKï¼ã€ã¿ãŸã„ãªé›‘å›ç­”ã‚’ã™ã‚‹ã“ã¨ãŒã‚ã‚‹ã‹ã‚‰ã€**ãƒªãƒˆãƒ©ã‚¤æœŸé–“ã¨ä¿å­˜ã‚³ã‚¹ãƒˆã®ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•**ã¯å¿…ãšè‡ªåˆ†ã§ã‚‚ç¢ºèªã­ğŸ§ âœ¨

---

## ã¾ã¨ã‚ğŸ€

* ã‚¹ã‚³ãƒ¼ãƒ—ã¯ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‹æ“ä½œï¼‹ã‚­ãƒ¼ã€ãŒåŸºæœ¬ã§äº‹æ•…ã‚Šã«ãã„ğŸ‘¤ğŸ§¾ğŸ”‘
* TTLã¯ã€Œãƒªãƒˆãƒ©ã‚¤æœŸé–“ã€ã¨ã€ŒéåŒæœŸã®æœ€é•·ã€ã‚’ææ–™ã«æ±ºã‚ã‚‹ğŸ•’
* å†åˆ©ç”¨ç¦æ­¢ã¯ requestHashï¼ˆã¾ãŸã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ¯”è¼ƒï¼‰ã§å®ˆã‚‹ğŸš«ğŸ§¾
* ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ã€Œãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ã€ã¨ã€ŒexpiresAtã€ãŒç”Ÿå‘½ç·šğŸ—ƒï¸â¤ï¸

[1]: https://docs.stripe.com/api/idempotent_requests?utm_source=chatgpt.com "Idempotent requests | Stripe API Reference"
[2]: https://docs.adyen.com/development-resources/api-idempotency?utm_source=chatgpt.com "API idempotency"
[3]: https://datatracker.ietf.org/doc/draft-ietf-httpapi-idempotency-key-header/?utm_source=chatgpt.com "The Idempotency-Key HTTP Header Field"
[4]: https://developer.paypal.com/reference/guidelines/idempotency/?utm_source=chatgpt.com "Idempotency"

