# ç¬¬11ç« ï¼šChoreographyå…¥é–€ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆã§é€£é–ã™ã‚‹ï¼‰ğŸ“£ğŸ”—

## ã“ã®ç« ã®ã‚´ãƒ¼ãƒ«ğŸ¯âœ¨

* Choreographyï¼ˆã‚³ãƒ¬ã‚ªã‚°ãƒ©ãƒ•ã‚£ï¼‰ã®ã€Œä¸–ç•Œè¦³ã€ã‚’è¨€è‘‰ã§èª¬æ˜ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ğŸ˜Š
* ã€Œã‚¤ãƒ™ãƒ³ãƒˆï¼äº‹å®Ÿã€ã€Œã‚³ãƒãƒ³ãƒ‰ï¼ãŠé¡˜ã„ã€ã‚’æ··åŒã—ãªã„ã§è¨­è¨ˆã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ğŸ§ ğŸ’¡
* äº‹æ•…ã‚Šã‚„ã™ã„ãƒã‚¤ãƒ³ãƒˆï¼ˆå‘½ååœ°ç„ãƒ»è²¬å‹™å´©å£Šãƒ»ãƒ‡ãƒãƒƒã‚°ä¸èƒ½ï¼‰ã‚’ã€æœ€åˆã‹ã‚‰é¿ã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹ğŸ›¡ï¸ğŸš§

---

# 11.1 Choreographyã£ã¦ã©ã‚“ãªæ„Ÿã˜ï¼ŸğŸ•ºğŸ”—

![dancer_whistle](./picture/saga_ts_study_011_dancer_whistle.png)

Choreographyã¯ã€ã–ã£ãã‚Šè¨€ã†ã¨â€¦

> **ã¿ã‚“ãªãŒâ€œç¬›ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆï¼‰â€ã‚’èã„ã¦ã€è‡ªåˆ†ã®å½¹ã ã‘è¸Šã‚‹**ğŸ•ºğŸ¶
> ãã—ã¦è¸Šã‚Šçµ‚ã‚ã£ãŸã‚‰ã€ã¾ãŸæ¬¡ã®ç¬›ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆï¼‰ã‚’é³´ã‚‰ã™ğŸ“£â¡ï¸ğŸ“£

ã¤ã¾ã‚Šã€**ä¸­å¤®ã®å¸ä»¤å¡”ï¼ˆã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼‰ãŒã„ãªã„**ã®ãŒç‰¹å¾´ã ã‚ˆğŸ’¡

![Choreography Flow](./picture/saga_ts_study_011_choreography.png)

```mermaid
flowchart LR
    subgraph Srv_Order ["Orderã‚µãƒ¼ãƒ“ã‚¹"]
        O1[æ³¨æ–‡ä½œæˆ]
    end
    subgraph Srv_Payment ["Paymentã‚µãƒ¼ãƒ“ã‚¹"]
        P1[æ±ºæ¸ˆå®Ÿè¡Œ]
    end
    subgraph Srv_Inventory ["Inventoryã‚µãƒ¼ãƒ“ã‚¹"]
        I1[åœ¨åº«ç¢ºä¿]
    end

    O1 -- "order.placed ğŸ“£" --> P1
    P1 -- "payment.authorized ğŸ“£" --> I1
    I1 -- "inventory.reserved ğŸ“£" --> Next[...]
```
å„ã‚µãƒ¼ãƒ“ã‚¹ãŒ **ã€Œã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ã‘å–ã‚‹ â†’ è‡ªåˆ†ã®å‡¦ç†ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ã‚’ã™ã‚‹ â†’ æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡ºã™ã€** ã‚’ç¹°ã‚Šè¿”ã—ã¦ã€SagaãŒå‰ã«é€²ã‚€æ„Ÿã˜ğŸ™Œ

Choreographyã¯ã€Œç–çµåˆã«ãªã‚Šã‚„ã™ã„ã€ä¸€æ–¹ã§ã€Œå…¨ä½“ã®æµã‚ŒãŒè¦‹ãˆã«ãã„ã€ã£ã¦ã„ã†ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ãŒã‚ã‚‹ã€ã¨ã‚ˆãèª¬æ˜ã•ã‚Œã‚‹ã‚ˆğŸ“Œ ([temporal.io][1])

---

# 11.2 ä¾‹ï¼šæ³¨æ–‡Sagaã‚’â€œã‚¤ãƒ™ãƒ³ãƒˆé€£é–â€ã§ã‚„ã£ã¦ã¿ã‚‹ğŸ›’ğŸ’³ğŸ“¦

![order_saga_chain](./picture/saga_ts_study_011_order_saga_chain.png)

ç™»å ´ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆä¾‹ï¼‰ğŸ‘‡

* Orderï¼ˆæ³¨æ–‡ï¼‰
* Paymentï¼ˆæ±ºæ¸ˆï¼‰
* Inventoryï¼ˆåœ¨åº«ï¼‰
* Shippingï¼ˆç™ºé€ï¼‰

æµã‚Œï¼ˆæˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰ğŸŒˆ

1. Order ãŒæ³¨æ–‡ã‚’ä½œã£ã¦ **`OrderPlaced`** ã‚’å‡ºã™ğŸ“£
2. Payment ãŒãã‚Œã‚’èã„ã¦æ±ºæ¸ˆã—ã¦ **`PaymentAuthorized`** ã‚’å‡ºã™ğŸ’³âœ¨
3. Inventory ãŒãã‚Œã‚’èã„ã¦åœ¨åº«ã‚’ç¢ºä¿ã—ã¦ **`InventoryReserved`** ã‚’å‡ºã™ğŸ“¦âœ…
4. Shipping ãŒãã‚Œã‚’èã„ã¦ç™ºé€æº–å‚™ã—ã¦ **`ShippingRequested`** ã‚’å‡ºã™ğŸššğŸ“£

ã“ã®ã¨ãã®ãƒã‚¤ãƒ³ãƒˆã¯è¶…é‡è¦ã§ğŸ‘‡
**ã€Œæ¬¡ã«èª°ã‚’å‘¼ã¶ã‹ã€ã‚’æ±ºã‚ã¦å‘¼ã¶ã‚“ã˜ã‚ƒãªãã¦ã€ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆäº‹å®Ÿï¼‰ã‚’å‡ºã™ã ã‘**ã£ã¦ã“ã¨ğŸ˜Š
â€œèª°ãŒåå¿œã™ã‚‹ã‹â€ã¯ã€è³¼èª­ã—ã¦ã‚‹å´ãŒæ±ºã‚ã‚‹ã®ğŸ§¡

---

# 11.3 ã€Œã‚¤ãƒ™ãƒ³ãƒˆã€ã¨ã€Œã‚³ãƒãƒ³ãƒ‰ã€ã‚’åˆ†ã‘ã‚‹ã ã‘ã§äº‹æ•…ãŒæ¸›ã‚‹ğŸ§¯âœ¨

![event_vs_command_broadcast](./picture/saga_ts_study_011_event_vs_command_broadcast.png)

åˆå¿ƒè€…ãŒä¸€ç•ªãƒãƒã‚Šã‚„ã™ã„ã®ãŒã“ã“ğŸ˜µâ€ğŸ’«

## âœ… ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆEventï¼‰ï¼èµ·ããŸäº‹å®ŸğŸ“£

* `PaymentAuthorized`ï¼ˆæ±ºæ¸ˆãŒæ‰¿èªã•ã‚ŒãŸï¼‰
* `InventoryReservationFailed`ï¼ˆåœ¨åº«ç¢ºä¿ã«å¤±æ•—ã—ãŸï¼‰

ã‚¤ãƒ™ãƒ³ãƒˆã¯ **ã€Œéå»å½¢ã€** ãŒå¤šã„ã‚ˆğŸ•°ï¸
ã‚¤ãƒ™ãƒ³ãƒˆã¯ã€Œã¿ã‚“ãªã«å…±æœ‰ã—ã¦ã„ã„ãƒ‹ãƒ¥ãƒ¼ã‚¹ã€ğŸ“°âœ¨

## âœ… ã‚³ãƒãƒ³ãƒ‰ï¼ˆCommandï¼‰ï¼ãŠé¡˜ã„ãƒ»æŒ‡ç¤ºğŸ“©

* `AuthorizePayment`ï¼ˆæ±ºæ¸ˆã—ã¦ã­ï¼‰
* `ReserveInventory`ï¼ˆåœ¨åº«ç¢ºä¿ã—ã¦ã­ï¼‰

Choreographyã®å­¦ç¿’ã§ã¯ã€åŸºæœ¬ã¯ **ã‚¤ãƒ™ãƒ³ãƒˆä¸­å¿ƒ**ã§è€ƒãˆã‚‹ã®ãŒåˆ†ã‹ã‚Šã‚„ã™ã„ã‚ˆğŸ˜Š
ï¼ˆã‚³ãƒãƒ³ãƒ‰ã‚’å¤šç”¨ã™ã‚‹ã¨ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¹ãŒâ€œRPCã£ã½ãâ€ãªã£ã¦ç ´ç¶»ã—ã‚„ã™ã„âš ï¸ï¼‰

```mermaid
graph TD
    subgraph Event ["ã‚¤ãƒ™ãƒ³ãƒˆ (Fact) ğŸ“£"]
        A[ã‚µãƒ¼ãƒ“ã‚¹] -- "èµ·ããŸã“ã¨ã‚’æ”¾é€" --> Bus1((ãƒã‚¹))
        Bus1 --> B[è³¼èª­è€…A]
        Bus1 --> C[è³¼èª­è€…B]
    end
    subgraph Command ["ã‚³ãƒãƒ³ãƒ‰ (Request) ğŸ“©"]
        D[ä¾é ¼è€…] -- "ç‰¹å®šã®ç›¸æ‰‹ã«ãŠé¡˜ã„" --> E[æ‹…å½“è€…]
    end
```

---

# 11.4 ã‚¤ãƒ™ãƒ³ãƒˆã¯ã€Œå°ç­’ï¼ˆãƒ¡ã‚¿æƒ…å ±ï¼‰ã€ãŒå‘½ğŸ“®ğŸ”

ã‚¤ãƒ™ãƒ³ãƒˆã£ã¦ã€Œæœ¬æ–‡ã€ã ã‘ã˜ã‚ƒãªãã¦ã€**è¿½è·¡ã®ãŸã‚ã®æƒ…å ±**ãŒè¶…å¤§äº‹âœ¨
æœ€è¿‘ã®ç¾å ´ã ã¨ã€ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æ¨™æº–åŒ–ã—ã‚ˆã†ã¨ã—ã¦ **CloudEvents** ã‚’æ¡ç”¨ã™ã‚‹ã“ã¨ãŒå¤šã„ã‚ˆğŸ“¦ğŸŒ©ï¸
CloudEventsã¯CNCFã®ä»•æ§˜ã¨ã—ã¦æ•´å‚™ã•ã‚Œã¦ã„ã¦ã€ã‚¤ãƒ™ãƒ³ãƒˆã®å…±é€šå±æ€§ï¼ˆid/type/source ãªã©ï¼‰ã‚’æƒãˆã‚„ã™ã„ã‚“ã ğŸ§  ([CNCF][2])

## ã¾ãšã¯å­¦ç¿’ç”¨ã®ã€Œæœ€å°ã‚¤ãƒ™ãƒ³ãƒˆå°ç­’ã€ğŸ’Œ

![cloudevents_envelope](./picture/saga_ts_study_011_cloudevents_envelope.png)

* `eventId`ï¼šã‚¤ãƒ™ãƒ³ãƒˆè‡ªä½“ã®IDï¼ˆé‡è¤‡æ¤œçŸ¥ã«ã‚‚ä½¿ã†ï¼‰ğŸ†”
* `type`ï¼šã‚¤ãƒ™ãƒ³ãƒˆåï¼ˆä¾‹ï¼š`payment.authorized.v1`ï¼‰ğŸ·ï¸
* `occurredAt`ï¼šç™ºç”Ÿæ™‚åˆ»ğŸ•°ï¸
* `sagaId`ï¼šã“ã®Sagaã®IDï¼ˆãŸã¨ãˆã°æ³¨æ–‡IDï¼‰ğŸ”—
* `correlationId`ï¼šåˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚¹/ãƒ­ã‚°ã§ç´ã¥ã‘ã‚‹IDğŸ§µ
* `data`ï¼šæœ¬æ–‡ï¼ˆæ¥­å‹™ãƒ‡ãƒ¼ã‚¿ï¼‰ğŸ“¦

TypeScriptä¾‹ï¼ˆé›°å›²æ°—ï¼‰ğŸ‘‡

```ts
// å­¦ç¿’ç”¨ï¼šCloudEventsã£ã½ã„ã€Œã‚¤ãƒ™ãƒ³ãƒˆå°ç­’ã€(æœ€å°)
export type EventEnvelope<TType extends string, TData> = {
  specversion: "1.0";
  id: string;               // eventId
  type: TType;              // e.g. "payment.authorized.v1"
  source: string;           // e.g. "payment-service"
  time: string;             // ISO8601
  subject?: string;         // e.g. orderId
  correlationId: string;    // è¿½è·¡ç”¨
  sagaId: string;           // Saga(ä¾‹: æ³¨æ–‡)ã®ID
};
```

```mermaid
classDiagram
    class EventEnvelope {
        +string id
        +string type
        +string source
        +string sagaId
        +string correlationId
        +object data
    }
```

---

# 11.5 â€œè¨­è¨ˆã®ã‚³ãƒ„â€ï¼“ã¤ã ã‘è¦šãˆã‚ˆğŸ§ âœ¨

## ã‚³ãƒ„â‘ ï¼šã‚¤ãƒ™ãƒ³ãƒˆåã¯ã€Œå®‰å®šã™ã‚‹åè©ã€ã«å¯„ã›ã‚‹ğŸ·ï¸ğŸ§Š

![naming_rules](./picture/saga_ts_study_011_naming_rules.png)

æ‚ªã„ä¾‹ğŸ˜±

* `DoPayment`ï¼ˆå‘½ä»¤ã£ã½ã„ï¼‰
* `PaymentDoneMaybe`ï¼ˆæ›–æ˜§ï¼‰

è‰¯ã„ä¾‹ğŸ˜Š

* `payment.authorized.v1`
* `payment.authorization_failed.v1`

ãƒã‚¤ãƒ³ãƒˆğŸ‘‡

* **ä½•ãŒèµ·ããŸã‹**ãŒåˆ†ã‹ã‚‹
* **ç²’åº¦ãŒå®‰å®š**ã™ã‚‹ï¼ˆç´°ã‹ã™ãã¦å¢—æ®–ã—ãªã„ï¼‰

---

## ã‚³ãƒ„â‘¡ï¼šã‚¤ãƒ™ãƒ³ãƒˆã®æœ¬æ–‡ã¯ã€Œå¿…è¦æœ€å°é™ã€ğŸ“¦âœ‚ï¸

![payload_size](./picture/saga_ts_study_011_payload_size.png)

ã‚¤ãƒ™ãƒ³ãƒˆã«ã€Œä½•ã§ã‚‚å…¨éƒ¨ã€å…¥ã‚ŒãŸããªã‚‹ã‘ã©â€¦å…¥ã‚Œã™ãã‚‹ã¨å°†æ¥ã¤ã‚‰ã„ğŸ˜µâ€ğŸ’«

* **å…¥ã‚Œã¦è‰¯ã„**ï¼šæ¬¡ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒå¿…è¦ãªã‚­ãƒ¼ï¼ˆ`orderId`ã€`amount`ã€`reservationId` ãªã©ï¼‰âœ…
* **å…¥ã‚Œãªã„æ–¹ãŒè‰¯ã„**ï¼šå·¨å¤§ãªæ³¨æ–‡è©³ç´°ã¾ã‚‹ã”ã¨ã€å€‹äººæƒ…å ±ã€ç”»é¢è¡¨ç¤ºç”¨ãƒ‡ãƒ¼ã‚¿âŒ

ç†ç”±ğŸ‘‡

* å¤‰æ›´ã«å¼±ããªã‚‹ï¼ˆ1ç®‡æ‰€ã®å¤‰æ›´ãŒå…¨ã‚µãƒ¼ãƒ“ã‚¹ã«æ³¢åŠï¼‰ğŸŒªï¸
* å–ã‚Šæ‰±ã„ãƒªã‚¹ã‚¯ï¼ˆPIIãªã©ï¼‰ã‚‚å¢—ãˆã‚‹âš ï¸

---

## ã‚³ãƒ„â‘¢ï¼šã€Œã‚¤ãƒ™ãƒ³ãƒˆä»•æ§˜ã€ã‚’ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–ã—ã¦å…±æœ‰ã™ã‚‹ğŸ“˜ğŸ¤

ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã¯ã€HTTP APIã‚ˆã‚Šã‚‚ã€Œæš—é»™ã€ãŒå¢—ãˆã‚„ã™ã„ã®ãŒå¼±ç‚¹ğŸ˜µ
ãã“ã§ **AsyncAPI** ã¿ãŸã„ãªä»•æ§˜ã§ã€ã‚¤ãƒ™ãƒ³ãƒˆã‚’â€œæ©Ÿæ¢°å¯èª­â€ã«ã¾ã¨ã‚ã‚‹ã®ãŒä»Šã©ãã®æµã‚Œã ã‚ˆğŸ§©âœ¨
AsyncAPIã¯ãƒ—ãƒ­ãƒˆã‚³ãƒ«éä¾å­˜ã§ã€ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•APIã‚’è¨˜è¿°ã§ãã‚‹ã‚ˆğŸ“š ([asyncapi.com][3])

ï¼ˆå­¦ç¿’æ®µéšã§ã¯ã€Œã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ï¼‹JSONä¾‹ã€ã§ã‚‚OKï¼ã§ã‚‚ã€å°†æ¥ã¯AsyncAPIã«ç¹‹ãŒã‚‹ğŸ«¶ï¼‰

---

# 11.6 ChoreographyãŒäº‹æ•…ã‚Šã‚„ã™ã„ãƒã‚¤ãƒ³ãƒˆå›³é‘‘ğŸ˜ˆğŸ“š

## äº‹æ•…â‘ ï¼šã‚¤ãƒ™ãƒ³ãƒˆåãŒå¢—æ®–ã—ã¦â€œè¾æ›¸â€ãŒå´©å£ŠğŸ“šğŸ’¥

* `OrderCreated` ã¨ `OrderPlaced` ã¨ `OrderSubmitted` ãŒä¹±ç«‹â€¦ğŸ˜µâ€ğŸ’«
  â†’ **åŒã˜æ„å‘³ãªã‚‰1ã¤ã«å¯„ã›ã‚‹**ã€ã©ã†ã—ã¦ã‚‚åˆ†ã‘ã‚‹ãªã‚‰ã€ŒçŠ¶æ…‹ã®é•ã„ã€ã‚’æ˜ç¢ºã«ã™ã‚‹ğŸ§ âœ¨

---

## äº‹æ•…â‘¡ï¼šè²¬å‹™ãŒå´©å£Šã—ã¦â€œãªã‚“ã§ã‚‚ã‚µãƒ¼ãƒ“ã‚¹â€ãŒèª•ç”ŸğŸ§Ÿâ€â™€ï¸

ä¾‹ï¼šOrderã‚µãƒ¼ãƒ“ã‚¹ãŒåœ¨åº«ã®éƒ½åˆã¾ã§åˆ¤æ–­ã—å§‹ã‚ã‚‹â€¦
â†’ **è‡ªåˆ†ã®å¢ƒç•Œã®ã“ã¨ã ã‘æ±ºã‚ã‚‹**ï¼ˆä»–ã‚µãƒ¼ãƒ“ã‚¹ã®éƒ½åˆã¯ã‚¤ãƒ™ãƒ³ãƒˆã§çŸ¥ã‚‹ï¼‰ğŸš§

---

## äº‹æ•…â‘¢ï¼šå…¨ä½“ã®æµã‚ŒãŒè¦‹ãˆãªãã¦ãƒ‡ãƒãƒƒã‚°ä¸èƒ½ğŸ”ğŸŒ€

Choreographyã¯ã€Œå¸ä»¤å¡”ãŒã„ãªã„ã€ã‹ã‚‰ã€ãƒ­ã‚°ãŒæ•£ã‚‰ã°ã‚‹ã¨è¿½ãˆãªã„ğŸ˜­
â†’ æœ€ä½é™ã“ã‚Œã ã‘å…¥ã‚Œã‚‹ğŸ‘‡

* `sagaId`ï¼ˆæ³¨æ–‡IDãªã©ï¼‰ğŸ”—
* `correlationId`ï¼ˆå…¨ãƒ­ã‚°å…±é€šï¼‰ğŸ§µ
* `eventId`ï¼ˆé‡è¤‡/å†å‡¦ç†ã®æ¤œçŸ¥ï¼‰ğŸ†”

---

## äº‹æ•…â‘£ï¼šåŒã˜ã‚¤ãƒ™ãƒ³ãƒˆãŒ2å›å±Šã„ã¦äºŒé‡å‡¦ç†ğŸ‘»ğŸ”

ç¾å®Ÿã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°ã¯ã€Œã ã„ãŸã„æœ€ä½1å›ï¼ˆat-least-onceï¼‰ã€ã«ãªã‚Šã‚„ã™ã„ã‚ˆâš ï¸
ã ã‹ã‚‰ **é‡è¤‡ã—ã¦ã‚‚å£Šã‚Œãªã„**å·¥å¤«ãŒå¿…è¦ï¼ˆå†ªç­‰æ€§ã¯å¾Œã®ç« ã§ã‚¬ãƒƒãƒ„ãƒªã‚„ã‚‹ã‚ˆğŸ”‘ï¼‰

å‚è€ƒã¨ã—ã¦ã€JetStreamã¿ãŸã„ã«ã€Œãƒ¡ãƒƒã‚»ãƒ¼ã‚¸IDãƒ˜ãƒƒãƒ€ã§é‡è¤‡æ’é™¤ã€ã‚’æ”¯æ´ã™ã‚‹ä»•çµ„ã¿ã‚‚ã‚ã‚‹ã‚ˆï¼ˆä¾‹ï¼š`Nats-Msg-Id`ï¼‰ğŸ§· ([docs.nats.io][4])

---

# 11.7 â€œè£œå„Ÿâ€ã¯Choreographyã ã¨ã©ã†ãªã‚‹ã®ï¼ŸğŸ§¯ğŸ”

![compensation_domino_reverse](./picture/saga_ts_study_011_compensation_domino_reverse.png)

Choreographyã§ã‚‚è£œå„Ÿã¯ã§ãã‚‹ã‚ˆğŸ˜Š
ã‚„ã‚Šæ–¹ã¯ã‚·ãƒ³ãƒ—ãƒ«ã§ğŸ‘‡

* ä¸‹æµã§å¤±æ•—ã—ãŸã‚‰ **å¤±æ•—ã‚¤ãƒ™ãƒ³ãƒˆ** ã‚’å‡ºã™ğŸ“£ğŸ˜±
  ä¾‹ï¼š`inventory.reservation_failed.v1`
* ãã‚Œã‚’èã„ãŸä¸ŠæµãŒ **è‡ªåˆ†ã®è£œå„Ÿ** ã‚’ã™ã‚‹ğŸ§¯
  ä¾‹ï¼šPaymentãŒã€Œè¿”é‡‘/å–æ¶ˆã€ã‚’ã—ã¦ `payment.refunded.v1` ã‚’å‡ºã™ğŸ’¸ğŸ”

ãƒã‚¤ãƒ³ãƒˆğŸ‘‡

* **è£œå„Ÿã¯â€œé€†é †ã§èµ·ãã‚„ã™ã„â€**ï¼ˆæœ€å¾Œã«ã‚„ã£ãŸã“ã¨ã‹ã‚‰æˆ»ã‚‹ï¼‰ğŸ”
* ã§ã‚‚ã€Œèª°ãŒã©ã“ã¾ã§æˆ»ã™ã‹ã€ã¯ã€ã‚¤ãƒ™ãƒ³ãƒˆè¨­è¨ˆãŒé›‘ã ã¨ã™ãå´©å£Šã™ã‚‹ğŸ˜µâ€ğŸ’«
  â†’ ã ã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆåã¨è²¬å‹™ãŒè¶…å¤§äº‹ãªã‚“ã ğŸ§ âœ¨

```mermaid
flowchart LR
    S1[Order] -- order.placed --> S2[Payment]
    S2 -- payment.authorized --> S3[Inventory]
    S3 -- "inventory.failed âŒ" --> S2
    S2 -- "payment.refunded ğŸ§¯" --> S1
    S1 -- "order.cancelled ğŸ§¯" --> End((çµ‚äº†))
    
    style S3 fill:#fdd,stroke:#f66
```

---

# 11.8 ãƒŸãƒ‹å®Ÿè£…ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆå­¦ç¿’ç”¨ï¼‰ğŸ§ªğŸ’»

ã€Œã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¹ã€ã‚’é›‘ã«æŠ½è±¡åŒ–ã—ã¦ã€é›°å›²æ°—ã‚’æ´ã‚‚ã†ğŸ˜Š
ï¼ˆæœ¬ç•ªã®Kafka/NATS/RabbitMQã¯æ¬¡ã®æ®µéšã§OKğŸ‘Œï¼‰

```ts
type Handler<T> = (event: T) => Promise<void>;

class InMemoryBus {
  private handlers: Record<string, Handler<any>[]> = {};

  subscribe<T>(type: string, handler: Handler<T>) {
    (this.handlers[type] ??= []).push(handler);
  }

  async publish<T>(type: string, event: T) {
    const hs = this.handlers[type] ?? [];
    for (const h of hs) await h(event);
  }
}

// ä¾‹ï¼šã‚¤ãƒ™ãƒ³ãƒˆå‹
type OrderPlaced = EventEnvelope<"order.placed.v1", { orderId: string; amount: number }>;
type PaymentAuthorized = EventEnvelope<"payment.authorized.v1", { orderId: string; paymentId: string }>;
```

ã“ã“ã§ã®å­¦ã³ãƒã‚¤ãƒ³ãƒˆâœ¨

* **ä¸­å¤®ã®å¸ä»¤å¡”ã¯ã„ãªã„**
* å„ã‚µãƒ¼ãƒ“ã‚¹ã¯ **subscribe** ã—ã¦ã€å‡¦ç†ã—ãŸã‚‰ **publish** ã™ã‚‹ã ã‘ğŸ“£ğŸ”

---

# ç« æœ«ãƒŸãƒ‹æ¼”ç¿’ğŸ“ğŸ’•ï¼ˆæ‰‹ã‚’å‹•ã‹ã™ç³»ï¼ï¼‰

## æ¼”ç¿’Aï¼šã‚¤ãƒ™ãƒ³ãƒˆè¨­è¨ˆï¼ˆå‘½åã¨è²¬å‹™ï¼‰ğŸ·ï¸ğŸ§ 

æ¬¡ã®æ³¨æ–‡ãƒ•ãƒ­ãƒ¼ã§ã€ã‚¤ãƒ™ãƒ³ãƒˆã‚’ **7å€‹** ä½œã£ã¦ã¿ã‚ˆã†ğŸ˜Š

* æ³¨æ–‡ä½œæˆ
* æ±ºæ¸ˆ
* åœ¨åº«ç¢ºä¿
* ç™ºé€é–‹å§‹
* ã©ã“ã‹ã§å¤±æ•—ã—ãŸå ´åˆã®å¤±æ•—ã‚¤ãƒ™ãƒ³ãƒˆ
* è£œå„Ÿã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆè¿”é‡‘/åœ¨åº«æˆ»ã— ãªã©ï¼‰

ãƒã‚§ãƒƒã‚¯âœ…

* ã‚¤ãƒ™ãƒ³ãƒˆåã¯ã€Œèµ·ããŸäº‹å®Ÿã€ã«ãªã£ã¦ã‚‹ï¼Ÿï¼ˆå‘½ä»¤ã«ãªã£ã¦ãªã„ï¼Ÿï¼‰
* æœ¬æ–‡ã¯æœ€å°é™ï¼Ÿï¼ˆã‚­ãƒ¼ä¸­å¿ƒã«ãªã£ã¦ã‚‹ï¼Ÿï¼‰
* `sagaId` ã¨ `correlationId` ã‚’å…¥ã‚ŒãŸï¼ŸğŸ§µ

---

## æ¼”ç¿’Bï¼šå¤±æ•—æ™‚ã®â€œæˆ»ã‚Šæ–¹â€ã‚’æãğŸ§¯ğŸ”

ã€Œåœ¨åº«ç¢ºä¿ã«å¤±æ•—ã€ã—ãŸã¨ãğŸ‘‡

* ã©ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒã€ã©ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡ºã™ï¼Ÿ
* ã©ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒã€ä½•ã‚’è£œå„Ÿã™ã‚‹ï¼Ÿ
* è£œå„ŸãŒçµ‚ã‚ã£ãŸåˆå›³ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆï¼‰ã¯ä½•ï¼ŸğŸ“£

---

# ã¾ã¨ã‚ğŸŒŸ

* Choreographyã¯ **ã‚¤ãƒ™ãƒ³ãƒˆã®é€£é–ã§Sagaã‚’é€²ã‚ã‚‹**ã‚¹ã‚¿ã‚¤ãƒ«ğŸ•ºğŸ”—
* ã†ã¾ãã„ãéµã¯ã€**ã‚¤ãƒ™ãƒ³ãƒˆè¨­è¨ˆï¼ˆå‘½åãƒ»è²¬å‹™ãƒ»å°ç­’ï¼‰**ğŸ“®âœ¨
* äº‹æ•…ã‚Šãƒã‚¤ãƒ³ãƒˆã¯ã€Œå¢—æ®–ã€ã€Œè²¬å‹™å´©å£Šã€ã€Œè¿½ãˆãªã„ã€ã€ŒäºŒé‡å‡¦ç†ã€ğŸ˜µâ€ğŸ’«ğŸ‘»
* `sagaId / correlationId / eventId` ã‚’æœ€åˆã‹ã‚‰å…¥ã‚Œã¦ãŠãã¨æœªæ¥ã®è‡ªåˆ†ãŒåŠ©ã‹ã‚‹ã‚ˆğŸ¥¹ğŸ«¶

[1]: https://temporal.io/blog/to-choreograph-or-orchestrate-your-saga-that-is-the-question?utm_source=chatgpt.com "Saga Orchestration vs Choreography"
[2]: https://www.cncf.io/announcements/2024/01/25/cloud-native-computing-foundation-announces-the-graduation-of-cloudevents/?utm_source=chatgpt.com "Cloud Native Computing Foundation Announces the ..."
[3]: https://www.asyncapi.com/docs/reference/specification/v3.0.0?utm_source=chatgpt.com "3.0.0 | AsyncAPI Initiative for event-driven APIs"
[4]: https://docs.nats.io/using-nats/developer/develop_jetstream/model_deep_dive?utm_source=chatgpt.com "JetStream Model Deep Dive - NATS Docs"
