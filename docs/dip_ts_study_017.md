# ç¬¬17ç« ï¼šãƒ†ã‚¹ãƒˆãŒç°¡å˜ã«ãªã‚‹ï¼Fake/Stubã§ä½“é¨“ğŸ§ªğŸ§¸âœ¨

## ã“ã®ç« ã§ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã“ã¨ğŸ¯

* ã€ŒDIPã™ã‚‹ã¨ãƒ†ã‚¹ãƒˆãŒãƒ©ã‚¯ã«ãªã‚‹ç†ç”±ã€ã‚’ä½“æ„Ÿã§ãã‚‹ğŸ’¡
* Fake / Stub ã‚’ä½œã£ã¦ã€**â€œæœ¬ç‰©ãªã—â€**ã§ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚’ãƒ†ã‚¹ãƒˆã§ãã‚‹ğŸ§¸âœ¨
* ãƒ†ã‚¹ãƒˆã®ç›®çš„ãŒã€Œãƒã‚°æ¢ã—ã€ã˜ã‚ƒãªãã¦ **â€œä»•æ§˜ã‚’å®ˆã‚‹å¥‘ç´„æ›¸â€**ã ã¨ã‚ã‹ã‚‹ğŸ“ŒğŸ“

---

## 1) ã¾ãšçµè«–ï¼šDIPã¯ã€Œãƒ†ã‚¹ãƒˆã—ã‚„ã™ã•ã€ã‚’çˆ†ä¸Šã’ã™ã‚‹ğŸ’ªğŸ§ª

DIPãŒåŠ¹ãã¨ã€ä¸Šä½ï¼ˆæ¥­å‹™ãƒ­ã‚¸ãƒƒã‚¯ï¼‰ãŒ **DB / HTTP / æ™‚é–“ / ãƒ•ã‚¡ã‚¤ãƒ«**ã¿ãŸã„ãªâ€œä¸‹ä½ã®äº‹æƒ…â€ã«æŒ¯ã‚Šå›ã•ã‚Œãªããªã‚‹ã‚ˆã­ğŸŒªï¸
ã™ã‚‹ã¨ãƒ†ã‚¹ãƒˆã§â€¦

* DBã‚’ç«‹ã¦ãªãã¦ã„ã„ğŸ™…â€â™€ï¸ğŸ—„ï¸
* å¤–éƒ¨APIã‚’å©ã‹ãªãã¦ã„ã„ğŸ™…â€â™€ï¸ğŸŒ
* ç¾åœ¨æ™‚åˆ»ã«å·¦å³ã•ã‚Œãªã„ğŸ™…â€â™€ï¸â°

ã¤ã¾ã‚Šã€**é€Ÿã„ãƒ»å®‰å®šãƒ»æ€–ããªã„**ãƒ†ã‚¹ãƒˆã«ãªã‚‹ğŸ‰

---

## 2) Fake / Stub / Mock ã‚’ã‚†ã‚‹ãç†è§£ã—ã‚ˆã†ğŸ§¸ğŸ§ª

ã“ã“ã€æœ€åˆã¯ã–ã£ãã‚Šã§OKã€œï¼ğŸ˜Š

* **Stubï¼ˆã‚¹ã‚¿ãƒ–ï¼‰**ï¼šæ±ºã¾ã£ãŸè¿”äº‹ã‚’è¿”ã™ã ã‘ã®å­ğŸ“¨

  * ä¾‹ï¼šæ”¯æ‰•ã„å‡¦ç†ã¯å¸¸ã«ã€ŒæˆåŠŸã€ã‚’è¿”ã™ã€ã¨ã‹ğŸ‘
* **Fakeï¼ˆãƒ•ã‚§ã‚¤ã‚¯ï¼‰**ï¼šå‹•ãã‘ã©ç°¡æ˜“ç‰ˆã®â€œä»£ç”¨å“â€ğŸ§¸

  * ä¾‹ï¼šDBã®ä»£ã‚ã‚Šã«ã€ãƒ¡ãƒ¢ãƒªé…åˆ—ã«ä¿å­˜ã™ã‚‹RepositoryğŸ“¦
* **Mockï¼ˆãƒ¢ãƒƒã‚¯ï¼‰**ï¼šå‘¼ã³å‡ºã—å›æ•°ã‚„å¼•æ•°ã‚’â€œç›£è¦–â€ã™ã‚‹å­ğŸ‘€

  * ä¾‹ï¼šé€šçŸ¥ãŒ1å›é€ã‚‰ã‚ŒãŸã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€ã¨ã‹ğŸ””

ã“ã®ç« ã¯ **Fake ã¨ Stub** ã‚’ä¸­å¿ƒã«ã€Œã†ã‚ã€ãƒ†ã‚¹ãƒˆç°¡å˜ï¼ã€ã‚’ä½“é¨“ã™ã‚‹ã‚ˆâœ¨

---

## 3) ä¾‹é¡Œï¼šæ³¨æ–‡ç¢ºå®šãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚’â€œæœ¬ç‰©ãªã—â€ã§ãƒ†ã‚¹ãƒˆã™ã‚‹ğŸ“¦âœ…

## ã‚„ã‚ŠãŸã„ä»•æ§˜ï¼ˆã“ã‚ŒãŒãƒ†ã‚¹ãƒˆã§å®ˆã‚‹å¯¾è±¡ï¼‰ğŸ“Œ

**PlaceOrderï¼ˆæ³¨æ–‡ç¢ºå®šï¼‰**ã®ä»•æ§˜ã‚’ã€ãƒ†ã‚¹ãƒˆã§å®ˆã‚‹ã‚ˆï¼

* æ”¯æ‰•ã„ãŒæˆåŠŸã—ãŸã‚‰ âœ…

  * æ³¨æ–‡ãŒä¿å­˜ã•ã‚Œã‚‹ï¼ˆRepositoryã«ä¿å­˜ï¼‰ğŸ’¾
  * `CONFIRMED` ã«ãªã‚‹ğŸ‰
* æ”¯æ‰•ã„ãŒå¤±æ•—ã—ãŸã‚‰ âŒ

  * æ³¨æ–‡ã¯ä¿å­˜ã•ã‚Œãªã„ğŸ™…â€â™€ï¸ğŸ’¾

---

## 4) ã¾ãšã¯ã€ŒæŠ½è±¡ï¼ˆãƒãƒ¼ãƒˆï¼‰ã€ã‚’ç”¨æ„ã™ã‚‹ğŸ§©ğŸšª

ä¸Šä½ï¼ˆãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ï¼‰ãŒé ¼ã‚‹å…ˆã¯ â€œinterfaceâ€ ã«ã™ã‚‹ã‚ˆã€œâœ¨

```ts
// src/ports/PaymentGateway.ts
export interface PaymentGateway {
  charge(amountYen: number): Promise<{ ok: true } | { ok: false; reason: string }>;
}

// src/ports/OrderRepository.ts
export interface OrderRepository {
  save(order: Order): Promise<void>;
  findById(id: string): Promise<Order | null>;
}

// src/ports/Clock.ts
export interface Clock {
  nowIso(): string; // ä¾‹: "2026-01-15T12:00:00.000Z"
}

// src/domain/Order.ts
export type OrderStatus = "PENDING" | "CONFIRMED";

export type Order = {
  id: string;
  amountYen: number;
  status: OrderStatus;
  createdAtIso: string;
};
```

---

## 5) ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ï¼ˆä¸Šä½ï¼‰ã¯â€œæŠ½è±¡ã ã‘â€ã‚’è¦‹ã‚‹ğŸ‘‘âœ¨

ã“ã“ãŒDIPã®ä¸»å½¹ã ã‚ˆã€œï¼
DBã‚‚APIã‚‚æ™‚åˆ»ã‚‚ã€**çŸ¥ã‚‰ãªã„**ï¼ˆï¼ä¾å­˜ã—ã¦ãªã„ï¼‰ğŸ’ª

```ts
// src/app/PlaceOrder.ts
import type { PaymentGateway } from "../ports/PaymentGateway";
import type { OrderRepository } from "../ports/OrderRepository";
import type { Clock } from "../ports/Clock";
import type { Order } from "../domain/Order";

export class PlaceOrder {
  constructor(
    private readonly payment: PaymentGateway,
    private readonly orders: OrderRepository,
    private readonly clock: Clock
  ) {}

  async execute(input: { id: string; amountYen: number }): Promise<Order> {
    const createdAtIso = this.clock.nowIso();

    const order: Order = {
      id: input.id,
      amountYen: input.amountYen,
      status: "PENDING",
      createdAtIso,
    };

    const result = await this.payment.charge(order.amountYen);

    if (!result.ok) {
      // ä»•æ§˜ï¼šå¤±æ•—æ™‚ã¯ä¿å­˜ã—ãªã„
      throw new Error(`PAYMENT_FAILED: ${result.reason}`);
    }

    const confirmed: Order = { ...order, status: "CONFIRMED" };

    await this.orders.save(confirmed);
    return confirmed;
  }
}
```

---

## 6) ãƒ†ã‚¹ãƒˆç”¨ã® Stub / Fake ã‚’ä½œã‚‹ğŸ§¸ğŸ§ªâœ¨

![](./picture/dip_ts_study_017_test_robot.png)


## Stubï¼šæ”¯æ‰•ã„ã‚’â€œæˆåŠŸ/å¤±æ•—â€ã•ã›ãŸã„ã ã‘ğŸ™‚/ğŸ˜¢

```mermaid
classDiagram
    class PaymentGateway {
        <<interface>>
        +charge()
    }
    class StripePaymentGateway {
        +charge()
    }
    class StubPaymentSuccess {
        +charge() "å¸¸ã«OK"
    }
    class StubPaymentFailure {
        +charge() "å¸¸ã«NG"
    }

    StripePaymentGateway ..|> PaymentGateway : æœ¬ç•ªç”¨è©³ç´°
    StubPaymentSuccess ..|> PaymentGateway : ãƒ†ã‚¹ãƒˆç”¨ (Stub)
    StubPaymentFailure ..|> PaymentGateway : ãƒ†ã‚¹ãƒˆç”¨ (Stub)

    note for PaymentGateway "ä¸Šä½ã¯ã“ã‚Œã—ã‹çŸ¥ã‚‰ãªã„ã‹ã‚‰\nStubã«å·®ã—æ›¿ãˆã¦ã‚‚æ°—ã¥ã‹ãªã„ğŸ™ˆ"
```

```ts
// test_doubles/StubPaymentGateway.ts

import type { PaymentGateway } from "../src/ports/PaymentGateway";

export class StubPaymentGatewaySuccess implements PaymentGateway {
  async charge(_: numberYen: number) {
    return { ok: true } as const;
  }
}

export class StubPaymentGatewayFail implements PaymentGateway {
  constructor(private readonly reason = "card_declined") {}
  async charge(_: numberYen: number) {
    return { ok: false, reason: this.reason } as const;
  }
}
```

## Fakeï¼šRepositoryã‚’â€œãƒ¡ãƒ¢ãƒªã§å‹•ãç°¡æ˜“DBâ€ã«ã™ã‚‹ğŸ“¦ğŸ’¾

```ts
// test_doubles/FakeOrderRepository.ts
import type { OrderRepository } from "../src/ports/OrderRepository";
import type { Order } from "../src/domain/Order";

export class FakeOrderRepository implements OrderRepository {
  private store = new Map<string, Order>();

  async save(order: Order): Promise<void> {
    this.store.set(order.id, order);
  }

  async findById(id: string): Promise<Order | null> {
    return this.store.get(id) ?? null;
  }

  // ãƒ†ã‚¹ãƒˆã§ä¾¿åˆ©ãªâ€œã®ããè¦‹â€ğŸ«£âœ¨
  count(): number {
    return this.store.size;
  }
}
```

## FixedClockï¼šæ™‚åˆ»ã‚’å›ºå®šã—ã¦ãƒ†ã‚¹ãƒˆã‚’å®‰å®šã•ã›ã‚‹â°ğŸ§Š

```ts
// test_doubles/FixedClock.ts
import type { Clock } from "../src/ports/Clock";

export class FixedClock implements Clock {
  constructor(private readonly fixedIso: string) {}
  nowIso(): string {
    return this.fixedIso;
  }
}
```

---

## 7) Vitestã§ãƒ†ã‚¹ãƒˆã‚’æ›¸ãï¼ˆå‹•ãä½“é¨“ãƒ‘ãƒ¼ãƒˆï¼‰ğŸ§ªâš¡

ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼ã¯ **Vitest v4ç³»**ãŒã‚µã‚¯ã‚µã‚¯ã§æ‰±ã„ã‚„ã™ã„ã‚ˆâš¡ï¼ˆv4.0.x ãŒå…¬é–‹ã•ã‚Œã¦ã‚‹ï¼‰([Vitest][1])
ï¼ˆã‚‚ã¡ã‚ã‚“ Jest 30 ã‚‚ç¾å½¹ã ã‚ˆã€œï¼‰([Jest][2])

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆä¾‹ï¼‰

```sh
npm i -D vitest
```

`package.json` ã®ä¾‹ï¼š

```json
{
  "type": "module",
  "scripts": {
    "test": "vitest"
  },
  "devDependencies": {
    "vitest": "^4.0.0"
  }
}
```

---

## 8) ãƒ†ã‚¹ãƒˆæœ¬ä½“ï¼šæœ¬ç‰©ã‚¼ãƒ­ã§ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚’æ¤œè¨¼ã™ã‚‹ğŸ‰ğŸ§¸

```ts
// tests/PlaceOrder.test.ts
import { describe, it, expect } from "vitest";
import { PlaceOrder } from "../src/app/PlaceOrder";

import { StubPaymentGatewaySuccess, StubPaymentGatewayFail } from "../test_doubles/StubPaymentGateway";
import { FakeOrderRepository } from "../test_doubles/FakeOrderRepository";
import { FixedClock } from "../test_doubles/FixedClock";

describe("PlaceOrder", () => {
  it("æ”¯æ‰•ã„æˆåŠŸãªã‚‰ã€æ³¨æ–‡ãŒä¿å­˜ã•ã‚Œã¦CONFIRMEDã«ãªã‚‹âœ…", async () => {
    const payment = new StubPaymentGatewaySuccess();
    const repo = new FakeOrderRepository();
    const clock = new FixedClock("2026-01-15T00:00:00.000Z");

    const usecase = new PlaceOrder(payment, repo, clock);

    const result = await usecase.execute({ id: "order-1", amountYen: 1200 });

    expect(result.status).toBe("CONFIRMED");
    expect(result.createdAtIso).toBe("2026-01-15T00:00:00.000Z");

    const saved = await repo.findById("order-1");
    expect(saved?.status).toBe("CONFIRMED");
    expect(repo.count()).toBe(1);
  });

  it("æ”¯æ‰•ã„å¤±æ•—ãªã‚‰ã€ä¿å­˜ã•ã‚Œãªã„ï¼†ä¾‹å¤–ã«ãªã‚‹âŒ", async () => {
    const payment = new StubPaymentGatewayFail("network_error");
    const repo = new FakeOrderRepository();
    const clock = new FixedClock("2026-01-15T00:00:00.000Z");

    const usecase = new PlaceOrder(payment, repo, clock);

    await expect(usecase.execute({ id: "order-2", amountYen: 500 }))
      .rejects.toThrow("PAYMENT_FAILED");

    expect(repo.count()).toBe(0);
  });
});
```

## ã“ã“ãŒæ°—æŒã¡ã„ã„ãƒã‚¤ãƒ³ãƒˆğŸ˜âœ¨

* DBã‚‚APIã‚‚ä¸è¦ï¼ãªã®ã«ä»•æ§˜ãŒå®ˆã‚Œã‚‹ğŸ§¸
* ãƒ†ã‚¹ãƒˆãŒé€Ÿã„ï¼ˆã ã‹ã‚‰å›ã›ã‚‹ï¼‰âš¡
* å¤±æ•—ã—ãŸã¨ãåŸå› ãŒã‚ã‹ã‚Šã‚„ã™ã„ğŸ”

ã“ã‚ŒãŒ **DIPã®ã”ã»ã†ã³**ã ã‚ˆã€œğŸğŸ’•

---

## 9) ã‚ã‚ŠãŒã¡ãªãƒŸã‚¹ã¨ã‚³ãƒ„ğŸ§ ğŸª„

* **ãƒ†ã‚¹ãƒˆã§æœ¬ç‰©ã‚’ä½¿ã„å§‹ã‚ã‚‹**ï¼ˆDB/HTTPç›´å©ãï¼‰â†’ é…ã„ãƒ»ä¸å®‰å®šã«ãªã‚ŠãŒã¡ğŸ˜µ
* **æ™‚é–“ã‚’å›ºå®šã—ãªã„** â†’ æ—¥ä»˜ã¾ãŸãã§è½ã¡ã‚‹ã€ç’°å¢ƒã§ã‚ºãƒ¬ã‚‹â°ğŸ’¥
* **ãƒ†ã‚¹ãƒˆãŒâ€œå®Ÿè£…â€ã«å¯„ã‚Šã™ãã‚‹** â†’ ä»•æ§˜ï¼ˆæœŸå¾…ã™ã‚‹æŒ¯ã‚‹èˆã„ï¼‰ã«å¯„ã›ã‚ˆã†ğŸ“Œâœ¨

---

## ç« æœ«ã¾ã¨ã‚ï¼ˆ3è¡Œï¼‰ğŸ§¾âœ¨

* DIPã§ä¸Šä½ã¯ã€ŒæŠ½è±¡ã€ã«ã ã‘ä¾å­˜ã™ã‚‹ğŸ§©
* ã ã‹ã‚‰ãƒ†ã‚¹ãƒˆã§ã¯ Fake/Stub ã«å·®ã—æ›¿ãˆã§ãã‚‹ğŸ§¸
* çµæœã€é€Ÿãã¦å®‰å®šã—ãŸâ€œä»•æ§˜ã‚’å®ˆã‚‹ãƒ†ã‚¹ãƒˆâ€ãŒä½œã‚Œã‚‹ğŸ§ªâœ…

---

## ãƒŸãƒ‹æ¼”ç¿’ï¼ˆ1ã€œ2å•ï¼‰âœï¸ğŸ˜Š

1. `PlaceOrder` ã«ã€ŒamountYen ãŒ 0 ä»¥ä¸‹ãªã‚‰ä¾‹å¤–ã€ã‚’è¿½åŠ ã—ã¦ã€ãƒ†ã‚¹ãƒˆã‚‚1æœ¬è¶³ã—ã¦ã¿ã¦ã­ğŸ’¥ğŸ§ª
2. `FakeOrderRepository` ã« `all()` ã‚’ä½œã£ã¦ã€Œä¿å­˜ã•ã‚ŒãŸæ³¨æ–‡ä¸€è¦§ã€ã‚’æ¤œè¨¼ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã¿ã‚ˆã†ğŸ“šâœ¨

---

## AIã«èãç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹ğŸ¤–ğŸ’¬ï¼ˆæ¯”è¼ƒã•ã›ã‚‹ç³»âœ¨ï¼‰

* ã€Œã“ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã®ãƒ†ã‚¹ãƒˆã§ã€Stub ã¨ Fake ã‚’ã©ã†åˆ†ã‘ã‚‹ã®ãŒè‡ªç„¶ï¼Ÿç†ç”±ã‚‚ã‚»ãƒƒãƒˆã§3ãƒ‘ã‚¿ãƒ¼ãƒ³å‡ºã—ã¦ã€ğŸ§ ğŸ§¸
* ã€Œã“ã®ãƒ†ã‚¹ãƒˆãŒâ€œå®Ÿè£…å¯„ã‚Šâ€ã«ãªã£ã¦ã‚‹éƒ¨åˆ†ã‚’æŒ‡æ‘˜ã—ã¦ã€â€œä»•æ§˜å¯„ã‚Šâ€ã«æ›¸ãæ›ãˆã‚‹æ¡ˆã‚’ææ¡ˆã—ã¦ã€ğŸ”ğŸ“Œ
* ã€ŒMock ã‚’ä½¿ã†ã¹ãå ´é¢ã«ã—ãŸã„ã€‚é€šçŸ¥ãƒãƒ¼ãƒˆã‚’è¿½åŠ ã—ã¦â€œå‘¼ã³å‡ºã—å›æ•°ã‚’æ¤œè¨¼ã™ã‚‹ãƒ†ã‚¹ãƒˆâ€ä¾‹ã‚’ä½œã£ã¦ã€ğŸ””ğŸ‘€

---

æ¬¡ã®ç¬¬18ç« ã§ã¯ã€Œã‚„ã‚Šã™ãæ³¨æ„âš ï¸ã€ã¸é€²ã‚“ã§ã€**ã©ã“ã¾ã§DIPã™ã‚‹ã®ãŒã¡ã‚‡ã†ã©ã„ã„ã‹**ã‚’èº«ã«ã¤ã‘ã‚‹ã‚ˆã€œğŸâš–ï¸ğŸ˜Š

[1]: https://vitest.dev/blog/vitest-4?utm_source=chatgpt.com "Vitest 4.0 is out!"
[2]: https://jestjs.io/versions?utm_source=chatgpt.com "Jest Versions"
