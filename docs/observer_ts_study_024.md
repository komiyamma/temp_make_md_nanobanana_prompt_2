# ç¬¬24ç« ï¼šSpanã®åˆ‡ã‚Šæ–¹ï¼ˆç´°ã‹ã™ã/ç²—ã™ãå•é¡Œï¼‰âœ‚ï¸ğŸ¤”ğŸ§µ

## 1) ã“ã®ç« ã®ã‚´ãƒ¼ãƒ« ğŸ¯âœ¨

* ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’è¦‹ãŸã¨ãã«ã€Œã©ã“ãŒé…ã„ï¼Ÿã€ã€Œã©ã“ã§å¤±æ•—ï¼Ÿã€ãŒ**ä¸€ç™ºã§è¿½ãˆã‚‹ç²’åº¦**ã§ Span ã‚’åˆ‡ã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹ğŸ˜ŠğŸ”
* é€†ã«ã€**ç´°ã‹ã™ãã¦åœ°ç„ï¼ˆSpanã ã‚‰ã‘ï¼‰**ï¼**ç²—ã™ãã¦ä½•ã‚‚åˆ†ã‹ã‚‰ã‚“ï¼ˆ1æœ¬ã ã‘ï¼‰**ã‚’å›é¿ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ğŸ˜‡ğŸ›¡ï¸

---

## 2) ã¾ãšã€Œç²’åº¦ã€ã£ã¦ãªã«ï¼ŸğŸ°ğŸ§

![ç”»åƒã‚’æŒ¿å…¥äºˆå®š](./picture/observer_ts_study_024_cutting_tape.png)

```mermaid
graph TD
    subgraph TooCoarse["Too Coarse â¬›"]
    Span1["POST /orders (total)"]
    end
    
    subgraph Optimal["Optimal âœ‚ï¸"]
    S1[validate] --> S2[reserve_inventory]
    S2 --> S3[charge_payment]
    S3 --> S4[save_order]
    end
    
    subgraph TooFine["Too Fine ğŸ§±"]
    F1[loop 0] --> F2[loop 1]
    F2 --> F3[loop 2]
    F3 --> F4[...]
    end
    
    style Optimal fill:#e8f5e9,stroke:#2e7d32
    style TooCoarse fill:#eeeeee,stroke:#9e9e9e
    style TooFine fill:#ffebee,stroke:#c62828
```

Span ã¯ã€Œã‚ã‚‹ä½œæ¥­ã®æ™‚é–“ã¨çµæœã€ã‚’è¡¨ã™â€œã—ãŠã‚Šâ€ã¿ãŸã„ãªã‚‚ã®ğŸ“ŒğŸ§µ
ç²’åº¦ï¼ãã®â€œã—ãŠã‚Šâ€ã‚’ **ã©ã®ãã‚‰ã„ç´°ã‹ãæŒŸã‚€ã‹** ã®è©±ã ã‚ˆã€œğŸ˜Šâœ¨

* **ç²—ã™ã**ï¼š`POST /orders` ã® Span 1æœ¬ã ã‘ â†’ ã€Œé…ã„ã®DBï¼Ÿå¤–éƒ¨APIï¼Ÿåœ¨åº«ï¼Ÿæ±ºæ¸ˆï¼Ÿã€ãŒä¸æ˜ğŸ˜µâ€ğŸ’«
* **ç´°ã‹ã™ã**ï¼šfor ãƒ«ãƒ¼ãƒ—1å›ã”ã¨ã« Span â†’ 1ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§æ•°ç™¾æœ¬ã€èª­ã‚€ã®ãŒã¤ã‚‰ã„ï¼†ã‚³ã‚¹ãƒˆã‚‚å¢—ãˆãŒã¡ğŸ˜±ğŸ’¸

---

## 3) è¿·ã£ãŸã‚‰ã‚³ãƒ¬ï¼Spanã‚’åˆ‡ã‚‹â€œç‹é“ãƒã‚¤ãƒ³ãƒˆâ€5ã¤ ğŸ§­âœ¨

### âœ… â‘  å¤–éƒ¨I/Oã¯åŸºæœ¬ã€Œåˆ‡ã‚‹ã€ğŸŒğŸ—„ï¸ğŸ“¨

DBã€å¤–éƒ¨HTTPã€Queueã€ãƒ•ã‚¡ã‚¤ãƒ«ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥â€¦
**ã‚¢ãƒ—ãƒªã®å¤–ã«å‡ºã‚‹ç¬é–“**ã¯ã€é…å»¶ãƒ»å¤±æ•—ãƒ»ãƒªãƒˆãƒ©ã‚¤ãŒèµ·ãã‚„ã™ã„ã®ã§ Span ãŒè¶…åŠ¹ãğŸ¥¹âœ¨

* HTTP ã® Span åã¯ **`{method} {target}`ï¼ˆä½ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£ãª targetï¼‰**ãŒæ¨å¥¨ã•ã‚Œã¦ã‚‹ã‚ˆï¼ˆä¾‹ï¼š`GET /users/{id}` ã¿ãŸã„ãªâ€œå‹â€ï¼‰([OpenTelemetry][1])
* DB ã‚‚ã€Œã‚¯ã‚¨ãƒªå…¨æ–‡ã€ã˜ã‚ƒãªãã€**è¦ç´„ã‚„æ“ä½œåï¼‹target**ã¿ãŸã„ãªä½ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£ãŒæ¨å¥¨ã ã‚ˆ([OpenTelemetry][2])

---

### âœ… â‘¡ â€œæ¥­å‹™ã®ç¯€ç›®â€ã§åˆ‡ã‚‹ ğŸ›’ğŸ’³ğŸ“¦

æŠ€è¡“ã˜ã‚ƒãªãã¦ã€**æ„å‘³ã®ã‚ã‚‹åŒºåˆ‡ã‚Š**ã§åˆ‡ã‚‹ã¨ã€Œèª­ã‚€äººã«å„ªã—ã„ã€ğŸ¥°

ä¾‹ï¼‰

* `validate order`
* `reserve inventory`
* `charge payment`
* `create shipment`

---

### âœ… â‘¢ ä½“æ„Ÿã§ã€Œé‡ãã†ãƒ»é…ãã†ã€ãªã¨ã“ã‚ã‚’åˆ‡ã‚‹ ğŸ¢â±ï¸

* è¨ˆç®—ãŒé‡ã„
* ãƒ«ãƒ¼ãƒ—ãŒå¤šã„
* ç”»åƒå‡¦ç†ã€PDFç”Ÿæˆã€ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¨ˆç®—â€¦ãªã©

â€œæ™‚é–“ãŒä¼¸ã³ãã†ãªå¡Šâ€ã« Span ã‚’ç½®ãã¨ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ç™ºè¦‹ãŒæ—©ã„ã‚ˆğŸ˜ŠğŸ”

---

### âœ… â‘£ â€œå¤±æ•—ã—ã‚„ã™ã„åˆ†å²â€ã§åˆ‡ã‚‹ ğŸš§ğŸ’¥

* ãƒªãƒˆãƒ©ã‚¤ãŒã‚ã‚‹
* ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒã‚ã‚‹
* ã‚¨ãƒ©ãƒ¼ç†ç”±ã‚’åˆ†ã‘ãŸã„

ã“ã†ã„ã†æ‰€ã¯ Span ãŒã‚ã‚‹ã¨ã€Œã©ã®åˆ†å²ã«è¡Œã£ãŸã‹ã€ãŒä¸€ç›®ã§åˆ†ã‹ã‚‹ğŸ¥¹âœ¨

---

### âœ… â‘¤ ä¸¦åˆ—å‡¦ç†ã¯ã€Œã¾ã¨ã‚æ–¹ã€ã‚’æ„è­˜ã™ã‚‹ ğŸ§µğŸ§·

Promise.all ã§ä¸¦åˆ—ã«æŠ•ã’ã‚‹ã¨ã€Spanã‚‚å¢—ãˆã‚„ã™ã„ğŸ˜µ

* ä¸¦åˆ—ã®â€œè¦ªâ€ã‚’ 1 æœ¬ï¼ˆä¾‹ï¼š`fetch related resources`ï¼‰
* å­ã¯ã€Œæœ¬å½“ã«å¿…è¦ãªå¤–éƒ¨I/Oã ã‘ã€ãªã©ã€å¢—ãˆã™ããªã„è¨­è¨ˆã«ã™ã‚‹ã®ãŒã‚³ãƒ„ğŸ˜Šâœ¨

---

## 4) â€œç´°ã‹ã™ã/ç²—ã™ãâ€ã‚ã‚‹ã‚ã‚‹é›† ğŸ˜±â¡ï¸ğŸ˜Š

### ğŸ˜± ç´°ã‹ã™ãï¼ˆèª­ã‚€ã®ãƒ ãƒªï¼‰

* `rollOnce:0`, `rollOnce:1` â€¦ã¿ãŸã„ã«ãƒ«ãƒ¼ãƒ—1å›ã”ã¨ã« Spanï¼ˆã‚µãƒ³ãƒ—ãƒ«ã¨ã—ã¦ã¯åˆ†ã‹ã‚Šã‚„ã™ã„ã‘ã©ã€å®Ÿé‹ç”¨ã¯æ³¨æ„ã­ï¼‰([OpenTelemetry][3])
  âœ… æ”¹å–„ï¼š
* ãƒ«ãƒ¼ãƒ—å…¨ä½“ã‚’ 1 Spanï¼ˆ`calculate score`ï¼‰
* ã©ã†ã—ã¦ã‚‚é€”ä¸­çµŒéãŒæ¬²ã—ã„ãªã‚‰ **Span event** ã‚’ä½¿ã†ï¼ˆâ€œã—ãŠã‚Šâ€ã˜ã‚ƒãªãâ€œä»˜ç®‹â€ï¼‰ğŸ“âœ¨

### ğŸ˜± ç²—ã™ãï¼ˆåŸå› ãŒæ¶ˆãˆã‚‹ï¼‰

* `handleRequest` ã ã‘
  âœ… æ”¹å–„ï¼š
* å¤–éƒ¨I/Oï¼ˆDB/å¤–éƒ¨HTTPï¼‰
* æ¥­å‹™ã®ç¯€ç›®ï¼ˆvalidate/charge/reserveï¼‰
  ã“ã®2ã¤ã ã‘ã§ã‚‚ä¸–ç•ŒãŒå¤‰ã‚ã‚‹ğŸ¥¹âœ¨

### ğŸ˜± Spanåã«IDå…¥ã‚ŒãŒã¡ï¼ˆåœ°å‘³ã«äº‹æ•…ï¼‰ğŸ†”ğŸ’¥

* `GET /users/123` ã¨ã‹ `order_98765` ã¨ã‹
  âœ… æ”¹å–„ï¼š
* åå‰ã¯ â€œå‹â€ ã«ã—ã¦ã€IDã¯å±æ€§ã¸ï¼ˆä¾‹ï¼š`enduser.id` ã¯æ‰±ã„ã«æ³¨æ„ã€ã¾ãšã¯ **è¼‰ã›ãªã„è¨­è¨ˆ**ãŒå®‰å…¨ï¼‰
  HTTP ã® span name ã‚‚ã€Œä½ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£ãª targetã€ãŒæ¨å¥¨ã ã‚ˆ([OpenTelemetry][1])

---

## 5) å®Ÿè£…ã®åŸºæœ¬å½¢ï¼ˆTSï¼‰ğŸ§‘â€ğŸ’»âœ¨

OpenTelemetry JS ã¯ **`startActiveSpan` ã‚’ä½¿ã†ã®ãŒåŸºæœ¬**ã§ã€Span ã‚’ context ã«ä¹—ã›ã¦ãã‚Œã‚‹ã‚ˆã€œğŸ˜Š
ãã—ã¦ **å¿…ãš `span.end()`**ï¼([OpenTelemetry][3])

```ts
import { trace, SpanStatusCode } from "@opentelemetry/api";

const tracer = trace.getTracer("app");

export async function createOrder() {
  return tracer.startActiveSpan("create order", async (span) => {
    try {
      // ã“ã“ã«å‡¦ç†ã‚’æ›¸ãï¼ˆå­Spanã¯ã“ã“ã§ä½œã‚‹ã¨è¦ªå­ãŒè‡ªç„¶ã«ã¤ãªãŒã‚‹ï¼‰
      span.setAttribute("app.feature", "checkout");

      // ...do work...

      span.setStatus({ code: SpanStatusCode.OK });
      return { ok: true };
    } catch (err) {
      span.recordException(err as Error);
      span.setStatus({ code: SpanStatusCode.ERROR });
      throw err;
    } finally {
      span.end();
    }
  });
}
```

---

## 6) ã‚±ãƒ¼ã‚¹ã‚¹ã‚¿ãƒ‡ã‚£ï¼šæ³¨æ–‡APIã‚’â€œæ°—æŒã¡ã„ã„ç²’åº¦â€ã§åˆ‡ã‚‹ ğŸ›’ğŸ’³ğŸ“¦âœ¨

### ğŸ§Ÿ æ‚ªã„ä¾‹ï¼ˆç²—ã™ãï¼‰

* `POST /orders`ï¼ˆ1æœ¬ã ã‘ï¼‰
  â†’ ã€Œé…ã„ã®ã©ã“ï¼Ÿã€ãŒåˆ†ã‹ã‚‰ãªã„ğŸ˜µâ€ğŸ’«

### ğŸ‘¼ è‰¯ã„ä¾‹ï¼ˆãŠã™ã™ã‚ã®æœ€å°ã‚»ãƒƒãƒˆï¼‰

* `POST /orders`ï¼ˆè‡ªå‹•è¨ˆæ¸¬ã®ã‚µãƒ¼ãƒSpanãŒã‚ã‚‹å‰æã€‚Nodeã¯è‡ªå‹•è¨ˆæ¸¬ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã® Span ã‚’ä½œã‚Œã‚‹ã‚ˆï¼‰([OpenTelemetry][4])

  * `validate order`
  * `reserve inventory`ï¼ˆå¤–éƒ¨I/Oãªã‚‰ã“ã“ã§åˆ‡ã‚‹ï¼‰
  * `charge payment`ï¼ˆå¤–éƒ¨HTTPï¼‰
  * `save order`ï¼ˆDBï¼‰

ã“ã‚“ãªæ„Ÿã˜ã®â€œæœ¨â€ğŸŒ³âœ¨

```text
POST /orders
 â”œâ”€ validate order
 â”œâ”€ reserve inventory
 â”œâ”€ charge payment
 â””â”€ save order
```

### ğŸ’¡ ãƒ«ãƒ¼ãƒ—ãŒã‚ã‚‹å ´åˆï¼ˆSpanã‚’å¢—ã‚„ã—ã™ããªã„ã‚³ãƒ„ï¼‰ğŸ”

ã€Œå•†å“ãŒ20å€‹ã€ã¿ãŸã„ãªã¨ãâ€¦

* ğŸ˜± æ‚ªã„ï¼š`reserve item 1`, `reserve item 2` â€¦ï¼ˆ20æœ¬ï¼‹Î±ï¼‰
* ğŸ˜Š è‰¯ã„ï¼š`reserve inventory` 1æœ¬ã«ã¾ã¨ã‚ã¦

  * `span.setAttribute("item.count", 20)`
  * é€”ä¸­çµŒéã¯ `span.addEvent("item reserved", { index: 3 })` ã¿ãŸã„ã«â€œä»˜ç®‹â€ã§æ®‹ã™ğŸ“âœ¨

---

## 7) è¿·å­é˜²æ­¢ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆã“ã‚Œã§æ¯å›åŒã˜è€ƒãˆæ–¹ï¼‰ğŸ“„âœ¨

Spanã‚’åˆ‡ã‚‹å‰ã«ã€ã¾ãšã“ã®3ã¤ã ã‘æ±ºã‚ã‚ˆğŸ˜ŠğŸ–Šï¸

1. **ãƒˆãƒƒãƒ—Spanï¼ˆå…¥å£ï¼‰**ï¼šã ã„ãŸã„è‡ªå‹•è¨ˆæ¸¬ã® `HTTP {method} {route}` ãŒã„ã‚‹å‰æã§OKï¼ˆãƒ«ãƒ¼ãƒˆã¯â€œå‹â€ãŒå¤§äº‹ï¼‰([OpenTelemetry][1])
2. **å¤–éƒ¨I/Oã®Span**ï¼šDB / å¤–éƒ¨HTTP / Queue
3. **æ¥­å‹™ã®ç¯€ç›®Span**ï¼švalidate / payment / inventory â€¦ã¿ãŸã„ãª â€œæ„å‘³ã®å¡Šâ€

---

## 8) ãƒŸãƒ‹æ¼”ç¿’ğŸ§ªâœ¨ï¼ˆ10åˆ†ï¼‰

æ¬¡ã®å‡¦ç†ã€Spanã‚’ã©ã†åˆ‡ã‚‹ï¼Ÿï¼ˆç­”ãˆã¯1ã¤ã˜ã‚ƒãªã„ã‚ˆğŸ˜Šï¼‰

* å…¥åŠ›ãƒã‚§ãƒƒã‚¯
* åœ¨åº«APIã¸å•ã„åˆã‚ã›ï¼ˆå¤–éƒ¨HTTPï¼‰
* ä¾¡æ ¼è¨ˆç®—ï¼ˆé‡ã‚ï¼‰
* DBã«ä¿å­˜
* ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆå¤–éƒ¨ï¼‰

âœ… ç›®æ¨™ï¼š**5æœ¬ä»¥å†…**ã«ã¾ã¨ã‚ã¦ã€èª­ã‚ã‚‹æœ¨ã«ã™ã‚‹ğŸŒ³âœ¨
ï¼ˆâ€œç´°ã‹ãã—ãŸã„æ¬²â€ãŒå‡ºãŸã‚‰ã€eventã§æˆ‘æ…¢ğŸ“ğŸ¥¹ï¼‰

---

## 9) AIï¼ˆCopilot/Codexï¼‰ã«æŠ•ã’ã‚‹ã¨å¼·ã„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹ ğŸ¤–âœ¨

* ã€Œã“ã®é–¢æ•°ã‚’ OpenTelemetry ã® `startActiveSpan` ã§åŒ…ã‚“ã§ã€‚Spanåã¯ä½ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£ã§ã€try/catch/finally ã§ `recordException` ã¨ `span.end()` ã¾ã§å…¥ã‚Œã¦ã€([OpenTelemetry][3])
* ã€Œã“ã®å‡¦ç†ãƒ•ãƒ­ãƒ¼ã‚’è¦‹ã¦ã€Spanå¢ƒç•Œã‚’ 5 å€‹ä»¥å†…ã«ææ¡ˆã—ã¦ã€‚å¤–éƒ¨I/Oã¨æ¥­å‹™ã®ç¯€ç›®ã‚’å„ªå…ˆã—ã¦ã€
* ã€ŒSpanåã«IDãŒæ··ã–ã£ã¦ãŸã‚‰ç›´ã—ã¦ã€‚IDã¯å±æ€§ã«ç§»ã—ã¦ï¼ˆãŸã ã—å€‹äººæƒ…å ±ã«ãªã‚Šãã†ãªã‚‰è¼‰ã›ãªã„æ¡ˆã‚‚å‡ºã—ã¦ï¼‰ã€

---

## 10) ã¾ã¨ã‚ ğŸ§µâœ¨

* Spanã¯ **å¤–éƒ¨I/O** ã¨ **æ¥­å‹™ã®ç¯€ç›®** ã‚’è»¸ã«åˆ‡ã‚‹ã¨ã€ã ã„ãŸã„å‹ã¦ã‚‹ğŸ˜ŠğŸ†
* **åå‰ã¯â€œå‹â€**ã€è©³ç´°ã¯ **å±æ€§ã‚„event** ã«é€ƒãŒã™ï¼ˆIDå…¥ã‚ŠSpanåã¯é¿ã‘ãŒã¡ï¼‰([OpenTelemetry][1])
* å®Ÿè£…ã¯ `startActiveSpan`ï¼‹`span.end()` ã®å‹ã‚’å®ˆã‚Œã°å®‰å…¨é‹è»¢ã§ãã‚‹ã‚ˆğŸš—ğŸ’¨([OpenTelemetry][3])

æ¬¡ã®ç« ï¼ˆç¬¬25ç« ï¼‰ã¯ã€Œãªã‚“ã§é€”ä¸­ã§ç¹‹ãŒã‚‰ãªããªã‚‹ã®ï¼Ÿã€ã®æ­£ä½“ï¼ˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä¼æ’­ã®â€œé€”åˆ‡ã‚Œâ€ï¼‰ã«å…¥ã£ã¦ã„ãã‚ˆã€œğŸ”—ğŸŒ¬ï¸ğŸ§ 

[1]: https://opentelemetry.io/docs/specs/semconv/http/http-spans/?utm_source=chatgpt.com "Semantic conventions for HTTP spans"
[2]: https://opentelemetry.io/docs/specs/semconv/database/database-spans/?utm_source=chatgpt.com "Semantic conventions for database client spans"
[3]: https://opentelemetry.io/docs/languages/js/instrumentation/ "Instrumentation | OpenTelemetry"
[4]: https://opentelemetry.io/docs/languages/js/getting-started/nodejs/ "Node.js | OpenTelemetry"
